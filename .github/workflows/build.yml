name: OpenWrtå…¨åŠŸèƒ½ç¼–è¯‘ç³»ç»Ÿï¼ˆæœ€ç»ˆç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      # 1. ç¼–è¯‘æ¨¡å¼é€‰æ‹©
      select_mode:
        type: choice
        description: ç¼–è¯‘æ¨¡å¼ï¼ˆè®¾å¤‡/èŠ¯ç‰‡ï¼‰
        required: true
        options: [device, chip]

      # 2. è®¾å¤‡é€‰æ‹©ï¼ˆä»…è®¾å¤‡æ¨¡å¼ï¼‰
      device:
        type: choice
        description: è®¾å¤‡å‹å·ï¼ˆä»…è®¾å¤‡æ¨¡å¼ï¼‰
        required: false
        options: [cudy-tr3000-256mb, redmi-ac2100, x86_64-generic, newifi-d2, mi-router-4a]

      # 3. èŠ¯ç‰‡é€‰æ‹©ï¼ˆä»…èŠ¯ç‰‡æ¨¡å¼ï¼‰
      chip:
        type: choice
        description: èŠ¯ç‰‡å‹å·ï¼ˆä»…èŠ¯ç‰‡æ¨¡å¼ï¼‰
        required: false
        options: [mt7981, mt7621, ipq8065, x86_64, rt3050, mt7986]

      # 4. æºç ç‰ˆæœ¬
      source_branch:
        type: choice
        description: æºç åˆ†æ”¯ï¼ˆå«å†…æ ¸ï¼‰
        required: true
        options: [openwrt-23.05, openwrt-master, immortalwrt-23.05, immortalwrt-master]

      # 5. ä¸»é¢˜+ç¼–è¯‘ä¼˜åŒ–ç»„åˆ
      theme_and_optimization:
        type: choice
        description: ä¸»é¢˜+ç¼–è¯‘ä¼˜åŒ–ç»„åˆ
        required: true
        options:
          - argon-O2-generic     # Argonä¸»é¢˜ + O2ä¼˜åŒ– + é€šç”¨æ¶æ„
          - argon-O3-armv8       # Argonä¸»é¢˜ + O3ä¼˜åŒ– + ARMv8
          - argon-O3-x86         # Argonä¸»é¢˜ + O3ä¼˜åŒ– + x86_64
          - bootstrap-O2-generic # å®˜æ–¹ä¸»é¢˜ + O2ä¼˜åŒ– + é€šç”¨æ¶æ„
          - material-Os-generic  # Materialä¸»é¢˜ + æœ€å°ä½“ç§¯ + é€šç”¨æ¶æ„

      # 6. æ ¸å¿ƒåŠŸèƒ½é…ç½®
      core_features:
        type: choice
        description: æ ¸å¿ƒåŠŸèƒ½ï¼ˆIPv6+ç¡¬ä»¶åŠ é€Ÿï¼‰
        required: true
        options: [ipv6+accel, ipv6-only, accel-only, none]

      # 7. è½¯ä»¶åŒ…ç®¡ç†
      packages:
        type: string
        description: è½¯ä»¶åŒ…ï¼ˆæ ¼å¼ï¼šåŒ…1,åŒ…2ï¼Œå¦‚"openclash,samba"ï¼‰
        required: false
        default: "openclash,samba,ddns-scripts"

      # 8. æ ¹åˆ†åŒºå¤§å°
      rootfs_size:
        type: number
        description: æ ¹åˆ†åŒºå¤§å°(MBï¼Œ32-2048)
        required: true
        default: 192

      # 9. å›ºä»¶æ ‡è¯†
      firmware_suffix:
        type: string
        description: å›ºä»¶åç¼€ï¼ˆå¦‚ç‰ˆæœ¬å·ï¼‰
        required: false
        default: "custom"

      # 10. é«˜çº§é€‰é¡¹
      run_custom_script:
        type: boolean
        description: æ‰§è¡Œè‡ªå®šä¹‰åˆå§‹åŒ–è„šæœ¬
        required: true
        default: true

  # å®šæ—¶åŒæ­¥è®¾å¤‡ä¿¡æ¯ï¼ˆæ¯å‘¨æ—¥0ç‚¹UTCï¼‰
  schedule:
    - cron: "0 0 * * 0"


jobs:
  # ä»»åŠ¡1ï¼šåŠ¨æ€åŒæ­¥è®¾å¤‡ä¸èŠ¯ç‰‡ä¿¡æ¯ï¼ˆå«è‡ªåŠ¨å€™é€‰æé†’ï¼‰
  sync-devices:
    name: åŠ¨æ€åŒæ­¥è®¾å¤‡ä¸èŠ¯ç‰‡ä¿¡æ¯
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…ä¾èµ–å·¥å…·
        run: |
          sudo apt update && sudo apt install -y git jq gh  # æ–°å¢ghç”¨äºåˆ›å»ºIssueæé†’

      - name: åŠ¨æ€ç”Ÿæˆå¹¶æ‰§è¡ŒåŒæ­¥è„šæœ¬
        run: |
          # åŠ¨æ€ç”ŸæˆåŒæ­¥è„šæœ¬ï¼ˆå«èŠ¯ç‰‡å€™é€‰æå–ï¼‰
          SYNC_SCRIPT=$(cat << 'EOF'
#!/bin/bash
# æœ€ç»ˆç‰ˆè®¾å¤‡åŒæ­¥è„šæœ¬ï¼šå«èŠ¯ç‰‡å€™é€‰æå–ä¸æé†’
OPENWRT_REPO="https://git.openwrt.org/openwrt/openwrt.git"
BACKUP_REPO="https://github.com/openwrt/openwrt.git"
BRANCH="openwrt-23.05"
TMP_DIR="./tmp-openwrt"
OUTPUT_FILE="device-drivers.json"
CANDIDATES_FILE="chip-candidates.txt"

# æ¸…ç†æ—§æ–‡ä»¶
rm -rf $TMP_DIR $CANDIDATES_FILE

# å…‹éš†æºç ï¼ˆæ”¯æŒå¤‡ç”¨ä»“åº“ï¼‰
clone_repo() {
  local repo=$1
  if git clone --depth 1 --branch "$BRANCH" "$repo" "$TMP_DIR"; then
    return 0
  fi
  return 1
}

echo "ğŸ” ä»å®˜æ–¹ä»“åº“åŒæ­¥è®¾å¤‡ä¿¡æ¯..."
if ! clone_repo "$OPENWRT_REPO"; then
  echo "âš ï¸ å®˜æ–¹ä»“åº“å…‹éš†å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨ä»“åº“..."
  if ! clone_repo "$BACKUP_REPO"; then
    echo "âš ï¸ æ‰€æœ‰ä»“åº“å…‹éš†å¤±è´¥ï¼Œä½¿ç”¨ç°æœ‰è®¾å¤‡é…ç½®ï¼ˆè‹¥æœ‰ï¼‰"
    [ -f "$OUTPUT_FILE" ] || { echo "âŒ æ— å¯ç”¨è®¾å¤‡é…ç½®"; exit 1; }
    exit 0
  fi
fi

cd "$TMP_DIR/target/linux" || { echo "âŒ æ‰¾ä¸åˆ°è®¾å¤‡é…ç½®ç›®å½•"; exit 1; }

# åˆå§‹åŒ–JSON
echo '{"devices": [], "chips": []}' > ../../"$OUTPUT_FILE"

# å¹³å°-èŠ¯ç‰‡æ˜ å°„è¡¨ï¼ˆäººå·¥ç»´æŠ¤éƒ¨åˆ†ï¼Œç¡®ä¿å‡†ç¡®æ€§ï¼‰
declare -A PLATFORM_CHIPS=(
  ["mediatek"]="mt7981 mt7621 mt7986 mt7620"
  ["ramips"]="mt7621 mt7620 rt3050 rt5350"
  ["ipq806x"]="ipq8065 ipq8064"
  ["x86"]="x86_64 i386"
  ["qualcommax"]="ipq6018 ipq807x"
  ["bcm53xx"]="bcm53573 bcm4709"
)

# æå–æ‰€æœ‰ç–‘ä¼¼èŠ¯ç‰‡å‹å·ï¼ˆç”¨äºè‡ªåŠ¨æé†’ï¼‰
extract_candidates() {
  echo "ğŸ” æå–ç–‘ä¼¼èŠ¯ç‰‡å‹å·..."
  # ä»æ–‡ä»¶åå’Œé©±åŠ¨ä¸­æå–å¯èƒ½çš„èŠ¯ç‰‡å‹å·ï¼ˆæ­£åˆ™åŒ¹é…å¸¸è§èŠ¯ç‰‡æ ¼å¼ï¼‰
  find . -name "*.mk" -o -name "*.dts" | \
    grep -oE "mt[0-9]{4,5}|ipq[0-9]{4,5}|rt[0-9]{3,5}|bcm[0-9]{4,6}|x86_64|i386" | \
    sort -u > ../../"$CANDIDATES_FILE"
  
  # è¿‡æ»¤å·²åœ¨æ˜ å°„è¡¨ä¸­çš„èŠ¯ç‰‡ï¼Œåªä¿ç•™æ–°å€™é€‰
  mapped_chips=$(echo "${PLATFORM_CHIPS[@]}" | tr ' ' '\n' | sort -u)
  new_candidates=$(comm -23 ../../"$CANDIDATES_FILE" <(echo "$mapped_chips"))
  echo "$new_candidates" > ../../"$CANDIDATES_FILE"
}

# éå†å¹³å°æå–è®¾å¤‡ä¿¡æ¯
for platform in "${!PLATFORM_CHIPS[@]}"; do
  [ -d "$platform" ] || continue
  echo "ğŸ“¦ å¤„ç†å¹³å°ï¼š$platformï¼ˆèŠ¯ç‰‡ï¼š${PLATFORM_CHIPS[$platform]}ï¼‰"
  
  # æå–è®¾å¤‡é…ç½®æ–‡ä»¶
  find "$platform" -name "*.mk" | while read -r file; do
    # æå–è®¾å¤‡åç§°
    device_name=$(grep "DEVICE_NAME" "$file" | cut -d'=' -f2 | tr -d '"' | sed 's/ //g')
    [ -z "$device_name" ] && continue  # è·³è¿‡æ— åç§°è®¾å¤‡
    
    # æå–é©±åŠ¨åŒ…
    default_pkgs=$(grep "DEFAULT_PACKAGES" "$file" | cut -d'=' -f2)
    drivers=$(echo "$default_pkgs" | grep -oE "kmod-[a-z0-9-]+" | sort -u | tr '\n' ' ')
    [ -z "$drivers" ] && continue  # è·³è¿‡æ— é©±åŠ¨è®¾å¤‡
    
    # æå–èŠ¯ç‰‡å‹å·ï¼ˆä¼˜å…ˆä»æ–‡ä»¶å+æ˜ å°„è¡¨åŒ¹é…ï¼‰
    chip=$(echo "$file ${PLATFORM_CHIPS[$platform]}" | grep -oE "mt7981|mt7621|ipq8065|x86_64|rt3050|mt7986" | head -n1)
    [ -z "$chip" ] && chip=$(echo "${PLATFORM_CHIPS[$platform]}" | cut -d' ' -f1)  # å…œåº•å–å¹³å°ä¸»èŠ¯ç‰‡
    
    # å†…æ ¸ç›®æ ‡è·¯å¾„
    kernel_target="$platform/generic"
    
    # å†™å…¥è®¾å¤‡ä¿¡æ¯
    echo "  - æ–°å¢è®¾å¤‡ï¼š$device_nameï¼ˆèŠ¯ç‰‡ï¼š$chipï¼‰"
    jq --arg name "$device_name" \
       --arg chip "$chip" \
       --arg target "$kernel_target" \
       --arg drivers "$drivers" \
       '.devices += [{"name": $name, "chip": $chip, "kernel_target": $target, "drivers": ($drivers | split(" ") | map(select(length > 0)))}]' \
       ../../"$OUTPUT_FILE" > ../../"$OUTPUT_FILE.tmp" && mv ../../"$OUTPUT_FILE.tmp" ../../"$OUTPUT_FILE"
  done
  
  # æå–èŠ¯ç‰‡é€šç”¨é©±åŠ¨
  chip=$(echo "${PLATFORM_CHIPS[$platform]}" | cut -d' ' -f1)
  [ -z "$chip" ] && continue
  chip_drivers=$(grep "DEFAULT_PACKAGES" "$platform/Makefile" 2>/dev/null | grep -oE "kmod-[a-z0-9-]+" | sort -u | tr '\n' ' ')
  if [ -n "$chip_drivers" ]; then
    echo "  - æ–°å¢èŠ¯ç‰‡é©±åŠ¨ï¼š$chip"
    jq --arg name "$chip" \
       --arg target "$platform/generic" \
       --arg drivers "$chip_drivers" \
       '.chips += [{"name": $name, "kernel_target": $target, "drivers": ($drivers | split(" ") | map(select(length > 0)))}]' \
       ../../"$OUTPUT_FILE" > ../../"$OUTPUT_FILE.tmp" && mv ../../"$OUTPUT_FILE.tmp" ../../"$OUTPUT_FILE"
  fi
done

# æå–ç–‘ä¼¼æ–°èŠ¯ç‰‡å¹¶ç”Ÿæˆæé†’
extract_candidates

# æ¸…ç†ä¸´æ—¶æ–‡ä»¶
cd ../../ && rm -rf "$TMP_DIR"
echo "âœ… è®¾å¤‡åŒæ­¥å®Œæˆï¼š$(jq '.devices | length' "$OUTPUT_FILE")ä¸ªè®¾å¤‡ï¼Œ$(jq '.chips | length' "$OUTPUT_FILE")ä¸ªèŠ¯ç‰‡"
EOF
          )

          # æ‰§è¡ŒåŠ¨æ€ç”Ÿæˆçš„è„šæœ¬
          echo "$SYNC_SCRIPT" > sync-tmp.sh
          chmod +x sync-tmp.sh
          ./sync-tmp.sh

      - name: æ–°èŠ¯ç‰‡å€™é€‰æé†’ï¼ˆè‡ªåŠ¨åˆ›å»ºIssueï¼‰
        run: |
          if [ -s "chip-candidates.txt" ]; then
            echo "âš ï¸ å‘ç°ä»¥ä¸‹æ–°çš„ç–‘ä¼¼èŠ¯ç‰‡ï¼Œå»ºè®®æ›´æ–°PLATFORM_CHIPSæ˜ å°„è¡¨ï¼š"
            cat chip-candidates.txt
            # è‡ªåŠ¨åˆ›å»ºGitHub Issueæé†’ï¼ˆéœ€æå‰é…ç½®GH_TOKENï¼‰
            if [ -n "$GITHUB_TOKEN" ]; then
              gh issue create --title "æ–°èŠ¯ç‰‡å€™é€‰å¾…ç¡®è®¤ï¼ˆ$(date +%Y%m%d)ï¼‰" \
                --body "æ£€æµ‹åˆ°æœªæ·»åŠ çš„ç–‘ä¼¼èŠ¯ç‰‡å‹å·ï¼Œè¯·æ›´æ–°PLATFORM_CHIPSæ˜ å°„è¡¨ï¼š\n$(cat chip-candidates.txt)"
            fi
          else
            echo "âœ… æ— æ–°èŠ¯ç‰‡å€™é€‰ï¼Œç°æœ‰æ˜ å°„è¡¨å·²è¦†ç›–æ‰€æœ‰å·²çŸ¥èŠ¯ç‰‡"
          fi

      - name: è‡ªåŠ¨æäº¤è®¾å¤‡é…ç½®æ›´æ–°
        run: |
          git config --global user.name "Auto-Sync Bot"
          git config --global user.email "bot@github.com"
          if git diff --quiet device-drivers.json; then
            echo "âš ï¸ æ— è®¾å¤‡ä¿¡æ¯æ›´æ–°"
          else
            git add device-drivers.json
            git commit -m "åŠ¨æ€åŒæ­¥è®¾å¤‡ä¿¡æ¯ï¼ˆ$(date +%Y%m%d)ï¼‰"
            git push
            echo "âœ… è®¾å¤‡ä¿¡æ¯å·²æ›´æ–°å¹¶æäº¤"
          fi


  # ä»»åŠ¡2ï¼šç¼–è¯‘å›ºä»¶ï¼ˆä¾èµ–è®¾å¤‡åŒæ­¥ç»“æœï¼‰
  build-firmware:
    name: ç¼–è¯‘OpenWrtå›ºä»¶
    needs: sync-devices
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
      packages: write

    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç ï¼ˆå«æœ€æ–°è®¾å¤‡ä¿¡æ¯ï¼‰
        uses: actions/checkout@v4

      - name: ç¯å¢ƒå‡†å¤‡ä¸ä¾èµ–å®‰è£…
        run: |
          sudo apt update
          sudo apt install -y build-essential libncurses5-dev libncursesw5-dev \
            zlib1g-dev gawk git gettext libssl-dev xsltproc wget unzip python3 jq

      - name: ç¼–è¯‘å‰å…³é”®è‡ªæ£€
        run: |
          # æ£€æŸ¥æ¨¡å¼ä¸é€‰æ‹©åŒ¹é…
          if [ "${{ github.event.inputs.select_mode }}" = "device" ] && [ -z "${{ github.event.inputs.device }}" ]; then
            echo "âŒ é”™è¯¯ï¼šè®¾å¤‡æ¨¡å¼ä¸‹å¿…é¡»é€‰æ‹©è®¾å¤‡å‹å·"
            exit 1
          fi
          if [ "${{ github.event.inputs.select_mode }}" = "chip" ] && [ -z "${{ github.event.inputs.chip }}" ]; then
            echo "âŒ é”™è¯¯ï¼šèŠ¯ç‰‡æ¨¡å¼ä¸‹å¿…é¡»é€‰æ‹©èŠ¯ç‰‡å‹å·"
            exit 1
          fi

          # æ£€æŸ¥è®¾å¤‡é…ç½®æ–‡ä»¶
          if [ ! -f "device-drivers.json" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°device-drivers.jsonï¼ˆåŒæ­¥å¤±è´¥ï¼‰"
            exit 1
          fi

          # æ£€æŸ¥è‡ªå®šä¹‰è„šæœ¬ï¼ˆè‹¥å¯ç”¨ï¼‰
          if [ "${{ github.event.inputs.run_custom_script }}" = "true" ] && [ ! -f "scripts/custom-init.sh" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°è‡ªå®šä¹‰è„šæœ¬ scripts/custom-init.sh"
            exit 1
          fi

          # æ£€æŸ¥åˆ†åŒºå¤§å°åˆç†æ€§
          if [ ${{ github.event.inputs.rootfs_size }} -lt 32 ] || [ ${{ github.event.inputs.rootfs_size }} -gt 2048 ]; then
            echo "âŒ é”™è¯¯ï¼šæ ¹åˆ†åŒºå¤§å°å¿…é¡»åœ¨32-2048MBä¹‹é—´"
            exit 1
          fi

      - name: è§£æå‚æ•°ï¼ˆä¸»é¢˜+ä¼˜åŒ–+åŠŸèƒ½ï¼‰
        run: |
          # 1. è§£æä¸»é¢˜å’Œç¼–è¯‘ä¼˜åŒ–
          theme_opt="${{ github.event.inputs.theme_and_optimization }}"
          THEME=$(echo "$theme_opt" | cut -d'-' -f1)
          COMPILER_OPT=$(echo "$theme_opt" | cut -d'-' -f2)
          ARCH=$(echo "$theme_opt" | cut -d'-' -f3)
          
          echo "THEME=$THEME" >> $GITHUB_ENV
          echo "CFLAGS=-$COMPILER_OPT" >> $GITHUB_ENV
          echo "ARCH_OPTIMIZATION=$ARCH" >> $GITHUB_ENV
          
          # è®¾ç½®ç¼–è¯‘çº¿ç¨‹ï¼ˆO3+ARMv8ç”¨å•çº¿ç¨‹é¿å…å†…å­˜ä¸è¶³ï¼‰
          if [ "$COMPILER_OPT" = "O3" ] && [ "$ARCH" = "armv8" ]; then
            echo "THREADS=1" >> $GITHUB_ENV
          else
            echo "THREADS=2" >> $GITHUB_ENV
          fi

          # 2. è§£ææ ¸å¿ƒåŠŸèƒ½ï¼ˆIPv6+ç¡¬ä»¶åŠ é€Ÿï¼‰
          case "${{ github.event.inputs.core_features }}" in
            "ipv6+accel")
              echo "ENABLE_IPV6=true" >> $GITHUB_ENV
              echo "ENABLE_ACCEL=true" >> $GITHUB_ENV
              ;;
            "ipv6-only")
              echo "ENABLE_IPV6=true" >> $GITHUB_ENV
              echo "ENABLE_ACCEL=false" >> $GITHUB_ENV
              ;;
            "accel-only")
              echo "ENABLE_IPV6=false" >> $GITHUB_ENV
              echo "ENABLE_ACCEL=true" >> $GITHUB_ENV
              ;;
            "none")
              echo "ENABLE_IPV6=false" >> $GITHUB_ENV
              echo "ENABLE_ACCEL=false" >> $GITHUB_ENV
              ;;
          esac

          # 3. è§£æè½¯ä»¶åŒ…ï¼ˆè‡ªåŠ¨è¡¥å…¨luci-app-å‰ç¼€ï¼‰
          packages="${{ github.event.inputs.packages }}"
          common_pkgs=$(echo "$packages" | tr ',' '\n' | grep -v 'luci-app-' | sed 's/^/luci-app-/g' | tr '\n' ' ')
          custom_pkgs=$(echo "$packages" | tr ',' '\n' | grep 'luci-app-' | tr '\n' ' ')
          echo "PACKAGES=$common_pkgs $custom_pkgs" >> $GITHUB_ENV

      - name: æ‹‰å–æºç ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
        run: |
          fetch_source() {
            local repo=$1
            local branch=$2
            local retries=3
            local count=0
            while [ $count -lt $retries ]; do
              if git clone --depth 1 --branch "$branch" "$repo" openwrt-src; then
                return 0
              fi
              echo "âš ï¸ æ‹‰å–æºç å¤±è´¥ï¼Œé‡è¯•ç¬¬ $((count+1)) æ¬¡..."
              count=$((count+1))
              rm -rf openwrt-src
              sleep 5
            done
            echo "âŒ æ‹‰å–æºç å¤±è´¥ï¼ˆå·²é‡è¯•3æ¬¡ï¼‰"
            exit 1
          }

          # é€‰æ‹©æºç åˆ†æ”¯
          case "${{ github.event.inputs.source_branch }}" in
            openwrt-23.05)
              fetch_source "https://git.openwrt.org/openwrt/openwrt.git" "openwrt-23.05"
              ;;
            openwrt-master)
              fetch_source "https://git.openwrt.org/openwrt/openwrt.git" "master"
              ;;
            immortalwrt-23.05)
              fetch_source "https://github.com/immortalwrt/immortalwrt.git" "openwrt-23.05"
              ;;
            immortalwrt-master)
              fetch_source "https://github.com/immortalwrt/immortalwrt.git" "master"
              ;;
          esac
          echo "SRC_DIR=$(pwd)/openwrt-src" >> $GITHUB_ENV

      - name: åˆå§‹åŒ–æºç ä¸ä¸»é¢˜æº
        run: |
          cd "${{ env.SRC_DIR }}"
          ./scripts/feeds update -a
          ./scripts/feeds install -a

          # æ·»åŠ ä¸»é¢˜æºï¼ˆæ ¹æ®é€‰æ‹©çš„ä¸»é¢˜ï¼‰
          if [ "${{ env.THEME }}" = "argon" ]; then
            echo 'src-git argon https://github.com/jerrykuku/luci-theme-argon.git' >> feeds.conf.default
          elif [ "${{ env.THEME }}" = "material" ]; then
            echo 'src-git material https://github.com/LuttyYang/luci-theme-material.git' >> feeds.conf.default
          fi

          # æ·»åŠ OpenClashæºï¼ˆéImmortalWrtåˆ†æ”¯ï¼‰
          if [[ "${{ env.PACKAGES }}" == *"luci-app-openclash"* && 
                ! "${{ github.event.inputs.source_branch }}" == *"immortalwrt"* ]]; then
            echo 'src-git openclash https://github.com/vernesong/OpenClash.git' >> feeds.conf.default
          fi

          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: æ‰§è¡Œè‡ªå®šä¹‰åˆå§‹åŒ–è„šæœ¬ï¼ˆå¸¦é”™è¯¯æ•è·ï¼‰
        if: ${{ github.event.inputs.run_custom_script == 'true' }}
        run: |
          cd "${{ env.SRC_DIR }}"
          if [ ! -f "../scripts/custom-init.sh" ]; then
            echo "âŒ é”™è¯¯ï¼šè‡ªå®šä¹‰è„šæœ¬ä¸å­˜åœ¨"
            exit 1
          fi
          chmod +x ../scripts/custom-init.sh
          echo "ğŸ”§ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬..."
          if ! ../scripts/custom-init.sh; then
            echo "âŒ è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼ˆæ£€æŸ¥è¯­æ³•ï¼‰"
            exit 1
          fi
          echo "âœ… è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œå®Œæˆ"

      - name: è§£æè®¾å¤‡/èŠ¯ç‰‡é…ç½®
        run: |
          if [ "${{ github.event.inputs.select_mode }}" = "device" ]; then
            info=$(jq --arg dev "${{ github.event.inputs.device }}" '.devices[] | select(.name == $dev)' device-drivers.json)
          else
            info=$(jq --arg c "${{ github.event.inputs.chip }}" '.chips[] | select(.name == $c)' device-drivers.json)
          fi
          # æ£€æŸ¥é…ç½®æ˜¯å¦å­˜åœ¨
          if [ -z "$info" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ° ${{ github.event.inputs.device || github.event.inputs.chip }} çš„é…ç½®ä¿¡æ¯"
            exit 1
          fi
          echo "KERNEL_TARGET=$(echo "$info" | jq -r '.kernel_target')" >> $GITHUB_ENV
          echo "DRIVERS=$(echo "$info" | jq -r '.drivers[]' | tr '\n' ' ')" >> $GITHUB_ENV

      - name: ç”Ÿæˆç¼–è¯‘é…ç½®ï¼ˆå«ä¸»é¢˜ä¸ä¼˜åŒ–ï¼‰
        run: |
          cd "${{ env.SRC_DIR }}"
          target=$(echo "${{ env.KERNEL_TARGET }}" | tr '/' '_')

          # 1. åŸºç¡€è®¾å¤‡é…ç½®
          echo "CONFIG_TARGET_$target=y" >> .config
          echo "CONFIG_TARGET_${target}_DEVICE_generic=y" >> .config
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=${{ github.event.inputs.rootfs_size }}" >> .config

          # 2. è®¾å¤‡é©±åŠ¨
          for driver in ${{ env.DRIVERS }}; do
            echo "CONFIG_PACKAGE_$driver=y" >> .config
          done

          # 3. æ ¸å¿ƒåŠŸèƒ½ï¼ˆIPv6+ç¡¬ä»¶åŠ é€Ÿï¼‰
          if [ "${{ env.ENABLE_IPV6 }}" = "true" ]; then
            echo "CONFIG_IPV6=y" >> .config
            echo "CONFIG_PACKAGE_ipv6helper=y" >> .config
          else
            echo "# CONFIG_IPV6 is not set" >> .config
          fi
          if [ "${{ env.ENABLE_ACCEL }}" = "true" ]; then
            echo "CONFIG_PACKAGE_kmod-nf-flow=y" >> .config
            # è”å‘ç§‘5Gå›ºä»¶ç‰¹æ®Šå¤„ç†
            if [[ "${{ env.KERNEL_TARGET }}" == "mediatek/filogic" ]]; then
              echo "CONFIG_PACKAGE_kmod-mt7981-firmware-5g=y" >> .config
            fi
          fi

          # 4. è½¯ä»¶åŒ…é…ç½®
          for pkg in ${{ env.PACKAGES }}; do
            echo "CONFIG_PACKAGE_$pkg=y" >> .config
          done

          # 5. ç¼–è¯‘ä¼˜åŒ–
          echo "CONFIG_CFLAGS=${{ env.CFLAGS }}" >> .config
          echo "CONFIG_CXXFLAGS=${{ env.CFLAGS }}" >> .config
          if [ "${{ env.ARCH_OPTIMIZATION }}" = "armv8-a" ]; then
            echo "CONFIG_TARGET_OPTIMIZATION=-march=armv8-a -mtune=cortex-a53" >> .config
          elif [ "${{ env.ARCH_OPTIMIZATION }}" = "x86_64" ]; then
            echo "CONFIG_TARGET_OPTIMIZATION=-march=x86-64 -mtune=generic" >> .config
          fi

          # 6. ä¸»é¢˜é…ç½®ï¼ˆå¯ç”¨æ‰€é€‰ä¸»é¢˜ï¼Œç¦ç”¨å…¶ä»–ä¸»é¢˜ï¼‰
          echo "CONFIG_PACKAGE_luci-theme-${{ env.THEME }}=y" >> .config
          if [ "${{ env.THEME }}" != "bootstrap" ]; then
            echo "# CONFIG_PACKAGE_luci-theme-bootstrap is not set" >> .config
          fi
          if [ "${{ env.THEME }}" != "argon" ]; then
            echo "# CONFIG_PACKAGE_luci-theme-argon is not set" >> .config
          fi
          if [ "${{ env.THEME }}" != "material" ]; then
            echo "# CONFIG_PACKAGE_luci-theme-material is not set" >> .config
          fi

          # 7. åŸºç¡€Webç•Œé¢
          echo "CONFIG_PACKAGE_luci=y" >> .config
          echo "CONFIG_PACKAGE_luci-ssl=y" >> .config

          make defconfig

      - name: å¼€å§‹ç¼–è¯‘å›ºä»¶
        run: |
          cd "${{ env.SRC_DIR }}"
          # æ˜¾ç¤ºç¼–è¯‘çº¿ç¨‹æ•°å’Œä¼˜åŒ–ç­‰çº§
          echo "ğŸ“Œ ç¼–è¯‘é…ç½®ï¼šçº¿ç¨‹æ•°=${{ env.THREADS }}ï¼Œä¼˜åŒ–ç­‰çº§=${{ env.CFLAGS }}"
          make -j${{ env.THREADS }} V=s 2>&1 | tee compile.log

      - name: ç¼–è¯‘é”™è¯¯åˆ†æä¸å¤„ç†
        if: failure()
        run: |
          cd "${{ env.SRC_DIR }}"
          echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œé”™è¯¯åˆ†æï¼š"
          
          if grep -q "Killed signal terminated program cc1" compile.log; then
            echo "â†’ åŸå› ï¼šå†…å­˜ä¸è¶³ï¼ˆOut of memoryï¼‰"
            echo "â†’ è§£å†³æ–¹æ¡ˆï¼š1. åˆ‡æ¢ä¸ºO2ä¼˜åŒ–ï¼›2. å‡å°‘è½¯ä»¶åŒ…æ•°é‡ï¼›3. é¿å…åŒæ—¶å‹¾é€‰å¤šä¸ªå¤§å‹å·¥å…·"
          elif grep -q "Package kmod-.* is missing" compile.log; then
            missing_pkg=$(grep "Package kmod-.* is missing" compile.log | head -n1 | awk '{print $2}')
            echo "â†’ åŸå› ï¼šé©±åŠ¨åŒ… $missing_pkg ä¸å­˜åœ¨æˆ–ä¸å…¼å®¹å½“å‰åˆ†æ”¯"
            echo "â†’ è§£å†³æ–¹æ¡ˆï¼š1. å°è¯•åˆ‡æ¢åˆ°immortalwrt-masteråˆ†æ”¯ï¼›2. æ›´æ–°device-drivers.json"
          elif grep -q "configuration error: recursive dependency" compile.log; then
            echo "â†’ åŸå› ï¼šè½¯ä»¶åŒ…ä¾èµ–å†²çªï¼ˆå¦‚å¤šä¸ªVPNå·¥å…·ã€é‡å¤åŠŸèƒ½çš„åŒ…ï¼‰"
            echo "â†’ è§£å†³æ–¹æ¡ˆï¼š1. å‡å°‘è½¯ä»¶åŒ…æ•°é‡ï¼›2. ç§»é™¤å†²çªçš„åŒ…ï¼ˆå¦‚åŒæ—¶å®‰è£…openclashå’Œpasswallï¼‰"
          elif grep -q "No such file or directory" compile.log; then
            missing_file=$(grep "No such file or directory" compile.log | head -n1 | awk '{print $9}')
            echo "â†’ åŸå› ï¼šç¼ºå°‘æ–‡ä»¶ $missing_fileï¼ˆå¯èƒ½æ˜¯æºç æœªåŒæ­¥å®Œæ•´ï¼‰"
            echo "â†’ è§£å†³æ–¹æ¡ˆï¼š1. é‡æ–°è¿è¡Œå·¥ä½œæµï¼›2. æ£€æŸ¥æºç åˆ†æ”¯æ˜¯å¦æ­£ç¡®"
          else
            echo "â†’ æœªçŸ¥é”™è¯¯ï¼Œæœ€å50è¡Œæ—¥å¿—ï¼š"
            tail -n 50 compile.log
          fi
          exit 1

      - name: å›ºä»¶ä¿¡æ¯ä¸é‡å‘½å
        run: |
          base_name="${{ github.event.inputs.device || github.event.inputs.chip }}-${{ github.event.inputs.source_branch }}-${{ env.THEME }}"
          firmware_name="${base_name}-$(date +%Y%m%d)-${{ github.event.inputs.firmware_suffix }}"
          # é‡å‘½åæ‰€æœ‰å›ºä»¶
          find "${{ env.SRC_DIR }}/bin/targets/" -name "*.bin" -exec sh -c '
            for file do
              mv "$file" "${file%.bin}-$1.bin"
            done
          ' _ "$firmware_name" \;
          
          # è¾“å‡ºå›ºä»¶ç±»å‹è¯´æ˜
          echo "ğŸ“Œ å›ºä»¶ç±»å‹è¯´æ˜ï¼š"
          echo "  - å«'sysupgrade'ï¼šç”¨äºè®¾å¤‡å‡çº§ï¼ˆä¿ç•™ç°æœ‰é…ç½®ï¼‰"
          echo "  - å«'factory'ï¼šç”¨äºé¦–æ¬¡åˆ·å†™ï¼ˆæ¸…ç©ºæ‰€æœ‰é…ç½®ï¼‰"
          # åˆ—å‡ºæ‰€æœ‰ç”Ÿæˆçš„å›ºä»¶
          find "${{ env.SRC_DIR }}/bin/targets/" -name "*.bin" | grep -E "sysupgrade|factory" | while read -r file; do
            echo "  - $fileï¼ˆå¤§å°ï¼š$(du -h "$file" | awk '{print $1}')ï¼‰"
          done

      - name: ä¸Šä¼ ç¼–è¯‘æˆæœ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: "${{ github.event.inputs.device || github.event.inputs.chip }}-firmware-${{ github.run_id }}"
          path: |
            ${{ env.SRC_DIR }}/bin/targets/**/*.bin
            ${{ env.SRC_DIR }}/compile.log
          retention-days: 30
          if-no-files-found: error
      
      - name: æ‹‰å–æºç ï¼ˆå¸¦é‡è¯•ï¼‰
        run: |
          # å®šä¹‰æ‹‰å–å‡½æ•°ï¼ˆæœ€å¤šé‡è¯•3æ¬¡ï¼‰
          fetch_source() {
            local repo=$1
            local branch=$2
            local retries=3
            local count=0
            while [ $count -lt $retries ]; do
              if git clone --depth 1 --branch "$branch" "$repo" openwrt-src; then
                return 0
              fi
              echo "âš ï¸ æ‹‰å–æºç å¤±è´¥ï¼Œé‡è¯•ç¬¬ $((count+1)) æ¬¡..."
              count=$((count+1))
              rm -rf openwrt-src  # æ¸…ç†å¤±è´¥çš„ç›®å½•
              sleep 5  # ç­‰å¾…5ç§’å†é‡è¯•
            done
            echo "âŒ æ‹‰å–æºç å¤±è´¥ï¼ˆå·²é‡è¯•3æ¬¡ï¼‰"
            exit 1
          }

          # é€‰æ‹©ä»“åº“å¹¶è°ƒç”¨æ‹‰å–å‡½æ•°
          case "${{ github.event.inputs.source_branch }}" in
            openwrt-23.05)
              fetch_source "https://git.openwrt.org/openwrt/openwrt.git" "openwrt-23.05"
              ;;
            openwrt-master)
              fetch_source "https://git.openwrt.org/openwrt/openwrt.git" "master"
              ;;
            immortalwrt-23.05)
              fetch_source "https://github.com/immortalwrt/immortalwrt.git" "openwrt-23.05"
              ;;
            immortalwrt-master)
              fetch_source "https://github.com/immortalwrt/immortalwrt.git" "master"
              ;;
          esac
          echo "SRC_DIR=$(pwd)/openwrt-src" >> $GITHUB_ENV
        
      - name: æ‹‰å–æºç ï¼ˆå¸¦é‡è¯•ï¼‰
        run: |
          # å®šä¹‰æ‹‰å–å‡½æ•°ï¼ˆæœ€å¤šé‡è¯•3æ¬¡ï¼‰
          fetch_source() {
            local repo=$1
            local branch=$2
            local retries=3
            local count=0
            while [ $count -lt $retries ]; do
              if git clone --depth 1 --branch "$branch" "$repo" openwrt-src; then
                return 0
              fi
              echo "âš ï¸ æ‹‰å–æºç å¤±è´¥ï¼Œé‡è¯•ç¬¬ $((count+1)) æ¬¡..."
              count=$((count+1))
              rm -rf openwrt-src  # æ¸…ç†å¤±è´¥çš„ç›®å½•
              sleep 5  # ç­‰å¾…5ç§’å†é‡è¯•
            done
            echo "âŒ æ‹‰å–æºç å¤±è´¥ï¼ˆå·²é‡è¯•3æ¬¡ï¼‰"
            exit 1
          }

          # é€‰æ‹©ä»“åº“å¹¶è°ƒç”¨æ‹‰å–å‡½æ•°
          case "${{ github.event.inputs.source_branch }}" in
            openwrt-23.05)
              fetch_source "https://git.openwrt.org/openwrt/openwrt.git" "openwrt-23.05"
              ;;
            openwrt-master)
              fetch_source "https://git.openwrt.org/openwrt/openwrt.git" "master"
              ;;
            immortalwrt-23.05)
              fetch_source "https://github.com/immortalwrt/immortalwrt.git" "openwrt-23.05"
              ;;
            immortalwrt-master)
              fetch_source "https://github.com/immortalwrt/immortalwrt.git" "master"
              ;;
          esac
          echo "SRC_DIR=$(pwd)/openwrt-src" >> $GITHUB_ENV
     
      - name: è¾“å‡ºå›ºä»¶ç±»å‹è¯´æ˜
        run: |
          echo "ğŸ“Œ å›ºä»¶ç±»å‹è¯´æ˜ï¼š"
          echo "  - å« 'sysupgrade' çš„æ–‡ä»¶ï¼šç”¨äºè®¾å¤‡å‡çº§ï¼ˆä¿ç•™é…ç½®ï¼‰"
          echo "  - å« 'factory' çš„æ–‡ä»¶ï¼šç”¨äºé¦–æ¬¡åˆ·å†™ï¼ˆæ¸…ç©ºé…ç½®ï¼‰"
          find "${{ env.SRC_DIR }}/bin/targets/" -name "*.bin" | grep -E "sysupgrade|factory" | while read -r file; do
            echo "  - $file"
          done
      
      - name: æ¸…ç†ç¼–è¯‘ç¼“å­˜ï¼ˆé¦–æ¬¡è¿è¡Œæˆ–ç‰ˆæœ¬åˆ‡æ¢æ—¶ï¼‰
        run: |
          if [ -d "openwrt-src" ]; then
            echo "ğŸ§¹ æ¸…ç†æ—§ç¼–è¯‘ç›®å½•..."
            rm -rf openwrt-src
          fi
        if: ${{ github.event.inputs.source_branch != github.event.repository.default_branch }}  # ç‰ˆæœ¬åˆ‡æ¢æ—¶è§¦å‘
      
      - name: å›ºä»¶ä¿¡æ¯æ‘˜è¦
        run: |
          firmware_path=$(find "${{ env.SRC_DIR }}/bin/targets/" -name "*.bin" | head -n1)
          if [ -n "$firmware_path" ]; then
            echo "ğŸ“Š å›ºä»¶ä¿¡æ¯ï¼š"
            echo "  - è·¯å¾„ï¼š$firmware_path"
            echo "  - å¤§å°ï¼š$(du -h "$firmware_path" | awk '{print $1}')"
            echo "  - é€‚ç”¨è®¾å¤‡ï¼š${{ github.event.inputs.device || github.event.inputs.chip }}"
            echo "  - æºç ç‰ˆæœ¬ï¼š${{ github.event.inputs.source_branch }}"
            echo "  - ä¸»é¢˜ï¼š${{ env.THEME }}"
          fi
          

