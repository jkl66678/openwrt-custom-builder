name: OpenWrtå…¨åŠŸèƒ½åŠ¨æ€ç¼–è¯‘ç³»ç»Ÿï¼ˆå®Œæ•´ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      select_mode:
        type: choice
        description: ç¼–è¯‘æ¨¡å¼ï¼ˆè®¾å¤‡/èŠ¯ç‰‡ï¼‰
        required: true
        options: [device, chip]

      device:
        type: choice
        description: è®¾å¤‡å‹å·ï¼ˆä»…è®¾å¤‡æ¨¡å¼ï¼‰
        required: false
        options: [cudy-tr3000, redmi-ac2100, x86-64-generic, phicomm-k2p]  # è‡ªåŠ¨æ›´æ–°æ ‡è®°

      chip:
        type: choice
        description: èŠ¯ç‰‡å‹å·ï¼ˆä»…èŠ¯ç‰‡æ¨¡å¼ï¼‰
        required: false
        options: [mt7981, mt7621, x86_64, ipq8065, bcm53573]  # è‡ªåŠ¨æ›´æ–°æ ‡è®°

      source_branch:
        type: choice
        description: æºç åˆ†æ”¯
        required: true
        options: [openwrt-23.05, openwrt-master, immortalwrt-23.05, immortalwrt-master]

      theme_and_optimization:
        type: choice
        description: ä¸»é¢˜+ç¼–è¯‘ä¼˜åŒ–ç»„åˆ
        required: true
        options:
          - argon-O2-generic
          - argon-O3-armv8
          - argon-O3-x86
          - bootstrap-O2-generic
          - material-Os-generic

      core_features:
        type: choice
        description: æ ¸å¿ƒåŠŸèƒ½
        required: true
        options: [ipv6+accel, ipv6-only, accel-only, none]

      packages:
        type: string
        description: è½¯ä»¶åŒ…ï¼ˆæ ¼å¼ï¼šåŒ…1,åŒ…2ï¼Œæ— éœ€å‰ç¼€è‡ªåŠ¨è¡¥å…¨luci-app-ï¼‰
        required: false
        default: "openclash,samba,ddns-scripts"

      rootfs_size:
        type: number
        description: æ ¹åˆ†åŒºå¤§å°(MBï¼Œ32-2048)
        required: true
        default: 192
        min: 32
        max: 2048

      firmware_suffix:
        type: string
        description: å›ºä»¶åç¼€ï¼ˆå¦‚ç‰ˆæœ¬å·æˆ–è‡ªå®šä¹‰æ ‡è¯†ï¼‰
        required: false
        default: "custom"

      run_custom_script:
        type: boolean
        description: æ‰§è¡Œè‡ªå®šä¹‰åˆå§‹åŒ–è„šæœ¬ï¼ˆscripts/custom-init.shï¼‰
        required: true
        default: true

jobs:
  build-firmware:
    name: ç¼–è¯‘å›ºä»¶
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
      packages: write

    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç ï¼ˆå«å­æ¨¡å—ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: "recursive"  # æ”¯æŒå­æ¨¡å—ï¼ˆå¦‚æœ‰è‡ªå®šä¹‰æ’ä»¶ï¼‰

      - name: æ£€æŸ¥æ ¸å¿ƒé…ç½®æ–‡ä»¶
        run: |
          # æ£€æŸ¥è®¾å¤‡é…ç½®æ–‡ä»¶
          if [ ! -f "device-drivers.json" ]; then
            echo "âŒ æœªæ‰¾åˆ°è®¾å¤‡é…ç½®æ–‡ä»¶ device-drivers.jsonï¼Œè¯·å…ˆè¿è¡ŒåŒæ­¥å·¥ä½œæµ"
            exit 1
          fi
          # æ£€æŸ¥è‡ªå®šä¹‰è„šæœ¬ï¼ˆå¦‚æœå¯ç”¨ï¼‰
          if [ "${{ github.event.inputs.run_custom_script }}" = "true" ] && [ ! -f "scripts/custom-init.sh" ]; then
            echo "âŒ å¯ç”¨äº†è‡ªå®šä¹‰è„šæœ¬ä½†æœªæ‰¾åˆ° scripts/custom-init.sh"
            exit 1
          fi
          echo "âœ… æ ¸å¿ƒé…ç½®æ–‡ä»¶æ£€æŸ¥é€šè¿‡"

      - name: å®‰è£…å®Œæ•´ç¼–è¯‘ä¾èµ–
        run: |
          sudo apt update -y
          sudo apt install -y \
            build-essential libncurses5-dev libncursesw5-dev \
            zlib1g-dev gawk git gettext libssl-dev xsltproc wget unzip \
            python3 python3-pip jq time curl ca-certificates \
            libelf-dev libzstd-dev flex bison  # è¡¥å……å†…æ ¸ç¼–è¯‘ä¾èµ–
          # å®‰è£…Pythonå·¥å…·ï¼ˆéƒ¨åˆ†æºç ä¾èµ–ï¼‰
          pip3 install --upgrade pip
          pip3 install requests
          echo "âœ… ç¼–è¯‘ä¾èµ–å®‰è£…å®Œæˆ"

      - name: ç¡¬ä»¶èµ„æºè¯¦ç»†æ£€æµ‹
        run: |
          echo "ğŸ–¥ï¸ ç¼–è¯‘ç¯å¢ƒä¿¡æ¯ï¼š"
          echo "  - CPUå‹å·ï¼š$(grep -m1 'model name' /proc/cpuinfo | cut -d: -f2 | sed -e 's/^ *//')"
          echo "  - æ ¸å¿ƒæ•°ï¼š$(grep -c ^processor /proc/cpuinfo)"
          echo "  - æ€»å†…å­˜ï¼š$(free -h | awk '/^Mem:/ {print $2}')"
          echo "  - å¯ç”¨å†…å­˜ï¼š$(free -h | awk '/^Mem:/ {print $7}')"
          echo "  - ç£ç›˜ç©ºé—´ï¼š$(df -h / | awk 'NR==2 {print $4}')"
          
          # å†™å…¥ç¯å¢ƒå˜é‡ï¼ˆç”¨äºçº¿ç¨‹è®¡ç®—ï¼‰
          CPU_CORES=$(grep -c ^processor /proc/cpuinfo)
          AVAIL_MEM_MB=$(free -m | awk '/^Mem:/ {print $7}')
          echo "CPU_CORES=$CPU_CORES" >> $GITHUB_ENV
          echo "AVAIL_MEM_MB=$AVAIL_MEM_MB" >> $GITHUB_ENV

      - name: æ™ºèƒ½è®¡ç®—ç¼–è¯‘çº¿ç¨‹æ•°
        run: |
          # è§£æä¼˜åŒ–çº§åˆ«å’Œæ¶æ„
          OPT_LEVEL=$(echo "${{ github.event.inputs.theme_and_optimization }}" | cut -d'-' -f2)
          ARCH=$(echo "${{ github.event.inputs.theme_and_optimization }}" | cut -d'-' -f3)
          
          # æ ¹æ®ä¼˜åŒ–çº§åˆ«è®¾ç½®åŸºç¡€å†…å­˜éœ€æ±‚ï¼ˆO3æ¯”O2æ›´è€—å†…å­˜ï¼‰
          case "$OPT_LEVEL" in
            O3|Os) MIN_MEM_PER_THREAD=2048 ;;  # é«˜ä¼˜åŒ–çº§åˆ«å†…å­˜éœ€æ±‚é«˜
            *) MIN_MEM_PER_THREAD=1024 ;;
          esac
          
          # æ¶æ„è°ƒæ•´ï¼ˆARMv8æ¶æ„ç¼–è¯‘æ›´è€—å†…å­˜ï¼‰
          if [ "$ARCH" = "armv8" ]; then
            MIN_MEM_PER_THREAD=$((MIN_MEM_PER_THREAD * 3 / 2))  # å¢åŠ 50%å†…å­˜éœ€æ±‚
          fi
          
          # è®¡ç®—æœ€å¤§å¯èƒ½çº¿ç¨‹æ•°ï¼ˆå–å†…å­˜å’ŒCPUæ ¸å¿ƒçš„æœ€å°å€¼ï¼‰
          MAX_THREADS_BY_MEM=$((AVAIL_MEM_MB / MIN_MEM_PER_THREAD))
          MAX_THREADS_BY_CPU=${{ env.CPU_CORES }}
          FINAL_THREADS=$((MAX_THREADS_BY_MEM < MAX_THREADS_BY_CPU ? MAX_THREADS_BY_MEM : MAX_THREADS_BY_CPU))
          
          # ç¡®ä¿çº¿ç¨‹æ•°è‡³å°‘ä¸º1ï¼Œä¸”é«˜è´Ÿè½½åœºæ™¯é™åˆ¶ä¸Šé™
          FINAL_THREADS=$((FINAL_THREADS < 1 ? 1 : FINAL_THREADS))
          if [ "$OPT_LEVEL" = "O3" ] && [ "$FINAL_THREADS" -gt 4 ]; then
            FINAL_THREADS=4  # O3ä¼˜åŒ–é™åˆ¶æœ€å¤§4çº¿ç¨‹ï¼Œé¿å…å†…å­˜æº¢å‡º
          fi
          
          echo "âš™ï¸ ç¼–è¯‘çº¿ç¨‹é…ç½®ï¼š"
          echo "  - ä¼˜åŒ–çº§åˆ«ï¼š$OPT_LEVELï¼Œæ¶æ„ï¼š$ARCH"
          echo "  - å•çº¿ç¨‹å†…å­˜éœ€æ±‚ï¼š${MIN_MEM_PER_THREAD}MB"
          echo "  - æœ€ç»ˆçº¿ç¨‹æ•°ï¼š$FINAL_THREADS"
          echo "THREADS=$FINAL_THREADS" >> $GITHUB_ENV

      - name: è§£æç¼–è¯‘å‚æ•°ï¼ˆä¸»é¢˜/åŠŸèƒ½/è½¯ä»¶åŒ…ï¼‰
        run: |
          # è§£æä¸»é¢˜å’Œç¼–è¯‘ä¼˜åŒ–
          THEME=$(echo "${{ github.event.inputs.theme_and_optimization }}" | cut -d'-' -f1)
          CFLAGS="-$(echo "${{ github.event.inputs.theme_and_optimization }}" | cut -d'-' -f2)"
          echo "THEME=$THEME" >> $GITHUB_ENV
          echo "CFLAGS=$CFLAGS" >> $GITHUB_ENV
          
          # è§£ææ ¸å¿ƒåŠŸèƒ½ï¼ˆIPv6/ç¡¬ä»¶åŠ é€Ÿï¼‰
          case "${{ github.event.inputs.core_features }}" in
            "ipv6+accel")
              echo "ENABLE_IPV6=true" >> $GITHUB_ENV
              echo "ENABLE_ACCEL=true" >> $GITHUB_ENV
              ;;
            "ipv6-only")
              echo "ENABLE_IPV6=true" >> $GITHUB_ENV
              echo "ENABLE_ACCEL=false" >> $GITHUB_ENV
              ;;
            "accel-only")
              echo "ENABLE_IPV6=false" >> $GITHUB_ENV
              echo "ENABLE_ACCEL=true" >> $GITHUB_ENV
              ;;
            "none")
              echo "ENABLE_IPV6=false" >> $GITHUB_ENV
              echo "ENABLE_ACCEL=false" >> $GITHUB_ENV
              ;;
          esac
          
          # è§£æè½¯ä»¶åŒ…ï¼ˆè‡ªåŠ¨è¡¥å…¨luci-app-å‰ç¼€ï¼Œè·³è¿‡å·²å¸¦å‰ç¼€çš„åŒ…ï¼‰
          packages="${{ github.event.inputs.packages }}"
          processed_pkgs=$(echo "$packages" | tr ',' '\n' | while read -r pkg; do
            if [[ "$pkg" == "luci-app-"* ]]; then
              echo "$pkg"  # å·²å¸¦å‰ç¼€çš„åŒ…ç›´æ¥ä¿ç•™
            else
              echo "luci-app-$pkg"  # è¡¥å…¨å‰ç¼€
            fi
          done | tr '\n' ' ')
          echo "PACKAGES=$processed_pkgs" >> $GITHUB_ENV
          echo "ğŸ“¦ è§£æåè½¯ä»¶åŒ…ï¼š$processed_pkgs"

      - name: æ‹‰å–OpenWrtæºç ï¼ˆå¢å¼ºé‡è¯•æœºåˆ¶ï¼‰
        run: |
          # å®šä¹‰å¸¦è¶…æ—¶å’Œé‡è¯•çš„æ‹‰å–å‡½æ•°
          fetch_source() {
            local repo=$1 branch=$2 timeout=300 retries=5
            echo "ğŸ“¥ æ‹‰å–æºç ï¼š$repoï¼ˆåˆ†æ”¯ï¼š$branchï¼‰"
            
            for ((i=1; i<=retries; i++)); do
              if timeout $timeout git clone --depth 1 --branch "$branch" "$repo" openwrt-src; then
                # æ£€æŸ¥æºç ç›®å½•æ˜¯å¦æœ‰æ•ˆ
                if [ -f "openwrt-src/Makefile" ]; then
                  echo "âœ… æºç æ‹‰å–æˆåŠŸï¼ˆå°è¯•$iæ¬¡ï¼‰"
                  return 0
                else
                  echo "âš ï¸ æºç ç›®å½•æ— æ•ˆï¼Œé‡æ–°æ‹‰å–..."
                fi
              else
                echo "âš ï¸ æ‹‰å–å¤±è´¥ï¼ˆå°è¯•$iæ¬¡ï¼Œå‰©ä½™$((retries-i))æ¬¡ï¼‰"
              fi
              rm -rf openwrt-src
              sleep $((i * 5))  # é‡è¯•é—´éš”é€’å¢
            done
            
            echo "âŒ æºç æ‹‰å–å¤±è´¥ï¼ˆå·²å°è¯•$retriesæ¬¡ï¼‰"
            exit 1
          }
          
          # æ ¹æ®åˆ†æ”¯é€‰æ‹©ä»“åº“
          case "${{ github.event.inputs.source_branch }}" in
            openwrt-23.05)
              fetch_source "https://git.openwrt.org/openwrt/openwrt.git" "openwrt-23.05"
              ;;
            openwrt-master)
              fetch_source "https://git.openwrt.org/openwrt/openwrt.git" "master"
              ;;
            immortalwrt-23.05)
              fetch_source "https://github.com/immortalwrt/immortalwrt.git" "openwrt-23.05"
              ;;
            immortalwrt-master)
              fetch_source "https://github.com/immortalwrt/immortalwrt.git" "master"
              ;;
          esac
          
          # è®°å½•æºç ç›®å½•
          echo "SRC_DIR=$(pwd)/openwrt-src" >> $GITHUB_ENV

      - name: åˆå§‹åŒ–æºç ä¸æ‰©å±•æºï¼ˆå¸¦é‡è¯•ï¼‰
        run: |
          cd "${{ env.SRC_DIR }}"
          echo "ğŸ”§ åˆå§‹åŒ–æºç  feeds..."
          
          # é‡è¯•æœºåˆ¶æ›´æ–°feeds
          update_feeds() {
            local retries=3
            for ((i=1; i<=retries; i++)); do
              if ./scripts/feeds update -a; then
                return 0
              fi
              echo "âš ï¸ feedsæ›´æ–°å¤±è´¥ï¼ˆå°è¯•$iæ¬¡ï¼‰ï¼Œé‡è¯•..."
              sleep $((i * 3))
            done
            echo "âŒ feedsæ›´æ–°å¤±è´¥"
            exit 1
          }
          
          update_feeds
          ./scripts/feeds install -a
          
          # æ·»åŠ ä¸»é¢˜æºï¼ˆæ ¹æ®ä¸»é¢˜é€‰æ‹©ï¼‰
          if [ "${{ env.THEME }}" = "argon" ]; then
            echo 'src-git argon https://github.com/jerrykuku/luci-theme-argon.git' >> feeds.conf.default
            echo "ğŸ“Œ æ·»åŠ argonä¸»é¢˜æº"
          elif [ "${{ env.THEME }}" = "material" ]; then
            echo 'src-git material https://github.com/LuttyYang/luci-theme-material.git' >> feeds.conf.default
            echo "ğŸ“Œ æ·»åŠ materialä¸»é¢˜æº"
          fi
          
          # æ·»åŠ OpenClashæºï¼ˆImmortalWrtå¯èƒ½å·²å†…ç½®ï¼Œæ— éœ€é‡å¤æ·»åŠ ï¼‰
          if [[ "${{ env.PACKAGES }}" == *"luci-app-openclash"* && 
                ! "${{ github.event.inputs.source_branch }}" == *"immortalwrt"* ]]; then
            echo 'src-git openclash https://github.com/vernesong/OpenClash.git' >> feeds.conf.default
            echo "ğŸ“Œ æ·»åŠ OpenClashæº"
          fi
          
          # å†æ¬¡æ›´æ–°feedsä»¥åº”ç”¨æ–°å¢æº
          update_feeds
          ./scripts/feeds install -a

      - name: æ‰§è¡Œè‡ªå®šä¹‰åˆå§‹åŒ–è„šæœ¬ï¼ˆå¸¦æ—¥å¿—å’Œè¶…æ—¶ï¼‰
        if: ${{ github.event.inputs.run_custom_script == 'true' }}
        run: |
          cd "${{ env.SRC_DIR }}"
          echo "ğŸ“ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ï¼šscripts/custom-init.sh"
          
          # è¶…æ—¶æ§åˆ¶ï¼ˆæœ€é•¿30åˆ†é’Ÿï¼‰
          timeout 1800 ../scripts/custom-init.sh > custom-init.log 2>&1
          exit_code=$?
          
          # æ£€æŸ¥æ‰§è¡Œç»“æœ
          if [ $exit_code -eq 124 ]; then
            echo "âŒ è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œè¶…æ—¶ï¼ˆè¶…è¿‡30åˆ†é’Ÿï¼‰"
            cat custom-init.log
            exit 1
          elif [ $exit_code -ne 0 ]; then
            echo "âŒ è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼ˆé€€å‡ºç ï¼š$exit_codeï¼‰"
            cat custom-init.log
            exit $exit_code
          fi
          
          echo "âœ… è‡ªå®šä¹‰è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
          echo "ğŸ“„ è„šæœ¬è¾“å‡ºæ—¥å¿—å·²ä¿å­˜è‡³custom-init.log"

      - name: è§£æè®¾å¤‡/èŠ¯ç‰‡é…ç½®ï¼ˆå¢å¼ºå®¹é”™ï¼‰
        run: |
          # æ ¹æ®æ¨¡å¼æå–è®¾å¤‡/èŠ¯ç‰‡ä¿¡æ¯
          if [ "${{ github.event.inputs.select_mode }}" = "device" ]; then
            dev="${{ github.event.inputs.device }}"
            info=$(jq --arg dev "$dev" '.devices[] | select(.name == $dev)' device-drivers.json)
            if [ -z "$info" ]; then
              echo "âŒ è®¾å¤‡ $dev æœªåœ¨device-drivers.jsonä¸­æ‰¾åˆ°"
              exit 1
            fi
            echo "ğŸ“Œ é€‰ä¸­è®¾å¤‡ï¼š$dev"
          else
            chip="${{ github.event.inputs.chip }}"
            chip_info=$(jq --arg c "$chip" '.chips[] | select(.name == $c)' device-drivers.json)
            if [ -z "$chip_info" ]; then
              echo "âŒ èŠ¯ç‰‡ $chip æœªåœ¨device-drivers.jsonä¸­æ‰¾åˆ°"
              exit 1
            fi
            # ä»èŠ¯ç‰‡å…³è”çš„å¹³å°è·å–è®¾å¤‡é…ç½®
            kernel_target=$(echo "$chip_info" | jq -r '.platforms' | cut -d',' -f1)  # å–ç¬¬ä¸€ä¸ªå¹³å°
            info=$(jq --arg p "$kernel_target" '.devices[] | select(.kernel_target == $p)' device-drivers.json | head -n1)
            echo "ğŸ“Œ é€‰ä¸­èŠ¯ç‰‡ï¼š$chipï¼ˆå¹³å°ï¼š$kernel_targetï¼‰"
          fi
          
          # æå–å†…æ ¸ç›®æ ‡å’Œé©±åŠ¨
          kernel_target=$(echo "$info" | jq -r '.kernel_target')
          drivers=$(echo "$info" | jq -r '.drivers[]' | tr '\n' ' ')
          
          # éªŒè¯å†…æ ¸ç›®æ ‡æœ‰æ•ˆæ€§
          if [ -z "$kernel_target" ] || [ "$kernel_target" = "null" ]; then
            echo "âŒ æ— æ³•è·å–å†…æ ¸ç›®æ ‡é…ç½®"
            exit 1
          fi
          
          echo "KERNEL_TARGET=$kernel_target" >> $GITHUB_ENV
          echo "DRIVERS=$drivers" >> $GITHUB_ENV
          echo "ğŸ”§ å†…æ ¸ç›®æ ‡ï¼š$kernel_target"
          echo "ğŸ”§ å…³è”é©±åŠ¨æ•°ï¼š$(echo "$drivers" | wc -w)"

      - name: ç”Ÿæˆç¼–è¯‘é…ç½®æ–‡ä»¶ï¼ˆ.configï¼‰
        run: |
          cd "${{ env.SRC_DIR }}"
          target=$(echo "${{ env.KERNEL_TARGET }}" | tr '/' '_')  # è½¬æ¢è·¯å¾„ä¸ºç›®æ ‡åï¼ˆå¦‚"mediatek/mt7622" â†’ "mediatek_mt7622"ï¼‰
          
          echo "ğŸ“ ç”Ÿæˆ.configé…ç½®æ–‡ä»¶..."
          > .config  # æ¸…ç©ºç°æœ‰é…ç½®
          
          # æ ¸å¿ƒç›®æ ‡é…ç½®
          echo "CONFIG_TARGET_$target=y" >> .config
          echo "CONFIG_TARGET_${target}_DEVICE_generic=y" >> .config  # é€šç”¨è®¾å¤‡é…ç½®
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=${{ github.event.inputs.rootfs_size }}" >> .config  # æ ¹åˆ†åŒºå¤§å°
          
          # é©±åŠ¨é…ç½®ï¼ˆä»device-drivers.jsonæå–ï¼‰
          for driver in ${{ env.DRIVERS }}; do
            # è¿‡æ»¤æ— æ•ˆé©±åŠ¨åï¼ˆé¿å…ç©ºå€¼ï¼‰
            if [ -n "$driver" ] && [ "$driver" != "null" ]; then
              echo "CONFIG_PACKAGE_$driver=y" >> .config
            fi
          done
          
          # è½¯ä»¶åŒ…é…ç½®ï¼ˆç”¨æˆ·é€‰æ‹©çš„åŒ…ï¼‰
          for pkg in ${{ env.PACKAGES }}; do
            echo "CONFIG_PACKAGE_$pkg=y" >> .config
          done
          
          # æ ¸å¿ƒåŠŸèƒ½é…ç½®ï¼ˆIPv6/ç¡¬ä»¶åŠ é€Ÿï¼‰
          if [ "${{ env.ENABLE_IPV6 }}" = "true" ]; then
            echo "CONFIG_IPV6=y" >> .config
            echo "CONFIG_PACKAGE_ipv6helper=y" >> .config  # IPv6è¾…åŠ©å·¥å…·
            echo "CONFIG_PACKAGE_6in4=y" >> .config       # IPv6éš§é“
          else
            echo "# CONFIG_IPV6 is not set" >> .config
          fi
          
          if [ "${{ env.ENABLE_ACCEL }}" = "true" ]; then
            echo "CONFIG_PACKAGE_kmod-nf-flow=y" >> .config        # æµé‡åŠ é€Ÿ
            echo "CONFIG_PACKAGE_kmod-ipt-raw=y" >> .config       # åŸå§‹IPTablesè§„åˆ™
            echo "CONFIG_PACKAGE_kmod-nft-offload=y" >> .config   # NFTå¸è½½åŠ é€Ÿ
          fi
          
          # ç¼–è¯‘ä¼˜åŒ–é…ç½®
          echo "CONFIG_CFLAGS=${{ env.CFLAGS }}" >> .config
          echo "CONFIG_CXXFLAGS=${{ env.CFLAGS }}" >> .config
          echo "CONFIG_BUILD_OPTIMIZATION=${{ env.CFLAGS }}" >> .config  # å…¨å±€ä¼˜åŒ–çº§åˆ«
          
          # ä¸»é¢˜é…ç½®ï¼ˆä»…ä¿ç•™é€‰ä¸­çš„ä¸»é¢˜ï¼‰
          echo "CONFIG_PACKAGE_luci-theme-${{ env.THEME }}=y" >> .config
          # ç¦ç”¨å…¶ä»–ä¸»é¢˜
          for theme in argon bootstrap material; do
            if [ "$theme" != "${{ env.THEME }}" ]; then
              echo "# CONFIG_PACKAGE_luci-theme-$theme is not set" >> .config
            fi
          done
          
          # ç”Ÿæˆæœ€ç»ˆé…ç½®ï¼ˆè‡ªåŠ¨å¤„ç†ä¾èµ–ï¼‰
          make defconfig
          
          # é¢„è§ˆå…³é”®é…ç½®ï¼ˆä¾¿äºè°ƒè¯•ï¼‰
          echo "ğŸ” å…³é”®é…ç½®é¢„è§ˆï¼š"
          grep -E 'TARGET_|ROOTFS_PARTSIZE|IPV6|THEME|CFLAGS' .config

      - name: å¼€å§‹ç¼–è¯‘å›ºä»¶ï¼ˆå¸¦è®¡æ—¶å’Œè¿›åº¦ï¼‰
        run: |
          cd "${{ env.SRC_DIR }}"
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ï¼ˆçº¿ç¨‹æ•°ï¼š${{ env.THREADS }}ï¼Œä¼˜åŒ–çº§åˆ«ï¼š${{ env.CFLAGS }}ï¼‰"
          echo "â±ï¸ ç¼–è¯‘å¼€å§‹æ—¶é—´ï¼š$(date)"
          
          # è®°å½•ç¼–è¯‘æ—¶é—´å’Œè¾“å‡ºæ—¥å¿—
          time make -j${{ env.THREADS }} V=s 2>&1 | tee compile.log
          
          echo "âœ… ç¼–è¯‘å®Œæˆ"
          echo "â±ï¸ ç¼–è¯‘ç»“æŸæ—¶é—´ï¼š$(date)"

      - name: ç¼–è¯‘å¤±è´¥è¯¦ç»†åˆ†æ
        if: failure()
        run: |
          cd "${{ env.SRC_DIR }}"
          echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œé”™è¯¯åˆ†æï¼š"
          
          # å¸¸è§é”™è¯¯ç±»å‹æ£€æµ‹
          if grep -q "out of memory" compile.log; then
            echo "â†’ å†…å­˜ä¸è¶³ï¼ˆå»ºè®®ï¼šå‡å°‘çº¿ç¨‹æ•°æˆ–é™ä½ä¼˜åŒ–çº§åˆ«ï¼‰"
          elif grep -q "Killed signal terminated program cc1" compile.log; then
            echo "â†’ ç¼–è¯‘å™¨è¢«ç³»ç»Ÿç»ˆæ­¢ï¼ˆå†…å­˜æº¢å‡ºï¼Œå»ºè®®å‡å°‘çº¿ç¨‹æ•°ï¼‰"
          elif grep -q "Package '.*' is missing" compile.log; then
            missing_pkgs=$(grep "Package '.*' is missing" compile.log | awk -F"'" '{print $2}' | sort | uniq | tr '\n' ' ')
            echo "â†’ ç¼ºå¤±ä¾èµ–åŒ…ï¼š$missing_pkgsï¼ˆå»ºè®®ï¼šæ£€æŸ¥è½¯ä»¶åŒ…åç§°æˆ–åˆ‡æ¢æºç åˆ†æ”¯ï¼‰"
          elif grep -q "recursive dependency detected" compile.log; then
            echo "â†’ è½¯ä»¶åŒ…ä¾èµ–å†²çªï¼ˆå»ºè®®ï¼šå‡å°‘å‹¾é€‰çš„è½¯ä»¶åŒ…ï¼Œé¿å…é‡å¤åŠŸèƒ½ï¼‰"
          elif grep -q "permission denied" compile.log; then
            echo "â†’ æƒé™é”™è¯¯ï¼ˆå»ºè®®ï¼šæ£€æŸ¥è‡ªå®šä¹‰è„šæœ¬æ˜¯å¦ä¿®æ”¹äº†æ–‡ä»¶æƒé™ï¼‰"
          else
            echo "â†’ æœªçŸ¥é”™è¯¯ï¼Œæœ€å100è¡Œæ—¥å¿—ï¼š"
            tail -n 100 compile.log
          fi
          
          exit 1

      - name: å›ºä»¶é‡å‘½åä¸æ•´ç†
        run: |
          # å®šä¹‰å›ºä»¶åŸºç¡€åç§°ï¼ˆè®¾å¤‡/èŠ¯ç‰‡-åˆ†æ”¯-ä¸»é¢˜-æ—¥æœŸ-åç¼€ï¼‰
          base_name="${{ github.event.inputs.device || github.event.inputs.chip }}-${{ github.event.inputs.source_branch }}-${{ env.THEME }}"
          firmware_suffix="${{ github.event.inputs.firmware_suffix }}-$(date +%Y%m%d-%H%M)"
          
          # é‡å‘½åæ‰€æœ‰å›ºä»¶æ–‡ä»¶ï¼ˆæ·»åŠ åç¼€ï¼‰
          find "${{ env.SRC_DIR }}/bin/targets/" -name "*.bin" -exec sh -c '
            for file do
              dir=$(dirname "$file")
              filename=$(basename "$file" .bin)
              new_filename="${filename}-${1}.bin"
              mv "$file" "$dir/$new_filename"
              echo "ğŸ“¦ é‡å‘½åï¼š$new_filename"
            done
          ' _ "$firmware_suffix" \;
          
          # ç”Ÿæˆå›ºä»¶æ ¡éªŒå’Œï¼ˆä¾¿äºç”¨æˆ·éªŒè¯ï¼‰
          find "${{ env.SRC_DIR }}/bin/targets/" -name "*.bin" -exec sh -c '
            for file do
              sha256sum "$file" > "$file.sha256"
              echo "ğŸ“ ç”Ÿæˆæ ¡éªŒå’Œï¼š$(basename "$file.sha256")"
            done
          ' _ \;

      - name: ä¸Šä¼ ç¼–è¯‘æˆæœï¼ˆå«æ—¥å¿—å’Œé…ç½®ï¼‰
        uses: actions/upload-artifact@v4
        if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¸Šä¼ 
        with:
          name: "${{ github.event.inputs.device || github.event.inputs.chip }}-firmware-${{ github.run_id }}"
          path: |
            ${{ env.SRC_DIR }}/bin/targets/**/*.bin
            ${{ env.SRC_DIR }}/bin/targets/**/*.sha256
            ${{ env.SRC_DIR }}/compile.log
            ${{ env.SRC_DIR }}/custom-init.log*
            ${{ env.SRC_DIR }}/.config  # ç¼–è¯‘é…ç½®æ–‡ä»¶ï¼ˆä¾¿äºå¤ç°ï¼‰
          retention-days: 30  # ä¿ç•™30å¤©
          if-no-files-found: error  # æ— æ–‡ä»¶æ—¶æ ‡è®°é”™è¯¯

      - name: å›ºä»¶ç±»å‹è¯´æ˜ä¸åˆ—è¡¨
        run: |
          echo "ğŸ“Œ å›ºä»¶ç±»å‹è¯´æ˜ï¼š"
          echo "  - sysupgrade.binï¼šè®¾å¤‡å‡çº§æ–‡ä»¶ï¼ˆä¿ç•™é…ç½®ï¼Œé€‚ç”¨äºå·²å®‰è£…OpenWrtçš„è®¾å¤‡ï¼‰"
          echo "  - factory.binï¼šå·¥å‚å›ºä»¶ï¼ˆé¦–æ¬¡åˆ·å†™ï¼Œé€‚ç”¨äºåŸå‚ç³»ç»Ÿè®¾å¤‡ï¼‰"
          echo "  - *.sha256ï¼šå›ºä»¶æ ¡éªŒå’Œæ–‡ä»¶ï¼ˆç”¨äºéªŒè¯å®Œæ•´æ€§ï¼‰"
          
          echo -e "\nğŸ“‹ ç¼–è¯‘æˆæœåˆ—è¡¨ï¼š"
          find "${{ env.SRC_DIR }}/bin/targets/" -name "*.bin" | grep -E "sysupgrade|factory" | while read -r file; do
            echo "  - $(basename "$file")ï¼ˆå¤§å°ï¼š$(du -h "$file" | awk '{print $1}')ï¼‰"
          done

      - name: å›ºä»¶ä¿¡æ¯æ‘˜è¦
        run: |
          # æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå›ºä»¶æ–‡ä»¶ä½œä¸ºç¤ºä¾‹
          firmware_path=$(find "${{ env.SRC_DIR }}/bin/targets/" -name "*.bin" | head -n1)
          if [ -n "$firmware_path" ]; then
            echo -e "\nğŸ“Š å›ºä»¶ä¿¡æ¯æ‘˜è¦ï¼š"
            echo "  - è·¯å¾„ï¼š$firmware_path"
            echo "  - å¤§å°ï¼š$(du -h "$firmware_path" | awk '{print $1}')"
            echo "  - é€‚ç”¨è®¾å¤‡/èŠ¯ç‰‡ï¼š${{ github.event.inputs.device || github.event.inputs.chip }}"
            echo "  - æºç åˆ†æ”¯ï¼š${{ github.event.inputs.source_branch }}"
            echo "  - ä¸»é¢˜ï¼š${{ env.THEME }}"
            echo "  - ä¼˜åŒ–çº§åˆ«ï¼š${{ env.CFLAGS }}"
            echo "  - ç¼–è¯‘æ—¶é—´ï¼š$(date +"%Y-%m-%d %H:%M:%S")"
          fi

      - name: æ¸…ç†ç¼–è¯‘ç¼“å­˜ï¼ˆæ¡ä»¶è§¦å‘ï¼‰
        run: |
          if [ -d "openwrt-src" ]; then
            echo "ğŸ§¹ æ¸…ç†ç¼–è¯‘ç¼“å­˜..."
            rm -rf openwrt-src
          fi
        # ä»…åœ¨æºç åˆ†æ”¯ä¸ä»“åº“é»˜è®¤åˆ†æ”¯ä¸åŒæ—¶æ¸…ç†ï¼ˆé¿å…é‡å¤ä¸‹è½½ï¼‰
        if: ${{ github.event.inputs.source_branch != github.event.repository.default_branch }}
