name: OpenWrt全功能动态编译系统（自动生成）

on:
  workflow_dispatch:
    inputs:
      select_mode:
        type: choice
        description: 编译模式（设备/芯片）
        required: true
        options: [device, chip]

      device:
        type: choice
        description: 设备型号（仅设备模式）
        required: false
        options: [1,1200,15w-rev1,20,200d,2533dhp,2610,3000,301w,303,303h,329acn,32m,330,360t7,360v6,365,4,4040,421e,5950ax12,6,60ad,7530,79f,7links-px-4885-4m,7links-px-4885-8m,7links-wlr-1230,7links-wlr-1240,8dev-carambola2,8dev-carambola3,8dev-lima,8dev-rambutan,8devices-carambola,SDG-841-t6,SDG-8612,SDG-8614,SDG-8622,SDG-8632,SDG-8733,SDG-8733A,SDG-8734,a10-stock,a10-ubootmod,a1300,a42,a6004mx,a62,a8000ru,ac,ac-hd,ac-lte,ac2,ac2200,ac3,ac3-lte6-kit,ac400i,ac42u,ac58u,accton-wr6202,ad1018,ad7200,adslr-g7,adtran-bsap1800-v2,adtran-bsap1840,aerohive-hiveap-121,afoundry-ew1200,aigale-ai-br100,airlink101-ar670w,airlink101-ar725w,airlive-air3gii,airtight-c-75,alcatel-hh40v,allnet-all-sg8208m,allnet-all-wap02860ac,allnet-all0256n-4m,allnet-all0256n-8m,allnet-all0333cj,allnet-all5002,allnet-all5003,alphanetworks-asl26555-16m,alphanetworks-asl26555-8m,alphanetworks-asl56026,ampedwireless-ally-00x19k,ampedwireless-ally-r1900k,ampedwireless-b1200ex,ap120c-ac,ap120c-ax,ap1300,ap148,ap161,ap3000-v1,ap3000outdoor-v1,ap3710i,ap3715i,ap3825i,ap3915i,ap391x,ap3935,ap8220,apresia-aplgs120gtss,aquila-pro-ai-m30-a1,aquila-pro-ai-m60-a1,ar-5315u,ar-5381u,ar-5387un,ar7516,araknis-an-300-ap-i-n,araknis-an-500-ap-i-ac,araknis-an-700-ap-i-ac,arcadyan-arv4510pw,arcadyan-arv4518pwr01,arcadyan-arv4518pwr01a,arcadyan-arv4519pw,arcadyan-arv4520pw,arcadyan-arv4525pw,arcadyan-arv452cqw,arcadyan-arv7506pw11,arcadyan-arv7510pw22,arcadyan-arv7518pw,arcadyan-arv7519pw,arcadyan-arv7519rw22,arcadyan-arv7525pw,arcadyan-arv752dpw,arcadyan-arv752dpw22,arcadyan-arv8539pw22,arcadyan-vg3503j,arcadyan-vgv7510kw22-brn,arcadyan-vgv7510kw22-nor,arcadyan-vgv7519-brn,arcadyan-vgv7519-nor,arcadyan-vrv9510kwac23,arcadyan-we410443,arcadyan-we420223-99,archer-ax80-v1,arcwireless-freestation5,arduino-yun,argus-atp-52b,aruba-ap-105,aruba-ap-115,aruba-ap-175,asiarf-ap7621-001,asiarf-ap7621-nv1,asiarf-awapn2403,asiarf-awm002-evb-4m,asiarf-awm002-evb-8m,asr3000,asus-4g-ax56,asus-pl-ac56,asus-rp-ac51,asus-rp-ac56,asus-rp-ac66,asus-rp-ac87,asus-rp-n53,asus-rt-ac1200,asus-rt-ac1200-v2,asus-rt-ac51u,asus-rt-ac54u,asus-rt-ac57u-v1,asus-rt-ac59u,asus-rt-ac59u-v2,asus-rt-ac65p,asus-rt-ac85p,asus-rt-ax53u,asus-rt-ax54,asus-rt-g32-b1,asus-rt-n10-plus,asus-rt-n10p-v3,asus-rt-n11p-b1,asus-rt-n12-vp-b1,asus-rt-n12p,asus-rt-n13u,asus-rt-n14u,asus-rt-n15,asus-rt-n56u,asus-rt-n56u-b1,asus-wl-330n,asus-wl-330n3g,asus-zenwifi-cd6n,asus-zenwifi-cd6r,atheros-db120,audiocodes-mp-252,avm-fritz1750e,avm-fritz300e,avm-fritz3370-rev2-hynix,avm-fritz3370-rev2-micron,avm-fritz3390,avm-fritz3490,avm-fritz3490-micron,avm-fritz4020,avm-fritz450e,avm-fritz5490,avm-fritz5490-micron,avm-fritz7312,avm-fritz7320,avm-fritz7360-v2,avm-fritz7360sl,avm-fritz7362sl,avm-fritz7412,avm-fritz7430,avm-fritz7490,avm-fritz7490-micron,avm-fritzdvbc,aw1000,ax1800,ax3000,ax3000-ubootmod,ax3000-v1,ax3000q,ax3000sm,ax3200-e5,ax3600,ax6,ax6000,ax830,ax835,ax880,ax89x,ax9000,aximcom-mr-102n,axt1800,aztech-hw550-3g,b1300,b2200,b3000,bananapi-bpi-rv2-nand,bananapi-bpi-rv2-nor,bdcom-wap2100-sk,beeline-smartbox-flash,beeline-smartbox-giga,beeline-smartbox-pro,beeline-smartbox-turbo,beeline-smartbox-turbo-plus,belkin-f5d8235-v1,belkin-f5d8235-v2,belkin-f7c027,belkin-f9j1108-v2,belkin-f9k1109v1,belkin-f9k1115-v2,belkin-rt1800,bolt-arion,bolt-bl100,bpi-r3-mini,bt-homehub-v2b,bt-homehub-v3a,bt-homehub-v5a,buffalo-bhr-4grv,buffalo-bhr-4grv2,buffalo-ls220de,buffalo-ls421de,buffalo-wbmr-300hpd,buffalo-wbmr-hp-g300h,buffalo-wcr-1166ds,buffalo-whr-1166d,buffalo-whr-300hp2,buffalo-whr-600d,buffalo-whr-g300n,buffalo-whr-g301n,buffalo-wli-tx4-ag300n,buffalo-wmr-300,buffalo-wsr-1166dhp,buffalo-wsr-2533dhpl,buffalo-wsr-2533dhpl2,buffalo-wsr-2533dhpls,buffalo-wsr-600dhp,buffalo-wzr-450hp2,buffalo-wzr-600dhp,buffalo-wzr-agl300nh,buffalo-wzr-hp-ag300h,buffalo-wzr-hp-g300nh-rb,buffalo-wzr-hp-g300nh-s,buffalo-wzr-hp-g302h-a1a0,buffalo-wzr-hp-g450h,c200-v2,c2600,c8-668gl,cax1800,cf-e393ax,cisco-vedge1000,comfast-cf-e110n-v2,comfast-cf-e120a-v3,comfast-cf-e130n-v2,comfast-cf-e313ac,comfast-cf-e314n-v2,comfast-cf-e355ac-v2,comfast-cf-e375ac,comfast-cf-e380ac-v2,comfast-cf-e390ax,comfast-cf-e5,comfast-cf-e560ac,comfast-cf-ew71-v2,comfast-cf-ew72,comfast-cf-ew72-v2,comfast-cf-wr617ac,comfast-cf-wr650ac-v1,comfast-cf-wr650ac-v2,comfast-cf-wr752ac-v1,comfast-cf-wr758ac-v1,comfast-cf-wr758ac-v2,comfast-cf-wr800n,compex-wpj344-16m,compex-wpj531-16m,compex-wpj558-16m,compex-wpj563,confiabits-mt7621-v1,ct3003,cudy-m1200-v1,cudy-m1300-v2,cudy-m1800,cudy-r700,cudy-tr1200-v1,cudy-wr1000,cudy-wr1300-v1,cudy-wr1300-v2,cudy-wr1300-v3,cudy-wr2100,cudy-x6-v1,cudy-x6-v2,d7800,dax3000gr,db149,dell-apl26-0ae,dell-apl27-0b1,devolo-dlan-pro-1200plus-ac,devolo-dvl1200e,devolo-dvl1200i,devolo-dvl1750c,devolo-dvl1750e,devolo-dvl1750i,devolo-dvl1750x,devolo-magic-2-wifi,devolo-rac,dgnd3700-v1,dgnd3700-v2,dgnd3800b,dlink-covr-c1200-a1,dlink-covr-p2500-a1,dlink-covr-x1860-a1,dlink-dap-1325-a1,dlink-dap-1330-a1,dlink-dap-1350,dlink-dap-1365-a1,dlink-dap-1522-a1,dlink-dap-1620-b1,dlink-dap-1720-a1,dlink-dap-2230-a1,dlink-dap-2660-a1,dlink-dap-2680-a1,dlink-dap-2695-a1,dlink-dap-3320-a1,dlink-dap-3662-a1,dlink-dap-x1860-a1,dlink-dch-g020-a1,dlink-dch-m225,dlink-dcs-930,dlink-dcs-930l-b1,dlink-dir-1935-a1,dlink-dir-1960-a1,dlink-dir-2055-a1,dlink-dir-2150-a1,dlink-dir-2150-r1,dlink-dir-2640-a1,dlink-dir-2660-a1,dlink-dir-300-b1,dlink-dir-300-b7,dlink-dir-3040-a1,dlink-dir-3060-a1,dlink-dir-320-b1,dlink-dir-505,dlink-dir-510l,dlink-dir-600-b1,dlink-dir-610-a1,dlink-dir-615-d,dlink-dir-615-e4,dlink-dir-615-h1,dlink-dir-620-a1,dlink-dir-620-d1,dlink-dir-629-a1,dlink-dir-645,dlink-dir-806a-b1,dlink-dir-810l,dlink-dir-825-b1,dlink-dir-825-c1,dlink-dir-835-a1,dlink-dir-842-c1,dlink-dir-842-c2,dlink-dir-842-c3,dlink-dir-853-a1,dlink-dir-853-a3,dlink-dir-853-r1,dlink-dir-859-a1,dlink-dir-859-a3,dlink-dir-860l-b1,dlink-dir-867-a1,dlink-dir-869-a1,dlink-dir-878-a1,dlink-dir-878-r1,dlink-dir-882-a1,dlink-dir-882-r1,dlink-dra-1360-a1,dlink-dwr-116-a1,dlink-dwr-118-a1,dlink-dwr-118-a2,dlink-dwr-512-b,dlink-dwr-921-c1,dlink-dwr-922-e2,dlink-dwr-960,dlink-dwr-961-a1,dna-valokuitu-plus-ex400,dns320l,domywifi-dm202,domywifi-dm203,domywifi-dw22d,domywifi-dw33d,dongwon-dw02-412h-128m,dongwon-dw02-412h-64m,dovado-tiny-ac,dsl-2750b-b1,duzun-dm06,dvk,e2600ac-c1,e2600ac-c2,e8450,e8450-ubi,eDPU,ea0326gmp,ea3500,ea4500,ea6350v3,ea7500-v3,ea8300,ea8500,eagle-pro-ai-m32-a1,eagle-pro-ai-r32-a1,eap102,eap111,eap1300,eap2200,eap620hd-v1,eap623od-hd-v1,eap660hd-v1,easyacc-wizard-8800,ecw5211,ecw5410,edimax-3g-6200n,edimax-3g-6200nl,edimax-br-6208ac-v2,edimax-br-6475nd,edimax-br-6478ac-v2,edimax-ew-7476rpc,edimax-ew-7478ac,edimax-ew-7478apc,edimax-ra21s,edimax-re23s,edimax-rg21s,elecom-wab-i1750-ps,elecom-wab-s1167-ps,elecom-wab-s600-ps,elecom-wmc-m1267gst2,elecom-wmc-s1267gs2,elecom-wmc-x1800gst,elecom-wrc-1167fs,elecom-wrc-1167ghbk2-s,elecom-wrc-1167gs2-b,elecom-wrc-1167gst2,elecom-wrc-1750ghbk2-i,elecom-wrc-1750gs,elecom-wrc-1750gst2,elecom-wrc-1750gsv,elecom-wrc-1900gst,elecom-wrc-2533ghbk-i,elecom-wrc-2533ghbk2-t,elecom-wrc-2533gs2,elecom-wrc-2533gst,elecom-wrc-2533gst2,elecom-wrc-300ghbk2-i,elecom-wrc-x1800gs,elecom-wrh-300cr,elecom-wsc-x1800gs,electronics-x1,embeddedwireless-balin,embeddedwireless-dorin,emd1,emmc,emr3500,engenius-eap1200h,engenius-eap1750h,engenius-eap300-v2,engenius-eap350-v1,engenius-eap600,engenius-ecb1200,engenius-ecb1750,engenius-ecb350-v1,engenius-ecb600,engenius-enh202-v1,engenius-ens1750,engenius-ens202ext-v1,engenius-enstationac-v1,engenius-epg5000,engenius-epg600,engenius-esr-9753,engenius-esr1200,engenius-esr1750,engenius-esr600,engenius-esr600h,engenius-esr900,engenius-ews2910p-v1,engenius-ews2910p-v3,engenius-ews511ap,engenius-ews660ap,ens620ext,enterasys-ws-ap3705i,espressobin-ultra,etactica-eg200,etisalat-s3,evb,evg2000,ew-7886cax,ex5601-t0-stock,ex5601-t0-ubootmod,ex5700-telenor,ex6100v2,ex6150v2,ex6250-v2,fap650,fast-3864-op,firefly-firewrt,fon-fon2601,fon-fonera-20n,fortinet-fap-220-b,fortinet-fap-221-b,fortinet-fap-221-c,fortinet-fg-30e,fortinet-fg-50e,fortinet-fg-51e,fortinet-fg-52e,fortinet-fwf-50e-2r,fortinet-fwf-51e,fr365v1,g10,gdsp,gehua-ghl-r-001,gemtek-wvrtm-127acn,gemtek-wvrtm-130acn,genexis-pulse-ex400,gl-mt2500-v1,gl-mt2500-v2,gl-mt3000,gl-mt6000,gl-mv1000,gl-x3000,gl-xe3000,glinet-6408,glinet-6416,glinet-gl-ar150,glinet-gl-ar300m-lite,glinet-gl-ar300m-nand,glinet-gl-ar300m-nor,glinet-gl-ar300m16,glinet-gl-ar750,glinet-gl-ar750s-nor,glinet-gl-ar750s-nor-nand,glinet-gl-e750,glinet-gl-mifi,glinet-gl-mt1300,glinet-gl-mt300a,glinet-gl-mt300n,glinet-gl-mt300n-v2,glinet-gl-mt750,glinet-gl-s200-nor,glinet-gl-s200-nor-nand,glinet-gl-usb150,glinet-gl-x1200-nor,glinet-gl-x1200-nor-nand,glinet-gl-x300b,glinet-gl-x750,glinet-gl-xe300,glinet-microuter-n300,glinet-vixmini,gnubee-gb-pc1,gnubee-gb-pc2,goflexhome,h3c-magic-nx30-pro,h3c-tx1800-plus,h3c-tx1801-plus,h3c-tx1806,h500-s-lowi,h500-s-vfes,haier-har-20s2u1,hak5-lan-turtle,hak5-packet-squirrel,hak5-wifi-pineapple-mk7,hak5-wifi-pineapple-nano,hame-mpr-a1,hame-mpr-a2,hanyang-hyc-g920,hasivo-s1100w-8xgt-se,hauppauge-broadway,haze,hd-v1,hg100-cellular,hg253s-v2,hg553,hg556a-a,hg556a-b,hg556a-c,hilink-hlk-7621a-evb,hilink-hlk-7628n,hilink-hlk-7688a,hilink-hlk-rm04,hiwifi-hc5611,hiwifi-hc5661,hiwifi-hc5661a,hiwifi-hc5761,hiwifi-hc5761a,hiwifi-hc5861,hiwifi-hc5861b,hiwifi-hc5962,hiwifi-hc6361,hnet-c108,homewrk,hongdian-h8922-v30,hootoo-ht-tm02,hootoo-ht-tm05,hpe-1920-16g,hpe-1920-24g,hpe-1920-24g-poe-180w,hpe-1920-24g-poe-370w,hpe-1920-48g,hpe-1920-48g-poe,hpe-1920-8g,hpe-1920-8g-poe-180w,hpe-1920-8g-poe-65w,huasifei-ws1208v2,huawei-ap5030dn,huawei-ap6010dn,huawei-d105,huawei-hg255d,humax-e10,humax-e2,iij-sa-w2,inaba-aml2-17gp,intenso-memory2move,iodata-bsh-g24mb,iodata-etg3-r,iodata-wn-ac1167dgr,iodata-wn-ac1167gr,iodata-wn-ac1600dgr,iodata-wn-ac1600dgr2,iodata-wn-ac733gr3,iodata-wn-ag300dgr,iodata-wn-ax1167gr,iodata-wn-ax1167gr2,iodata-wn-ax2033gr,iodata-wn-deax1800gr,iodata-wn-dx1167r,iodata-wn-dx1200gr,iodata-wn-dx2033gr,iodata-wn-gx300gr,iodata-wnpr2600g,ipq40x9-dr40x9,iptime-a1004ns,iptime-a104ns,iptime-a3,iptime-a3002mesh,iptime-a3004ns-dual,iptime-a3004t,iptime-a6004ns-m,iptime-a604m,iptime-a6ns-m,iptime-a8004t,iptime-ax2004m,iptime-t5004,jalapeno,jcg-jhr-ac876m,jcg-jhr-n805r,jcg-jhr-n825r,jcg-jhr-n926r,jcg-q20,jcg-y2,jdcloud-re-cp-02,jdcloud-re-sp-01b,jjplus-ja76pf2,jjplus-jwap230,jotale-js76x8-16m,jotale-js76x8-32m,jotale-js76x8-8m,joyit-jt-or750i,keenetic-kn-1112,keenetic-kn-1212,keenetic-kn-1221,keenetic-kn-1613,keenetic-kn-1711,keenetic-kn-1713,keenetic-kn-1910,keenetic-kn-3010,keenetic-kn-3211,keenetic-kn-3510,kimax-u25awf-h1,kimax-u35wf,kingston-mlw221,kingston-mlwg2,kn-3811,kn-3911,kroks-kndrt31r16,kroks-kndrt31r19,kuwfi-c910,kuwfi-n650,lantiq-easy50712,lantiq-easy80920-nand,lantiq-easy80920-nor,lantiq-easy88388,lantiq-easy88444,lantiq-easy98000-nand,lantiq-easy98000-nor,lantiq-easy98000-sflash,lantiq-easy98020,lantiq-easy98020-v18,lantiq-easy98021,lantiq-easy98035synce,lantiq-easy98035synce1588,lantiq-falcon-mdu,lantiq-falcon-sfp,lava-lr-25g001,lbr20,le1,lenovo-newifi-d1,lenovo-newifi-y1,lenovo-newifi-y1s,letv-lba-047-ch,librerouter-librerouter-v1,link-bl-w1200,link-dgs-1210-10mp-f,link-dgs-1210-10p,link-dgs-1210-16,link-dgs-1210-20,link-dgs-1210-26,link-dgs-1210-28,link-dgs-1210-28mp-f,link-dgs-1210-28p-f,link-dgs-1210-52,link-td-w8968-v3,linksys-e1700,linksys-e5400,linksys-e5600,linksys-e7350,linksys-ea4500-v3,linksys-ea6350-v4,linksys-ea7300-v1,linksys-ea7300-v2,linksys-ea7500-v2,linksys-ea8100-v1,linksys-ea8100-v2,linksys-lgs310c,linksys-re6500,linksys-re7000,linksys-venom,loewe-wmdr-143n,longdata-aps256,m2133hp,m300,m3000-v1,m901,m902,maginon-mc-1200ac,mediatek-ap-mt7621a-v60,mediatek-linkit-smart-7688,mediatek-mt7621-eval-board,mediatek-mt7628an-eval-board,meig-slt866,meraki-mr12,meraki-mr16,meraki-mr18,mercury-mac1200r-v2,mercury-mw4530r-v1,mercusys-mb130-4g-v1,mercusys-mr70x-v1,mf18a,mf269,mf282plus,mf286d,mf287,mf287plus,mf287pro,mf289f,mi-router-ax3000t,mi-router-ax3000t-ubootmod,mi-router-wr30u-stock,mi-router-wr30u-ubootmod,microduino-microwrt,mikrotik-ltap-2hnd,mikrotik-routerboard-2011uias-2hnd,mikrotik-routerboard-493g,mikrotik-routerboard-750-r2,mikrotik-routerboard-750gr3,mikrotik-routerboard-760igs,mikrotik-routerboard-911-lite,mikrotik-routerboard-911g-5hpacd,mikrotik-routerboard-911g-xhpnd,mikrotik-routerboard-912uag-2hpnd,mikrotik-routerboard-921gs-5hpacd-15s,mikrotik-routerboard-922uags-5hpacd,mikrotik-routerboard-951g-2hnd,mikrotik-routerboard-951ui-2hnd,mikrotik-routerboard-951ui-2nd,mikrotik-routerboard-952ui-5ac2nd,mikrotik-routerboard-962uigs-5hact2hnt,mikrotik-routerboard-lhg-2nd,mikrotik-routerboard-lhg-5nd,mikrotik-routerboard-m11g,mikrotik-routerboard-m33g,mikrotik-routerboard-map-2nd,mikrotik-routerboard-mapl-2nd,mikrotik-routerboard-sxt-5nd-r2,mikrotik-routerboard-wap-2nd,mikrotik-routerboard-wap-g-5hact2hnd,mikrotik-routerboard-wapr-2nd,minew-g1-c,mochabin,mofinetwork-mofi3500-3gn,mofinetwork-mofi5500-5gxelte,motorola-mwr03,moxa-awk-1137c,mozart,mqmaker-witi,mr24,mr33,mr42,mr52,mr5500,mr7350,mr74,mr7500,mr80x-v3,mr8300,mr90x-v1,mr90x-v1-ubi,msm460,mt7981,mtc-wr1201,mts-wg430223,mx2000,mx4200v1,mx4200v2,mx4300,mx5300,mx5500,mx60,mx8500,mybooklive,n60,n60-pro,nas1,nas1dual,nbg6617,nbg6817,nbg7815,nec-wf1200cr,nec-wg1200cr,nec-wg1400hp,nec-wg1800hp,nec-wg1800hp2,nec-wg2200hp,nec-wg600hp,nec-wg800hp,nec-wr8750n,nec-wr9500n,netcore-nw5212,netcore-nw718,netgear-dgn1000b,netgear-dgn3500,netgear-dgn3500b,netgear-dm200,netgear-eax12,netgear-ex2700,netgear-ex3700,netgear-ex6120,netgear-ex6130,netgear-ex6150,netgear-ex7300,netgear-ex7300-v2,netgear-gs108t-v3,netgear-gs110tpp-v1,netgear-gs110tup-v1,netgear-gs308t-v1,netgear-gs310tp-v1,netgear-gs750e,netgear-jwnr2010-v5,netgear-pgzng1,netgear-pr2000,netgear-r6020,netgear-r6080,netgear-r6100,netgear-r6120,netgear-r6220,netgear-r6260,netgear-r6350,netgear-r6700-v2,netgear-r6800,netgear-r6850,netgear-r6900-v2,netgear-r7200,netgear-r7450,netgear-wac104,netgear-wac124,netgear-wax202,netgear-wax214v2,netgear-wn3000rp-v3,netgear-wn3100rp-v2,netgear-wnce2001,netgear-wndap360,netgear-wndr3700,netgear-wndr3700-v2,netgear-wndr3700-v4,netgear-wndr3700-v5,netgear-wndr3800,netgear-wndr3800ch,netgear-wndr4300,netgear-wndr4300-v2,netgear-wndr4300sw,netgear-wndr4300tn,netgear-wndr4500-v3,netgear-wndrmac-v1,netgear-wndrmac-v2,netgear-wnr1000-v2,netgear-wnr2000-v3,netgear-wnr2200-16m,netgear-wnr2200-8m,netgear-wnr612-v2,netis-n6,netis-wf2770,netis-wf2881,network-ac1200rm,network-ap121f,network-ap121fe,network-awusfree1,network-ax1800rm,network-n2q,network-n5q,network-pi-wifi4,network-quad-e4g,network-r36a,network-r36m-e4g,network-tube-2hq,network-tube-e4g,network-w502u,network-wifi-camppro-nano-duo,networks-ws-ap3805i,nexaira-bc2,nexx-wt1520-4m,nexx-wt1520-8m,nexx-wt3020-4m,nexx-wt3020-8m,nixcore-x1-16m,nixcore-x1-8m,nsa310b,nwa50ax-pro,nx31,oap100,ocedo-koala,ocedo-raccoon,ocedo-ursus,ohyeah-oy-0001,olimex-rt5350f-olinuxino,olimex-rt5350f-olinuxino-evb,omnima-hpm,omnima-miniembplug,omnima-miniembwifi,on-n150r,on100,one,onhub,onion-omega,onion-omega2,onion-omega2p,openfi-5pro,openmesh-a40,openmesh-a60,openmesh-mr1750-v1,openmesh-mr1750-v2,openmesh-mr600-v1,openmesh-mr600-v2,openmesh-mr900-v1,openmesh-mr900-v2,openmesh-om2p-hs-v1,openmesh-om2p-hs-v2,openmesh-om2p-hs-v3,openmesh-om2p-hs-v4,openmesh-om2p-lc,openmesh-om2p-v1,openmesh-om2p-v2,openmesh-om2p-v4,openmesh-om5p,openmesh-om5p-ac-v1,openmesh-om5p-ac-v2,openmesh-om5p-an,oraybox-x1,oraybox-x3a,outdoor,pa1200,pa2200,panasonic-m16eg-pn28160k,panasonic-m24eg-pn28240k,panasonic-m48eg-pn28480k,panasonic-m8eg-pn28080k,panda,pcs-cap324,pcs-cr3000,pcs-cr5000,petatel-psr-680w,phicomm-k2-v22.4,phicomm-k2-v22.5,phicomm-k2g,phicomm-k2p,phicomm-k2t,phicomm-psg1208,phicomm-psg1218b,pisen-ts-d084,pisen-wmb001n,pisen-wmm003n,planex-cs-qr10,planex-db-wrt01,planex-mzk-750dhp,planex-mzk-dp150n,planex-mzk-ex300np,planex-mzk-ex750np,planex-mzk-w300nh2,planex-mzk-wdpr,planex-vr500,plasmacloud-pa300,plasmacloud-pa300e,poray-ip2202,poray-m3,poray-m4-4m,poray-m4-8m,poray-x5,poray-x8,pqi-air-pen,predator-w6,predator-w6d,pro,prolink-pwh2004,q-h721,q30-pro,qca-ap143-16m,qca-ap143-8m,qihoo-c301,qxwlan-e1700ac-v2-16m,qxwlan-e1700ac-v2-8m,qxwlan-e558-v2-16m,qxwlan-e558-v2-8m,qxwlan-e600g-v2-16m,qxwlan-e600g-v2-8m,qxwlan-e600gac-v2-16m,qxwlan-e600gac-v2-8m,qxwlan-e750a-v4-16m,qxwlan-e750a-v4-8m,qxwlan-e750g-v8-16m,qxwlan-e750g-v8-8m,r-ac,r1000h,r5010unv2,r619ac-128m,r619ac-64m,r7500,r7500v2,r7800,raisecom-msg1500-x-00,rakwireless-rak633,ralink-mt7620a-evb,ralink-mt7620a-mt7530-evb,ralink-mt7620a-mt7610e-evb,ralink-mt7620a-v22sg-evb,ralink-v11st-fe,ralink-v22rw-2x2,ravpower-rp-wd009,ravpower-rp-wd03,rax120v2,rax3000m,rb5009,rbr40,rbr50,rbs40,rbs50,re-cp-03,re3000-v1,re6000xd,redmi-router-ax6000-stock,redmi-router-ax6000-ubootmod,redmi-router-ax6s,renkforce-ws-wn530hp3-a,rfb,rg-ew3200gx-pro,rg-x60-pro,rosinson-wr818,rostelecom-rt-fe-1a,rostelecom-rt-fl-1,rostelecom-rt-sf-1,rostelecom-s1010,router-zr-2660,rt-ax52,rt-ax59u,rt4230w-rev6,rtl30vw,ruckus-r500,ruckus-zf7025,ruckus-zf7321,ruckus-zf7341,ruckus-zf7351,ruckus-zf7363,ruckus-zf7372,ruijie-rg-ew1200g-pro-v1.1,rutx10,rutx50,s1300,samknows-whitebox-v8,samsung-cy-swr1100,samsung-wam250,sanlinking-d240,sax1v1k,sercomm-na502,sercomm-na502s,sercomm-na930,shg2500,siemens-gigaset-sx76x,siemens-ws-ap3610,sim-simax1800t,sitecom-wl-351,sitecom-wlr-4100-v1-002,sitecom-wlr-6000,sitecom-wlr-7100,sitecom-wlr-8100,skylab-skw92a,skyline-sl-r7205,snr-cpe-ax2,snr-cpe-w4n-mt,snr-snr-cpe-me1,snr-snr-cpe-me2-lite,snr-snr-cpe-me2-sfp,som7981,sophos-ap100,sophos-ap100c,sophos-ap15,sophos-ap15c,sophos-ap55,sophos-ap55c,sparklan-wcr-150gn,spim-nand,spim-nor,spnmx56,sr505n,srr60,srs60,stora,storylink-sap-g3200u3,sxr80,sxs80,t10,t1200h,tama-w06,team-newifi-d2,team-pbr-d1,team-pbr-m1,telco-t1,teltonika-rut200,teltonika-rut230-v1,teltonika-rut241,teltonika-rut300,teltonika-rut5xx,teltonika-rut955,teltonika-rut955-h7v3c0,teltonika-rut9x1,teltonika-rut9x6,tenbay-t-mb5eu-v01,tenda-3g150b,tenda-3g300m,tenda-w150m,tenda-w306r-v2,thunder-timecloud,tl-xdr4288,tl-xdr6086,tl-xdr6088,tl-xtr8488,totolink-a3,totolink-a7000r,totolink-lr1200,totolink-x5000r,tozed-zlt-s12-pro,tplink-archer-a6-v3,tplink-archer-a7-v5,tplink-archer-a9-v6,tplink-archer-ax23-v1,tplink-archer-c2-v1,tplink-archer-c2-v3,tplink-archer-c20-v1,tplink-archer-c20-v4,tplink-archer-c20-v5,tplink-archer-c20i,tplink-archer-c25-v1,tplink-archer-c5-v1,tplink-archer-c5-v4,tplink-archer-c50-v1,tplink-archer-c50-v3,tplink-archer-c50-v4,tplink-archer-c50-v6,tplink-archer-c58-v1,tplink-archer-c59-v1,tplink-archer-c59-v2,tplink-archer-c6-v2,tplink-archer-c6-v2-us,tplink-archer-c6-v3,tplink-archer-c60-v1,tplink-archer-c60-v2,tplink-archer-c60-v3,tplink-archer-c6u-v1,tplink-archer-c7-v1,tplink-archer-c7-v2,tplink-archer-c7-v4,tplink-archer-c7-v5,tplink-archer-d50-v1,tplink-archer-d7-v1,tplink-archer-d7b-v1,tplink-archer-mr200,tplink-archer-mr200-v5,tplink-archer-mr200-v6,tplink-cpe210-v1,tplink-cpe210-v2,tplink-cpe210-v3,tplink-cpe220-v2,tplink-cpe220-v3,tplink-cpe510-v1,tplink-cpe510-v2,tplink-cpe510-v3,tplink-cpe605-v1,tplink-cpe610-v1,tplink-cpe610-v2,tplink-cpe710-v1,tplink-cpe710-v2,tplink-deco-m4r-v1,tplink-deco-m4r-v4,tplink-deco-s4-v2,tplink-eap225-outdoor-v1,tplink-eap225-outdoor-v3,tplink-eap225-v1,tplink-eap225-v3,tplink-eap225-v4,tplink-eap225-v5,tplink-eap225-wall-v2,tplink-eap235-wall-v1,tplink-eap245-v1,tplink-eap245-v3,tplink-eap613-v1,tplink-eap615-wall-v1,tplink-ec220-g5-v2,tplink-ec330-g5u-v1,tplink-er605-v2,tplink-ex220-v1,tplink-ex220-v2,tplink-mr600-v2-eu,tplink-re200-v1,tplink-re200-v2,tplink-re200-v3,tplink-re200-v4,tplink-re205-v3,tplink-re210-v1,tplink-re220-v2,tplink-re305-v1,tplink-re305-v3,tplink-re350-v1,tplink-re350k-v1,tplink-re355-v1,tplink-re365-v1,tplink-re450-v1,tplink-re450-v2,tplink-re450-v3,tplink-re455-v1,tplink-re500-v1,tplink-re650-v1,tplink-re650-v2,tplink-sg2008p-v1,tplink-sg2210p-v3,tplink-sg2452p-v4,tplink-t1600g-28ts-v3,tplink-tdw8970,tplink-tdw8980,tplink-tl-mr10u,tplink-tl-mr3020-v1,tplink-tl-mr3020-v3,tplink-tl-mr3040-v2,tplink-tl-mr3220-v1,tplink-tl-mr3420-v1,tplink-tl-mr3420-v2,tplink-tl-mr3420-v3,tplink-tl-mr3420-v5,tplink-tl-mr6400-v1,tplink-tl-mr6400-v4,tplink-tl-mr6400-v5,tplink-tl-st1008f-v2,tplink-tl-wa1201-v2,tplink-tl-wa701nd-v1,tplink-tl-wa730re-v1,tplink-tl-wa801nd-v1,tplink-tl-wa801nd-v3,tplink-tl-wa801nd-v4,tplink-tl-wa801nd-v5,tplink-tl-wa830re-v1,tplink-tl-wa850re-v1,tplink-tl-wa850re-v2,tplink-tl-wa860re-v1,tplink-tl-wa901nd-v1,tplink-tl-wa901nd-v2,tplink-tl-wa901nd-v3,tplink-tl-wa901nd-v4,tplink-tl-wa901nd-v5,tplink-tl-wdr3500-v1,tplink-tl-wdr3600-v1,tplink-tl-wdr4300-v1,tplink-tl-wdr4300-v1-il,tplink-tl-wdr4310-v1,tplink-tl-wdr4900-v2,tplink-tl-wdr6500-v2,tplink-tl-wdr7500-v3,tplink-tl-wpa8630-v1,tplink-tl-wpa8630p-v2-int,tplink-tl-wpa8630p-v2.0-eu,tplink-tl-wpa8630p-v2.1-eu,tplink-tl-wpa8631p-v3,tplink-tl-wr1043n-v5,tplink-tl-wr1043nd-v1,tplink-tl-wr1043nd-v2,tplink-tl-wr1043nd-v3,tplink-tl-wr1043nd-v4,tplink-tl-wr1045nd-v2,tplink-tl-wr2543-v1,tplink-tl-wr703n,tplink-tl-wr710n-v1,tplink-tl-wr710n-v2.1,tplink-tl-wr740n-v1,tplink-tl-wr740n-v3,tplink-tl-wr740n-v4,tplink-tl-wr740n-v5,tplink-tl-wr741-v1,tplink-tl-wr741nd-v4,tplink-tl-wr743nd-v1,tplink-tl-wr802n-v1,tplink-tl-wr802n-v2,tplink-tl-wr802n-v4,tplink-tl-wr810n-v1,tplink-tl-wr810n-v2,tplink-tl-wr840n-v4,tplink-tl-wr840n-v5,tplink-tl-wr841-v10,tplink-tl-wr841-v11,tplink-tl-wr841-v12,tplink-tl-wr841-v5,tplink-tl-wr841-v7,tplink-tl-wr841-v8,tplink-tl-wr841-v9,tplink-tl-wr841hp-v2,tplink-tl-wr841hp-v3,tplink-tl-wr841n-v13,tplink-tl-wr841n-v14,tplink-tl-wr842n-v1,tplink-tl-wr842n-v2,tplink-tl-wr842n-v3,tplink-tl-wr842n-v5,tplink-tl-wr850n-v2,tplink-tl-wr902ac-v1,tplink-tl-wr902ac-v3,tplink-tl-wr902ac-v4,tplink-tl-wr940n-v3,tplink-tl-wr940n-v4,tplink-tl-wr940n-v6,tplink-tl-wr941-v2,tplink-tl-wr941-v4,tplink-tl-wr941hp-v1,tplink-tl-wr941n-v7-cn,tplink-tl-wr941nd-v5,tplink-tl-wr941nd-v6,tplink-vr200,tplink-vr200v,tplink-wbs210-v1,tplink-wbs210-v2,tplink-wbs510-v1,tplink-wbs510-v2,tr3000-256mb-v1,tr3000-v1,tr3000-v1-ubootmod,trendnet-tew-638apb-v2,trendnet-tew-673gru,trendnet-tew-691gr,trendnet-tew-692gr,trendnet-tew-714tru,trendnet-tew-810dr,trendnet-tew-823dru,trendnet-tha103ac,tuf-ax4200,tuf-ax6000,u7623-02,u7623-02-emmc-512m,u7981-01-emmc,u7981-01-nand,uDPU,ubi,ubnt-aircube-ac,ubnt-aircube-isp,ubnt-airrouter,ubnt-amplifi-router-hd,ubnt-bullet-ac,ubnt-bullet-m-ar7240,ubnt-bullet-m-ar7241,ubnt-bullet-m-xw,ubnt-edgerouter-4,ubnt-edgerouter-6p,ubnt-edgerouter-lite,ubnt-edgerouter-x,ubnt-edgerouter-x-sfp,ubnt-edgeswitch-5xp,ubnt-edgeswitch-8xp,ubnt-lap-120,ubnt-litebeam-ac-gen2,ubnt-litebeam-m5-xw,ubnt-nanobeam-ac,ubnt-nanobeam-ac-gen2,ubnt-nanobeam-ac-xc,ubnt-nanobridge-m,ubnt-nanostation-ac,ubnt-nanostation-ac-loco,ubnt-nanostation-loco-m,ubnt-nanostation-loco-m-xw,ubnt-nanostation-m,ubnt-nanostation-m-xw,ubnt-picostation-m,ubnt-powerbeam-5ac-500,ubnt-powerbeam-5ac-gen2,ubnt-powerbeam-m2-xw,ubnt-powerbeam-m5-xw,ubnt-powerbridge-m,ubnt-rocket-5ac-lite,ubnt-rocket-m,ubnt-routerstation,ubnt-routerstation-pro,ubnt-uk-ultra,ubnt-unifi-6-lite,ubnt-unifi-ap,ubnt-unifi-ap-lr,ubnt-unifi-ap-outdoor-plus,ubnt-unifi-ap-pro,ubnt-unifi-flexhd,ubnt-unifi-nanohd,ubnt-unifiac-lite,ubnt-unifiac-lr,ubnt-unifiac-mesh,ubnt-unifiac-mesh-pro,ubnt-unifiac-pro,ubnt-usg,ubnt-usw-flex,unbranded-a5-v11,unbranded-wr512-3gn-4m,unbranded-wr512-3gn-8m,unbranded-xdx-rn502j,unielec-u7621-01-16m,unielec-u7621-06-16m,unielec-u7621-06-32m,unielec-u7621-06-64m,unielec-u7628-01-16m,unifi-6-lr-v1,unifi-6-lr-v1-ubootmod,unifi-6-lr-v2,unifi-6-lr-v2-ubootmod,unifi-6-lr-v3,unifi-6-lr-v3-ubootmod,unifi-6-plus,upvel-ur-326n4g,upvel-ur-336un,v-80,v-81,v1,v2,vero-w6m,vg-8050,vh4032n,vimin-vm-s100-0800ms,vocore-vocore-16m,vocore-vocore-8m,vocore-vocore2,vocore-vocore2-lite,vonets-var11n-300,vr-3025u,vr-3025un,vr-3032u,vr2600v,w2-ac2600,w3-wd1200g-eup,w3400v6,wac510,wallys-dr531,wansview-ncs601w,wap-5813n,watchguard-ap100,watchguard-ap200,watchguard-ap300,wavlink-wl-wn530hg4,wavlink-wl-wn531a3,wavlink-wl-wn531a6,wavlink-wl-wn531g3,wavlink-wl-wn531g3-a2,wavlink-wl-wn533a8,wavlink-wl-wn535k1,wavlink-wl-wn570ha1,wavlink-wl-wn570ha2,wavlink-wl-wn573hx1,wavlink-wl-wn575a3,wavlink-wl-wn576a2,wavlink-wl-wn577a2,wavlink-wl-wn578a2,wavlink-wl-wn579x3,wavlink-ws-wn572hp3-4g,wax206,wax214,wax218,wax220,wax610,wax610y,wax620,wax630,wd-cloud-mirror-gen2,wd-mynet-n600,wd-mynet-n750,wd-mynet-wifi-rangeextender,weblink-hdrm200,wevo-11acnas,wevo-air-duo,wevo-w2914ns-v2,wg2600hp,wg2600hp3,wh3000,wh3000-pro,whw01,whw03,whw03v2,widora-neo-16m,widora-neo-32m,wifi,wifi-next,wifire-s1500-nbn,winchannel-wb2000,winstars-ws-wn536p3,winstars-ws-wn583a6,wiznet-wizfi630a,wiznet-wizfi630s,wl-wn573hx3,wl-wn586x3,wndap620,wndap660,wndr4700,wodesys-wd-r1802u,wp,wpj419,wpj428,wpq864,wpq873,wr3000-v1,wr3000e-v1,wr3000h-v1,wr3000k,wr3000s-v1,wrc-2533gent,wrc-x3000gs3,wrc-x3200gst3,wre6606,wrtnode-wrtnode,wrtnode-wrtnode2p,wrtnode-wrtnode2r,wrx36,wsr-2533dhp2,wsr-3200ax4s,x1pro,x3000gs2,x80-5g,xg6846,xiaomi-aiot-ac2350,xiaomi-mi-ra75,xiaomi-mi-router-3-pro,xiaomi-mi-router-3g,xiaomi-mi-router-3g-v2,xiaomi-mi-router-4,xiaomi-mi-router-4a-100m,xiaomi-mi-router-4a-100m-intl,xiaomi-mi-router-4a-100m-intl-v2,xiaomi-mi-router-4a-gigabit,xiaomi-mi-router-4a-gigabit-v2,xiaomi-mi-router-4c,xiaomi-mi-router-4q,xiaomi-mi-router-ac2100,xiaomi-mi-router-cr6606,xiaomi-mi-router-cr6608,xiaomi-mi-router-cr6609,xiaomi-miwifi-3a,xiaomi-miwifi-3c,xiaomi-miwifi-mini,xiaomi-miwifi-nano,xiaomi-redmi-router-ac2100,xiaoyu-xy-c5,xikestor-sks8300-8x,xr450,xr500,xzwifi-creativebox-v1,youhua-wr1200js,youku-x2,youku-yk-l1,youku-yk-l1c,youku-yk-l2,yukai-bocco,yuncore-a770,yuncore-a782,yuncore-a930,yuncore-ax820,yuncore-cpe200,yuncore-cpe830,yuncore-fap640,yuncore-fap690,yuncore-g720,yuncore-m300,yuncore-xd3200,yuncore-xd4200,z800ax,zbt-z8102ax,zbt-z8102ax-v2,zbt-z8103ax,zbtlink-zbt-ape522ii,zbtlink-zbt-cpe102,zbtlink-zbt-wa05,zbtlink-zbt-wd323,zbtlink-zbt-we1026-5g-16m,zbtlink-zbt-we1026-h-32m,zbtlink-zbt-we1226,zbtlink-zbt-we1326,zbtlink-zbt-we2026,zbtlink-zbt-we2426-b,zbtlink-zbt-we3526,zbtlink-zbt-we826-16m,zbtlink-zbt-we826-32m,zbtlink-zbt-we826-e,zbtlink-zbt-wg1602-16m,zbtlink-zbt-wg1602-v04-16m,zbtlink-zbt-wg1602-v04-32m,zbtlink-zbt-wg1608-16m,zbtlink-zbt-wg1608-32m,zbtlink-zbt-wg2626,zbtlink-zbt-wg3526-16m,zbtlink-zbt-wg3526-32m,zbtlink-zbt-wr8305rt,zenwifi-bt8,zenwifi-bt8-ubootmod,ziking-cpe46b,zio-freezio,zorlik-zl5900v2,zte-h201l,zte-mf281,zte-mf282,zte-mf283plus,zte-mf286,zte-mf286a,zte-mf286c,zte-mf286r,zte-q7,zyxel-emg2926-q10a,zyxel-gs1900-10hp,zyxel-gs1900-16,zyxel-gs1900-24-v1,zyxel-gs1900-24e,zyxel-gs1900-24ep,zyxel-gs1900-24hp-v1,zyxel-gs1900-24hp-v2,zyxel-gs1900-48,zyxel-gs1900-8-v1,zyxel-gs1900-8-v2,zyxel-gs1900-8hp-v1,zyxel-gs1900-8hp-v2,zyxel-keenetic,zyxel-keenetic-4g-b,zyxel-keenetic-extra-ii,zyxel-keenetic-lite-b,zyxel-keenetic-lite-iii-a,zyxel-keenetic-omni,zyxel-keenetic-omni-ii,zyxel-keenetic-start,zyxel-keenetic-viva,zyxel-lte3301-plus,zyxel-lte5398-m904,zyxel-lte7490-m904,zyxel-nbg-419n,zyxel-nbg-419n-v2,zyxel-nbg6616,zyxel-nbg6716,zyxel-nr7101,zyxel-nwa1100-nh,zyxel-nwa1121-ni,zyxel-nwa1123-ac,zyxel-nwa1123-ni,zyxel-nwa50ax,zyxel-nwa55axe,zyxel-p-2601hn,zyxel-p-2812hnu-f1,zyxel-p-2812hnu-f3,zyxel-wap6805,zyxel-wsm20,zyxel-xgs1210-12,zyxel-xgs1250-12]

      chip:
        type: choice
        description: 芯片型号（仅芯片模式）
        required: false
        options: [airoha,apm821xx,ath79,bmips,boot,cavium-octeon,fsl,lantiq,marvell,mediatek,qcom,ramips,realtek,siflower]

      source_branch:
        type: choice
        description: 源码分支
        required: true
        options: [openwrt-23.05, openwrt-master, immortalwrt-23.05, immortalwrt-master]

      theme_and_optimization:
        type: choice
        description: 主题+编译优化组合
        required: true
        options:
          - argon-O2-generic
          - argon-O3-armv8
          - argon-O3-x86
          - bootstrap-O2-generic
          - material-Os-generic

      core_features:
        type: choice
        description: 核心功能
        required: true
        options: [ipv6+accel, ipv6-only, accel-only, none]

      packages:
        type: string
        description: 软件包（格式：包1,包2）
        required: false
        default: "openclash,samba,ddns-scripts,luci-app-upnp"

      rootfs_size:
        type: number
        description: 根分区大小(MB，32-2048)
        required: true
        default: 192

      firmware_suffix:
        type: string
        description: 固件后缀（如版本号）
        required: false
        default: "custom"

      run_custom_script:
        type: boolean
        description: 执行自定义初始化脚本
        required: true
        default: true

jobs:
  build-firmware:
    name: 动态编译固件
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
      packages: write

    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 检查设备配置文件
        run: |
          if [ ! -f "device-drivers.json" ]; then
            echo "❌ 错误：未找到 device-drivers.json，请先运行同步工作流"
            exit 1
          fi

      - name: 安装编译依赖
        run: |
          sudo apt update
          sudo apt install -y build-essential libncurses5-dev libncursesw5-dev \
            zlib1g-dev gawk git gettext libssl-dev xsltproc wget unzip python3 jq

      - name: 检测硬件资源
        run: |
          CPU_CORES=$(grep -c ^processor /proc/cpuinfo)
          AVAIL_MEM=$(free -m | awk '/^Mem:/ {print $7}')
          echo "CPU_CORES=$CPU_CORES" >> $GITHUB_ENV
          echo "AVAIL_MEM=$AVAIL_MEM" >> $GITHUB_ENV

      - name: 动态计算编译线程数
        run: |
          OPT_LEVEL=$(echo "${{ github.event.inputs.theme_and_optimization }}" | cut -d'-' -f2)
          ARCH=$(echo "${{ github.event.inputs.theme_and_optimization }}" | cut -d'-' -f3)
          MIN_MEM_PER_THREAD=$([ "$OPT_LEVEL" = "O3" ] && echo 2048 || echo 1024)
          [ "$ARCH" = "armv8" ] && MIN_MEM_PER_THREAD=$((MIN_MEM_PER_THREAD * 12 / 10))
          
          MAX_THREADS_BY_MEM=$((AVAIL_MEM / MIN_MEM_PER_THREAD))
          MAX_THREADS_BY_CPU=${{ env.CPU_CORES }}
          FINAL_THREADS=$((MAX_THREADS_BY_MEM < MAX_THREADS_BY_CPU ? MAX_THREADS_BY_MEM : MAX_THREADS_BY_CPU))
          FINAL_THREADS=$((FINAL_THREADS < 1 ? 1 : FINAL_THREADS))
          
          if [ "$OPT_LEVEL" = "O3" ] && [ "$ARCH" = "armv8" ] && [ $FINAL_THREADS -gt 2 ]; then
            FINAL_THREADS=2
          fi
          
          echo "THREADS=$FINAL_THREADS" >> $GITHUB_ENV

      - name: 解析编译参数
        run: |
          THEME=$(echo "${{ github.event.inputs.theme_and_optimization }}" | cut -d'-' -f1)
          echo "THEME=$THEME" >> $GITHUB_ENV
          echo "CFLAGS=-$(echo "${{ github.event.inputs.theme_and_optimization }}" | cut -d'-' -f2)" >> $GITHUB_ENV
          
          case "${{ github.event.inputs.core_features }}" in
            "ipv6+accel")
              echo "ENABLE_IPV6=true" >> $GITHUB_ENV
              echo "ENABLE_ACCEL=true" >> $GITHUB_ENV
              ;;
            "ipv6-only")
              echo "ENABLE_IPV6=true" >> $GITHUB_ENV
              echo "ENABLE_ACCEL=false" >> $GITHUB_ENV
              ;;
            "accel-only")
              echo "ENABLE_IPV6=false" >> $GITHUB_ENV
              echo "ENABLE_ACCEL=true" >> $GITHUB_ENV
              ;;
            "none")
              echo "ENABLE_IPV6=false" >> $GITHUB_ENV
              echo "ENABLE_ACCEL=false" >> $GITHUB_ENV
              ;;
          esac
          
          packages="${{ github.event.inputs.packages }}"
          common_pkgs=$(echo "$packages" | tr ',' '\n' | grep -v 'luci-app-' | sed 's/^/luci-app-/g' | tr '\n' ' ')
          custom_pkgs=$(echo "$packages" | tr ',' '\n' | grep 'luci-app-' | tr '\n' ' ')
          echo "PACKAGES=$common_pkgs $custom_pkgs" >> $GITHUB_ENV

      - name: 拉取OpenWrt源码（带重试）
        run: |
          fetch_source() {
            local repo=$1 branch=$2 retries=3
            while [ $retries -gt 0 ]; do
              if git clone --depth 1 --branch "$branch" "$repo" openwrt-src; then
                [ -n "$(ls -A openwrt-src)" ] && return 0
              fi
              retries=$((retries - 1))
              echo "⚠️ 重试拉取（剩余$retries次）..."
              rm -rf openwrt-src
              sleep 5
            done
            echo "❌ 源码拉取失败"
            exit 1
          }
          
          case "${{ github.event.inputs.source_branch }}" in
            openwrt-23.05)
              fetch_source "https://git.openwrt.org/openwrt/openwrt.git" "openwrt-23.05"
              ;;
            openwrt-master)
              fetch_source "https://git.openwrt.org/openwrt/openwrt.git" "master"
              ;;
            immortalwrt-23.05)
              fetch_source "https://github.com/immortalwrt/immortalwrt.git" "openwrt-23.05"
              ;;
            immortalwrt-master)
              fetch_source "https://github.com/immortalwrt/immortalwrt.git" "master"
              ;;
          esac
          echo "SRC_DIR=$(pwd)/openwrt-src" >> $GITHUB_ENV

      - name: 初始化源码与主题源
        run: |
          cd "${{ env.SRC_DIR }}"
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          if [ "${{ env.THEME }}" = "argon" ]; then
            echo 'src-git argon https://github.com/jerrykuku/luci-theme-argon.git' >> feeds.conf.default
          elif [ "${{ env.THEME }}" = "material" ]; then
            echo 'src-git material https://github.com/LuttyYang/luci-theme-material.git' >> feeds.conf.default
          fi
          
          if [[ "${{ env.PACKAGES }}" == *"luci-app-openclash"* && 
                ! "${{ github.event.inputs.source_branch }}" == *"immortalwrt"* ]]; then
            echo 'src-git openclash https://github.com/vernesong/OpenClash.git' >> feeds.conf.default
          fi
          
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: 执行自定义初始化脚本
        if: ${{ github.event.inputs.run_custom_script == 'true' }}
        run: |
          cd "${{ env.SRC_DIR }}"
          if [ ! -f "../scripts/custom-init.sh" ]; then
            echo "❌ 错误：自定义脚本不存在"
            exit 1
          fi
          chmod +x ../scripts/custom-init.sh
          ../scripts/custom-init.sh > custom-init.log 2>&1 || {
            cat custom-init.log
            exit 1
          }

      - name: 解析设备/芯片配置
        run: |
          if [ "${{ github.event.inputs.select_mode }}" = "device" ]; then
            info=$(jq --arg dev "${{ github.event.inputs.device }}" '.devices[] | select(.name == $dev)' device-drivers.json)
          else
            chip_info=$(jq --arg c "${{ github.event.inputs.chip }}" '.chips[] | select(.name == $c)' device-drivers.json)
            kernel_target=$(echo "$chip_info" | jq -r '.platform')
            info=$(jq --arg p "$kernel_target" '.devices[] | select(.kernel_target == $p)' device-drivers.json | head -n1)
          fi
          
          kernel_target=$(echo "$info" | jq -r '.kernel_target')
          drivers=$(echo "$info" | jq -r '.drivers[]' | tr '\n' ' ')
          echo "KERNEL_TARGET=$kernel_target" >> $GITHUB_ENV
          echo "DRIVERS=$drivers" >> $GITHUB_ENV

      - name: 生成编译配置文件
        run: |
          cd "${{ env.SRC_DIR }}"
          target=$(echo "${{ env.KERNEL_TARGET }}" | tr '/' '_')
          
          echo "CONFIG_TARGET_$target=y" >> .config
          echo "CONFIG_TARGET_${target}_DEVICE_generic=y" >> .config
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=${{ github.event.inputs.rootfs_size }}" >> .config
          
          for driver in ${{ env.DRIVERS }}; do
            echo "CONFIG_PACKAGE_$driver=y" >> .config
          done
          
          for pkg in ${{ env.PACKAGES }}; do
            echo "CONFIG_PACKAGE_$pkg=y" >> .config
          done
          
          if [ "${{ env.ENABLE_IPV6 }}" = "true" ]; then
            echo "CONFIG_IPV6=y" >> .config
            echo "CONFIG_PACKAGE_ipv6helper=y" >> .config
          else
            echo "# CONFIG_IPV6 is not set" >> .config
          fi
          
          if [ "${{ env.ENABLE_ACCEL }}" = "true" ]; then
            echo "CONFIG_PACKAGE_kmod-nf-flow=y" >> .config
          fi
          
          echo "CONFIG_CFLAGS=${{ env.CFLAGS }}" >> .config
          echo "CONFIG_CXXFLAGS=${{ env.CFLAGS }}" >> .config
          
          echo "CONFIG_PACKAGE_luci-theme-${{ env.THEME }}=y" >> .config
          if [ "${{ env.THEME }}" != "bootstrap" ]; then
            echo "# CONFIG_PACKAGE_luci-theme-bootstrap is not set" >> .config
          fi
          if [ "${{ env.THEME }}" != "argon" ]; then
            echo "# CONFIG_PACKAGE_luci-theme-argon is not set" >> .config
          fi
          if [ "${{ env.THEME }}" != "material" ]; then
            echo "# CONFIG_PACKAGE_luci-theme-material is not set" >> .config
          fi
          
          make defconfig

      - name: 开始编译固件
        run: |
          cd "${{ env.SRC_DIR }}"
          make -j${{ env.THREADS }} V=s 2>&1 | tee compile.log

      - name: 编译错误分析
        if: failure()
        run: |
          cd "${{ env.SRC_DIR }}"
          echo "❌ 编译失败，错误分析："
          
          if grep -q "Killed signal terminated program cc1" compile.log; then
            echo "→ 内存不足（尝试减少线程数）"
          elif grep -q "Package kmod-.* is missing" compile.log; then
            missing_pkg=$(grep "Package kmod-.* is missing" compile.log | head -n1 | awk '{print $2}')
            echo "→ 驱动包 $missing_pkg 不存在（建议切换源码分支）"
          elif grep -q "configuration error: recursive dependency" compile.log; then
            echo "→ 软件包依赖冲突（减少勾选的软件包）"
          else
            echo "→ 未知错误，最后50行日志："
            tail -n 50 compile.log
          fi
          exit 1

      - name: 固件重命名
        run: |
          base_name="${{ github.event.inputs.device || github.event.inputs.chip }}-${{ github.event.inputs.source_branch }}-${{ env.THEME }}"
          firmware_suffix="${{ github.event.inputs.firmware_suffix }}-$(date +%Y%m%d)"
          
          find "${{ env.SRC_DIR }}/bin/targets/" -name "*.bin" -exec sh -c '
            for file do
              filename=$(basename "$file" .bin)
              new_filename="${filename}-${1}.bin"
              mv "$file" "$(dirname "$file")/$new_filename"
            done
          ' _ "$firmware_suffix" \;

      - name: 上传编译成果
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: "${{ github.event.inputs.device || github.event.inputs.chip }}-firmware-${{ github.run_id }}"
          path: |
            ${{ env.SRC_DIR }}/bin/targets/**/*.bin
            ${{ env.SRC_DIR }}/compile.log
            ${{ env.SRC_DIR }}/custom-init.log
          retention-days: 30
          if-no-files-found: error

      - name: 输出固件类型说明
        run: |
          echo "📌 固件类型说明："
          echo "  - 含 'sysupgrade' 的文件：用于设备升级（保留配置）"
          echo "  - 含 'factory' 的文件：用于首次刷写（清空配置）"

      - name: 列出编译成果
        run: |
          find "${{ env.SRC_DIR }}/bin/targets/" -name "*.bin" | grep -E "sysupgrade|factory" | while read -r file; do
            echo "  - $file"
          done

      - name: 固件信息摘要
        run: |
          firmware_path=$(find "${{ env.SRC_DIR }}/bin/targets/" -name "*.bin" | head -n1)
          if [ -n "$firmware_path" ]; then
            echo "📊 固件信息："
            echo "  - 路径：$firmware_path"
            echo "  - 大小：$(du -h "$firmware_path" | awk '{print $1}')"
            echo "  - 适用设备：${{ github.event.inputs.device || github.event.inputs.chip }}"
            echo "  - 源码版本：${{ github.event.inputs.source_branch }}"
            echo "  - 主题：${{ env.THEME }}"
          fi

      - name: 清理编译缓存（版本切换时）
        run: |
          if [ -d "openwrt-src" ]; then
            echo "🧹 清理旧编译目录..."
            rm -rf openwrt-src
          fi
        if: ${{ github.event.inputs.source_branch != github.event.repository.default_branch }}
