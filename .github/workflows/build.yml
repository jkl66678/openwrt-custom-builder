name: å…¨è‡ªå®šä¹‰OpenWrtç¼–è¯‘ç³»ç»Ÿ

on:
  workflow_dispatch:
    inputs:
      # 1. è®¾å¤‡é€‰æ‹©
      device:
        type: choice
        description: 'é€‰æ‹©è®¾å¤‡å‹å·'
        required: true
        options:
          - cuby-tr3000-256mb
          - redmi-ac2100
          - x86_64-generic

      # 2. æºç ä¸å†…æ ¸åˆ†æ”¯
      source_branch:
        type: choice
        description: 'é€‰æ‹©æºç åˆ†æ”¯ï¼ˆå¯¹åº”å†…æ ¸ç‰ˆæœ¬ï¼‰'
        required: true
        options:
          - openwrt-23.05      # å®˜æ–¹ç¨³å®šç‰ˆï¼ˆå†…æ ¸5.15ï¼‰
          - openwrt-master     # å®˜æ–¹å¼€å‘ç‰ˆï¼ˆæœ€æ–°å†…æ ¸ï¼‰
          - immortalwrt-master # å¢å¼ºç‰ˆï¼ˆæœ€æ–°å†…æ ¸ï¼Œé€‚åˆæ–°ç¡¬ä»¶ï¼‰

      # 3. æ ¹åˆ†åŒºå¤§å°
      rootfs_size:
        type: number
        description: 'æ ¹åˆ†åŒºå¤§å°(MBï¼Œå»ºè®®â‰¤é—ªå­˜80%)'
        required: true
        default: 192  # 256MBé—ªå­˜æ¨èå€¼

      # 4. å†…æ ¸åŠŸèƒ½é…ç½®
      enable_ipv6:
        type: boolean
        description: 'å¯ç”¨IPv6æ”¯æŒ'
        required: true
        default: true

      enable_hardware_accel:
        type: boolean
        description: 'å¯ç”¨ç¡¬ä»¶åŠ é€Ÿï¼ˆæå‡ç½‘ç»œæ€§èƒ½ï¼‰'
        required: true
        default: true

      # 5. è½¯ä»¶åŒ…ç®¡ç†
      extra_packages:
        type: checkbox
        description: 'å¸¸ç”¨è½¯ä»¶åŒ…ï¼ˆå¯å¤šé€‰ï¼‰'
        options:
          - luci-app-openclash   # ç§‘å­¦ä¸Šç½‘
          - luci-app-samba       # ç½‘ç»œå…±äº«
          - luci-app-ddns        # åŠ¨æ€DNS
          - luci-app-adblock     # å¹¿å‘Šæ‹¦æˆª
          - luci-app-vlmcsd      # KMSæ¿€æ´»

      custom_packages:
        type: string
        description: 'è‡ªå®šä¹‰è½¯ä»¶åŒ…ï¼ˆç©ºæ ¼åˆ†éš”ï¼Œå¦‚luci-app-wireguardï¼‰'
        required: false
        default: ''

      remove_packages:
        type: string
        description: 'ç§»é™¤é¢„è£…åŒ…ï¼ˆç©ºæ ¼åˆ†éš”ï¼Œå¦‚luci-theme-bootstrapï¼‰'
        required: false
        default: ''

      # 6. ç¼–è¯‘ä¼˜åŒ–
      compiler_optimization:
        type: choice
        description: 'ç¼–è¯‘å™¨ä¼˜åŒ–çº§åˆ«'
        required: true
        options:
          - O2  # å¹³è¡¡ï¼ˆæ¨èï¼‰
          - O3  # é«˜æ€§èƒ½ï¼ˆé€‚åˆx86/å¼ºæ€§èƒ½è®¾å¤‡ï¼‰
          - Os  # æœ€å°ä½“ç§¯ï¼ˆé€‚åˆå°é—ªå­˜è®¾å¤‡ï¼‰

      cpu_optimization:
        type: choice
        description: 'CPUæ¶æ„ä¼˜åŒ–'
        required: true
        options:
          - generic  # é€šç”¨å…¼å®¹
          - armv8-a  # é€‚ç”¨äºMT7981ç­‰ARMv8è®¾å¤‡
          - x86-64   # é€‚ç”¨äºx86è½¯è·¯ç”±

      # 7. å›ºä»¶æ ‡è¯†
      firmware_suffix:
        type: string
        description: 'å›ºä»¶åç¼€ï¼ˆå¦‚ç‰ˆæœ¬å·/ç”¨é€”ï¼‰'
        required: false
        default: 'custom'

      # 8. é«˜çº§è‡ªå®šä¹‰
      run_custom_script:
        type: boolean
        description: 'æ‰§è¡Œè‡ªå®šä¹‰åˆå§‹åŒ–è„šæœ¬ï¼ˆä¿®æ”¹IP/ä¸»æœºåç­‰ï¼‰'
        required: true
        default: true


jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: ç¼–è¯‘å‰è‡ªæ£€ï¼ˆå…³é”®é”™è¯¯æ£€æŸ¥ï¼‰
        id: pre_check
        run: |
          # æ£€æŸ¥1ï¼šè®¾å¤‡æ˜¯å¦åœ¨æ˜ å°„è¡¨ä¸­
          device="${{ github.event.inputs.device }}"
          if ! jq --arg dev "$device" '.devices[] | select(.name == $dev)' device-drivers.json &> /dev/null; then
            echo "âŒ é”™è¯¯ï¼ˆErrorï¼‰ï¼šè®¾å¤‡ $device æœªåœ¨æ˜ å°„è¡¨ä¸­å®šä¹‰"
            echo "   è§£å†³æ–¹æ¡ˆï¼ˆSolutionï¼‰ï¼šåœ¨device-drivers.jsonä¸­æ·»åŠ è¯¥è®¾å¤‡é…ç½®"
            exit 1
          fi

          # æ£€æŸ¥2ï¼šè‡ªå®šä¹‰è„šæœ¬æ˜¯å¦å­˜åœ¨ï¼ˆè‹¥å¯ç”¨ï¼‰
          if [ "${{ github.event.inputs.run_custom_script }}" = "true" ] && [ ! -f "scripts/custom-init.sh" ]; then
            echo "âŒ é”™è¯¯ï¼ˆErrorï¼‰ï¼šæœªæ‰¾åˆ°è‡ªå®šä¹‰è„šæœ¬ scripts/custom-init.sh"
            echo "   è§£å†³æ–¹æ¡ˆï¼ˆSolutionï¼‰ï¼šåˆ›å»ºè¯¥æ–‡ä»¶æˆ–ç¦ç”¨run_custom_scripté€‰é¡¹"
            exit 1
          fi

          # æ£€æŸ¥3ï¼šåˆ†åŒºå¤§å°æ˜¯å¦åˆç†ï¼ˆâ‰¤2048MBï¼Œé¿å…æ— æ•ˆå€¼ï¼‰
          if [ ${{ github.event.inputs.rootfs_size }} -gt 2048 ]; then
            echo "âŒ é”™è¯¯ï¼ˆErrorï¼‰ï¼šæ ¹åˆ†åŒºå¤§å°è¶…è¿‡2048MBï¼Œå¯èƒ½æ— æ•ˆ"
            echo "   è§£å†³æ–¹æ¡ˆï¼ˆSolutionï¼‰ï¼šè®¾ç½®ä¸ºè®¾å¤‡é—ªå­˜å®¹é‡çš„80%ä»¥ä¸‹"
            exit 1
          fi

          echo "âœ… è‡ªæ£€é€šè¿‡ï¼ˆPre-build check passedï¼‰"

      - name: æ‹‰å–é€‰æ‹©çš„æºç åˆ†æ”¯
        run: |
          # æ ¹æ®é€‰æ‹©çš„åˆ†æ”¯æ‹‰å–å¯¹åº”ä»“åº“
          case "${{ github.event.inputs.source_branch }}" in
            openwrt-23.05)
              REPO_URL="https://git.openwrt.org/openwrt/openwrt.git"
              BRANCH="openwrt-23.05"
              ;;
            openwrt-master)
              REPO_URL="https://git.openwrt.org/openwrt/openwrt.git"
              BRANCH="master"
              ;;
            immortalwrt-master)
              REPO_URL="https://github.com/immortalwrt/immortalwrt.git"
              BRANCH="master"
              ;;
          esac

          # å…‹éš†æºç å¹¶åˆ‡æ¢åˆ†æ”¯
          git clone --depth 1 $REPO_URL source
          cd source
          git checkout $BRANCH
          echo "REPO_DIR=source" >> $GITHUB_ENV

      - name: åˆå§‹åŒ–æºç ä¸Feeds
        run: |
          cd ${{ env.REPO_DIR }}
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: æ·»åŠ ç¬¬ä¸‰æ–¹è½¯ä»¶æºï¼ˆä¸»é¢˜/æ’ä»¶ï¼‰
        run: |
          cd ${{ env.REPO_DIR }}
          # æ·»åŠ Argonä¸»é¢˜ï¼ˆè‹¥é€‰æ‹©è¯¥ä¸»é¢˜ï¼Œåç»­é…ç½®ä¼šå¯ç”¨ï¼‰
          echo 'src-git argon https://github.com/jerrykuku/luci-theme-argon.git' >> feeds.conf.default

          # æ·»åŠ OpenClashï¼ˆè‹¥å‹¾é€‰ä¸”éImmortalWrtåˆ†æ”¯ï¼‰
          if [[ "${{ github.event.inputs.extra_packages }}" == *"luci-app-openclash"* && 
                "${{ github.event.inputs.source_branch }}" != "immortalwrt-master" ]]; then
            echo 'src-git openclash https://github.com/vernesong/OpenClash.git' >> feeds.conf.default
          fi

          # é‡æ–°æ›´æ–°Feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: æ‰§è¡Œè‡ªå®šä¹‰åˆå§‹åŒ–è„šæœ¬ï¼ˆå¦‚å¯ç”¨ï¼‰
        if: ${{ github.event.inputs.run_custom_script == 'true' }}
        run: |
          cd ${{ env.REPO_DIR }}
          # æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬ï¼ˆä¿®æ”¹é»˜è®¤IPã€ä¸»æœºåç­‰ï¼‰
          bash ../scripts/custom-init.sh
          echo "âœ… è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œå®Œæˆ"

      - name: è§£æè®¾å¤‡é©±åŠ¨ä¸å†…æ ¸ç›®æ ‡
        run: |
          device="${{ github.event.inputs.device }}"
          DEVICE_JSON=$(jq --arg dev "$device" '.devices[] | select(.name == $dev)' ../device-drivers.json)
          
          # æå–å†…æ ¸ç›®æ ‡è·¯å¾„å’Œé©±åŠ¨åˆ—è¡¨
          echo "KERNEL_TARGET=$(echo "$DEVICE_JSON" | jq -r '.kernel_target')" >> $GITHUB_ENV
          echo "DRIVERS=$(echo "$DEVICE_JSON" | jq -r '.drivers[]' | tr '\n' ' ')" >> $GITHUB_ENV

      - name: ç”Ÿæˆå®Œæ•´é…ç½®æ–‡ä»¶ï¼ˆå«æ‰€æœ‰è‡ªå®šä¹‰é€‰é¡¹ï¼‰
        run: |
          cd ${{ env.REPO_DIR }}
          TARGET="${{ env.KERNEL_TARGET }}"
          TARGET_VAR=$(echo "$TARGET" | tr '/' '_')  # è½¬æ¢è·¯å¾„æ ¼å¼ï¼ˆå¦‚mediatek/filogic â†’ mediatek_filogicï¼‰

          # 1. è®¾å¤‡ç›®æ ‡é…ç½®
          echo "CONFIG_TARGET_$TARGET_VAR=y" >> .config
          echo "CONFIG_TARGET_${TARGET_VAR}_DEVICE_generic=y" >> .config

          # 2. è®¾å¤‡é©±åŠ¨ï¼ˆè‡ªåŠ¨åŒ¹é…ï¼‰
          for driver in ${{ env.DRIVERS }}; do
            echo "CONFIG_PACKAGE_$driver=y" >> .config
          done

          # 3. æ ¹åˆ†åŒºå¤§å°
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=${{ github.event.inputs.rootfs_size }}" >> .config

          # 4. å†…æ ¸åŠŸèƒ½é…ç½®ï¼ˆIPv6/ç¡¬ä»¶åŠ é€Ÿï¼‰
          if [ "${{ github.event.inputs.enable_ipv6 }}" = "true" ]; then
            echo "CONFIG_IPV6=y" >> .config
            echo "CONFIG_PACKAGE_ipv6helper=y" >> .config
          else
            echo "# CONFIG_IPV6 is not set" >> .config
          fi

          if [ "${{ github.event.inputs.enable_hardware_accel }}" = "true" ]; then
            echo "CONFIG_PACKAGE_kmod-nf-flow=y" >> .config  # Flow Offload
            echo "CONFIG_PACKAGE_kmod-mt7981-firmware-5g=y" >> .config  # MT7981 5GåŠ é€Ÿ
          fi

          # 5. è½¯ä»¶åŒ…é…ç½®ï¼ˆæ·»åŠ /ç§»é™¤ï¼‰
          # 5.1 å‹¾é€‰çš„å¸¸ç”¨åŒ…
          for pkg in ${{ github.event.inputs.extra_packages }}; do
            echo "CONFIG_PACKAGE_$pkg=y" >> .config
          done
          # 5.2 è‡ªå®šä¹‰åŒ…
          if [ -n "${{ github.event.inputs.custom_packages }}" ]; then
            for pkg in ${{ github.event.inputs.custom_packages }}; do
              echo "CONFIG_PACKAGE_$pkg=y" >> .config
            done
          fi
          # 5.3 ç§»é™¤é¢„è£…åŒ…
          if [ -n "${{ github.event.inputs.remove_packages }}" ]; then
            for pkg in ${{ github.event.inputs.remove_packages }}; do
              echo "# CONFIG_PACKAGE_$pkg is not set" >> .config
            done
          fi

          # 6. ç¼–è¯‘ä¼˜åŒ–é…ç½®
          echo "CONFIG_CFLAGS=-${{ github.event.inputs.compiler_optimization }}" >> .config
          echo "CONFIG_CXXFLAGS=-${{ github.event.inputs.compiler_optimization }}" >> .config
          
          case "${{ github.event.inputs.cpu_optimization }}" in
            armv8-a)
              echo "CONFIG_TARGET_OPTIMIZATION=-march=armv8-a -mtune=cortex-a53" >> .config
              ;;
            x86-64)
              echo "CONFIG_TARGET_OPTIMIZATION=-march=x86-64 -mtune=generic -msse2" >> .config
              ;;
          esac

          # 7. åŸºç¡€é…ç½®ï¼ˆWebç•Œé¢/ä¸»é¢˜ï¼‰
          echo "CONFIG_PACKAGE_luci=y" >> .config  # å¯ç”¨LuCI Webç•Œé¢
          echo "CONFIG_PACKAGE_luci-ssl=y" >> .config  # å¯ç”¨HTTPS
          echo "CONFIG_PACKAGE_luci-theme-argon=y" >> .config  # é»˜è®¤ä½¿ç”¨Argonä¸»é¢˜
          echo "# CONFIG_PACKAGE_luci-theme-bootstrap is not set" >> .config  # ç¦ç”¨é»˜è®¤ä¸»é¢˜

          # è‡ªåŠ¨è¡¥å…¨ä¾èµ–é…ç½®
          make defconfig

      - name: ç¼–è¯‘å›ºä»¶ï¼ˆå¸¦é”™è¯¯æ•è·ï¼‰
        run: |
          cd ${{ env.REPO_DIR }}
          # è®°å½•ç¼–è¯‘æ—¥å¿—ï¼Œä¾¿äºé”™è¯¯æ’æŸ¥
          make -j$([ "${{ github.event.inputs.compiler_optimization }}" = "O3" ] && echo 1 || echo 2) V=s 2>&1 | tee compile.log

          # æ£€æŸ¥ç¼–è¯‘æ˜¯å¦æˆåŠŸï¼Œå¤±è´¥åˆ™åˆ†æé”™è¯¯
          if [ $? -ne 0 ]; then
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼ˆCompilation failedï¼‰"
            # é”™è¯¯1ï¼šå†…å­˜ä¸è¶³
            if grep -q "Killed signal terminated program cc1" compile.log; then
              echo "   åŸå› ï¼ˆReasonï¼‰ï¼šå†…å­˜ä¸è¶³ï¼ˆOut of memoryï¼‰"
              echo "   è§£å†³æ–¹æ¡ˆï¼ˆSolutionï¼‰ï¼šå°†ç¼–è¯‘å‘½ä»¤æ”¹ä¸ºå•çº¿ç¨‹ï¼ˆmake -j1ï¼‰"
            # é”™è¯¯2ï¼šé©±åŠ¨åŒ…ä¸å­˜åœ¨
            elif grep -q "Package kmod-.* is missing" compile.log; then
              missing_pkg=$(grep "Package kmod-.* is missing" compile.log | awk '{print $2}' | head -n1)
              echo "   åŸå› ï¼ˆReasonï¼‰ï¼šé©±åŠ¨åŒ… $missing_pkg ä¸å­˜åœ¨ï¼ˆDriver not foundï¼‰"
              echo "   è§£å†³æ–¹æ¡ˆï¼ˆSolutionï¼‰ï¼š1. æ£€æŸ¥è®¾å¤‡é©±åŠ¨æ˜ å°„è¡¨ï¼›2. åˆ‡æ¢åˆ°immortalwrt-masteråˆ†æ”¯"
            # é”™è¯¯3ï¼šè½¯ä»¶åŒ…å†²çª
            elif grep -q "configuration error: recursive dependency detected" compile.log; then
              echo "   åŸå› ï¼ˆReasonï¼‰ï¼šè½¯ä»¶åŒ…å†²çªï¼ˆPackage conflictï¼‰"
              echo "   è§£å†³æ–¹æ¡ˆï¼ˆSolutionï¼‰ï¼šå‡å°‘å‹¾é€‰çš„é¢å¤–è½¯ä»¶åŒ…ï¼Œé¿å…åŠŸèƒ½å†²çª"
            # å…¶ä»–é”™è¯¯
            else
              echo "   åŸå› ï¼ˆReasonï¼‰ï¼šæœªçŸ¥é”™è¯¯ï¼ˆUnknown errorï¼‰"
              echo "   è¯¦ç»†æ—¥å¿—ï¼ˆDetailed logï¼‰ï¼š"
              tail -n 50 compile.log
            fi
            exit 1
          fi

      - name: è‡ªå®šä¹‰å›ºä»¶åç§°å¹¶ä¸Šä¼ 
        run: |
          # ç”Ÿæˆå›ºä»¶åç§°ï¼šè®¾å¤‡-åˆ†æ”¯-æ—¥æœŸ-åç¼€ï¼ˆå¦‚cuby-tr3000-immortalwrt-20250728-gaming.binï¼‰
          firmware_name="${{ github.event.inputs.device }}-${{ github.event.inputs.source_branch }}-$(date +%Y%m%d)-${{ github.event.inputs.firmware_suffix }}"
          
          # é‡å‘½åå›ºä»¶æ–‡ä»¶
          find ${{ env.REPO_DIR }}/bin/targets/ -name "*.bin" -exec mv {} {}-$firmware_name.bin \;

        uses: actions/upload-artifact@v3
        with:
          name: ${{ env.firmware_name }}
          path: ${{ env.REPO_DIR }}/bin/targets/**/*.bin
      
      - name: éªŒè¯å›ºä»¶å®Œæ•´æ€§
        run: |
          # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆæœ‰æ•ˆå›ºä»¶æ–‡ä»¶
          firmware_count=$(find ${{ env.SRC_DIR }}/bin/targets/ -name "*.bin" | wc -l)
          if [ $firmware_count -eq 0 ]; then
            echo "âŒ é”™è¯¯ï¼šæœªç”Ÿæˆä»»ä½•å›ºä»¶æ–‡ä»¶"
            exit 1
          fi
          echo "âœ… å›ºä»¶ç”ŸæˆæˆåŠŸï¼Œå…± $firmware_count ä¸ªæ–‡ä»¶"

      - name: è¾“å‡ºå›ºä»¶ä¿¡æ¯
        run: |
          # æ˜¾ç¤ºå›ºä»¶è·¯å¾„å’Œå¤§å°
          echo "ğŸ“¦ å›ºä»¶ä¿¡æ¯ï¼š"
          find ${{ env.SRC_DIR }}/bin/targets/ -name "*.bin" -exec ls -lh {} \;

      - name: ä¸Šä¼ å›ºä»¶åˆ°GitHub Artifactsï¼ˆæœ€ç»ˆæ­¥éª¤ï¼‰
        uses: actions/upload-artifact@v3
        with:
          name: ${{ github.event.inputs.device }}-firmware-${{ github.sha }}
          path: ${{ env.SRC_DIR }}/bin/targets/**/*.bin
          retention-days: 30  # å›ºä»¶ä¿ç•™30å¤©ï¼Œå¯æŒ‰éœ€è°ƒæ•´
