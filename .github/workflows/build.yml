# .github/workflows/build.yml
name: OpenWrtå›ºä»¶ç¼–è¯‘ï¼ˆä»…ç¼–è¯‘ï¼‰

on:
  workflow_dispatch:
    inputs:
      # 1. ç¼–è¯‘æ¨¡å¼é€‰æ‹©
      select_mode:
        type: choice
        description: ç¼–è¯‘æ¨¡å¼ï¼ˆè®¾å¤‡/èŠ¯ç‰‡ï¼‰
        required: true
        options: [device, chip]

      # 2. è®¾å¤‡é€‰æ‹©ï¼ˆä»…è®¾å¤‡æ¨¡å¼ï¼Œé€‰é¡¹ä¼šè¢«sync.ymlè‡ªåŠ¨æ›´æ–°ï¼‰
      devices:
        description: "é€‰æ‹©è®¾å¤‡"
        required: true
        type: choice
        options: [test-device]  # AUTO-SYNC-DEVICES

      # 3. èŠ¯ç‰‡é€‰æ‹©ï¼ˆä»…èŠ¯ç‰‡æ¨¡å¼ï¼Œé€‰é¡¹ä¼šè¢«sync.ymlè‡ªåŠ¨æ›´æ–°ï¼‰
      chips:
      description: "é€‰æ‹©èŠ¯ç‰‡"
      required: true
      type: choice
      options: [test-chip]  # AUTO-SYNC-CHIPS

      # 4. æºç ç‰ˆæœ¬
      source_branch:
        type: choice
        description: æºç åˆ†æ”¯
        required: true
        options: [openwrt-23.05, openwrt-master, immortalwrt-23.05, immortalwrt-master]

      # 5. ä¸»é¢˜+ç¼–è¯‘ä¼˜åŒ–ç»„åˆ
      theme_and_optimization:
        type: choice
        description: ä¸»é¢˜+ä¼˜åŒ–ç»„åˆ
        required: true
        options:
          - argon-O2-generic
          - argon-O3-armv8
          - argon-O3-x86
          - bootstrap-O2-generic
          - material-Os-generic

      # 6. æ ¸å¿ƒåŠŸèƒ½é…ç½®
      core_features:
        type: choice
        description: æ ¸å¿ƒåŠŸèƒ½
        required: true
        options: [ipv6+accel, ipv6-only, accel-only, none]

      # 7. è½¯ä»¶åŒ…ç®¡ç†
      packages:
        type: string
        description: è½¯ä»¶åŒ…ï¼ˆæ ¼å¼ï¼šåŒ…1,åŒ…2ï¼‰
        required: false
        default: "openclash,samba,ddns-scripts"

      # 8. æ ¹åˆ†åŒºå¤§å°
      rootfs_size:
        type: number
        description: æ ¹åˆ†åŒºå¤§å°(MBï¼Œ32-2048)
        required: true
        default: 192

      # 9. å›ºä»¶æ ‡è¯†
      firmware_suffix:
        type: string
        description: å›ºä»¶åç¼€ï¼ˆå¦‚ç‰ˆæœ¬å·ï¼‰
        required: false
        default: "custom"

      # 10. é«˜çº§é€‰é¡¹
      run_custom_script:
        type: boolean
        description: æ‰§è¡Œè‡ªå®šä¹‰åˆå§‹åŒ–è„šæœ¬
        required: true
        default: true

jobs:
  build-firmware:
    name: ç¼–è¯‘å›ºä»¶
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
      packages: write

    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç ï¼ˆå«æœ€æ–°è®¾å¤‡åˆ—è¡¨ï¼‰
        uses: actions/checkout@v4

      - name: æ£€æŸ¥è®¾å¤‡é…ç½®æ–‡ä»¶
        run: |
          if [ ! -f "device-drivers.json" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°è®¾å¤‡é…ç½®æ–‡ä»¶ device-drivers.jsonï¼Œè¯·å…ˆè¿è¡ŒåŒæ­¥å·¥ä½œæµ"
            exit 1
          fi

      - name: ç¯å¢ƒå‡†å¤‡ï¼ˆå®‰è£…ç¼–è¯‘ä¾èµ–ï¼‰
        run: |
          sudo apt update
          sudo apt install -y build-essential libncurses5-dev libncursesw5-dev \
            zlib1g-dev gawk git gettext libssl-dev xsltproc wget unzip python3 jq

      - name: æ£€æµ‹ç¡¬ä»¶èµ„æºï¼ˆåŠ¨æ€è®¡ç®—çº¿ç¨‹æ•°ï¼‰
        run: |
          # è·å–CPUæ ¸å¿ƒæ•°å’Œå¯ç”¨å†…å­˜
          CPU_CORES=$(grep -c ^processor /proc/cpuinfo)
          AVAIL_MEM=$(free -m | awk '/^Mem:/ {print $7}')
          echo "ğŸ” æ£€æµ‹åˆ°ç¡¬ä»¶ï¼š$CPU_CORES æ ¸å¿ƒï¼Œ$AVAIL_MEM MB å¯ç”¨å†…å­˜"
          echo "CPU_CORES=$CPU_CORES" >> $GITHUB_ENV
          echo "AVAIL_MEM=$AVAIL_MEM" >> $GITHUB_ENV

      - name: åŠ¨æ€è®¡ç®—ç¼–è¯‘çº¿ç¨‹æ•°
        run: |
          # æå–ä¼˜åŒ–çº§åˆ«å’Œæ¶æ„
          OPT_LEVEL=$(echo "${{ github.event.inputs.theme_and_optimization }}" | cut -d'-' -f2)
          ARCH=$(echo "${{ github.event.inputs.theme_and_optimization }}" | cut -d'-' -f3)
          
          # æ¯çº¿ç¨‹å†…å­˜é˜ˆå€¼ï¼ˆO3ä¼˜åŒ–æ›´é«˜ï¼‰
          MIN_MEM_PER_THREAD=$([ "$OPT_LEVEL" = "O3" ] && echo 2048 || echo 1024)
          [ "$ARCH" = "armv8" ] && MIN_MEM_PER_THREAD=$((MIN_MEM_PER_THREAD * 12 / 10))  # ARMé¢å¤–å¢åŠ 20%
          
          # è®¡ç®—æœ€å¤§çº¿ç¨‹æ•°ï¼ˆå—å†…å­˜å’ŒCPUé™åˆ¶ï¼‰
          MAX_THREADS_BY_MEM=$((AVAIL_MEM / MIN_MEM_PER_THREAD))
          MAX_THREADS_BY_CPU=${{ env.CPU_CORES }}
          FINAL_THREADS=$((MAX_THREADS_BY_MEM < MAX_THREADS_BY_CPU ? MAX_THREADS_BY_MEM : MAX_THREADS_BY_CPU))
          FINAL_THREADS=$((FINAL_THREADS < 1 ? 1 : FINAL_THREADS))
          
          # O3+ARMv8ç‰¹æ®Šé™åˆ¶
          if [ "$OPT_LEVEL" = "O3" ] && [ "$ARCH" = "armv8" ] && [ $FINAL_THREADS -gt 2 ]; then
            FINAL_THREADS=2
          fi
          
          echo "ğŸ“Š ç¼–è¯‘çº¿ç¨‹æ•°ï¼š$FINAL_THREADSï¼ˆä¼˜åŒ–çº§åˆ«ï¼š$OPT_LEVELï¼Œæ¶æ„ï¼š$ARCHï¼‰"
          echo "THREADS=$FINAL_THREADS" >> $GITHUB_ENV

      - name: è§£æç¼–è¯‘å‚æ•°ï¼ˆä¸»é¢˜ã€åŠŸèƒ½ã€è½¯ä»¶åŒ…ï¼‰
        run: |
          # è§£æä¸»é¢˜
          THEME=$(echo "${{ github.event.inputs.theme_and_optimization }}" | cut -d'-' -f1)
          echo "THEME=$THEME" >> $GITHUB_ENV
          echo "CFLAGS=-$(echo "${{ github.event.inputs.theme_and_optimization }}" | cut -d'-' -f2)" >> $GITHUB_ENV
          
          # è§£ææ ¸å¿ƒåŠŸèƒ½
          case "${{ github.event.inputs.core_features }}" in
            "ipv6+accel")
              echo "ENABLE_IPV6=true" >> $GITHUB_ENV
              echo "ENABLE_ACCEL=true" >> $GITHUB_ENV
              ;;
            "ipv6-only")
              echo "ENABLE_IPV6=true" >> $GITHUB_ENV
              echo "ENABLE_ACCEL=false" >> $GITHUB_ENV
              ;;
            "accel-only")
              echo "ENABLE_IPV6=false" >> $GITHUB_ENV
              echo "ENABLE_ACCEL=true" >> $GITHUB_ENV
              ;;
            "none")
              echo "ENABLE_IPV6=false" >> $GITHUB_ENV
              echo "ENABLE_ACCEL=false" >> $GITHUB_ENV
              ;;
          esac
          
          # è§£æè½¯ä»¶åŒ…ï¼ˆè‡ªåŠ¨è¡¥å…¨luci-app-å‰ç¼€ï¼‰
          packages="${{ github.event.inputs.packages }}"
          common_pkgs=$(echo "$packages" | tr ',' '\n' | grep -v 'luci-app-' | sed 's/^/luci-app-/g' | tr '\n' ' ')
          custom_pkgs=$(echo "$packages" | tr ',' '\n' | grep 'luci-app-' | tr '\n' ' ')
          echo "PACKAGES=$common_pkgs $custom_pkgs" >> $GITHUB_ENV

      - name: æ‹‰å–OpenWrtæºç ï¼ˆå¸¦é‡è¯•æœºåˆ¶ï¼‰
        run: |
          fetch_source() {
            local repo=$1 branch=$2 retries=3
            while [ $retries -gt 0 ]; do
              if git clone --depth 1 --branch "$branch" "$repo" openwrt-src; then
                # æ£€æŸ¥æºç æ˜¯å¦æ‹‰å–å®Œæ•´
                if [ -n "$(ls -A openwrt-src)" ]; then
                  return 0
                fi
              fi
              retries=$((retries - 1))
              echo "âš ï¸ æºç æ‹‰å–å¤±è´¥ï¼Œé‡è¯•ï¼ˆå‰©ä½™$retriesæ¬¡ï¼‰..."
              rm -rf openwrt-src
              sleep 5
            done
            echo "âŒ æºç æ‹‰å–å¤±è´¥ï¼ˆå·²é‡è¯•3æ¬¡ï¼‰"
            exit 1
          }
          
          # æ ¹æ®é€‰æ‹©çš„åˆ†æ”¯æ‹‰å–å¯¹åº”æºç 
          case "${{ github.event.inputs.source_branch }}" in
            openwrt-23.05)
              fetch_source "https://git.openwrt.org/openwrt/openwrt.git" "openwrt-23.05"
              ;;
            openwrt-master)
              fetch_source "https://git.openwrt.org/openwrt/openwrt.git" "master"
              ;;
            immortalwrt-23.05)
              fetch_source "https://github.com/immortalwrt/immortalwrt.git" "openwrt-23.05"
              ;;
            immortalwrt-master)
              fetch_source "https://github.com/immortalwrt/immortalwrt.git" "master"
              ;;
          esac
          echo "SRC_DIR=$(pwd)/openwrt-src" >> $GITHUB_ENV

      - name: åˆå§‹åŒ–æºç ä¸ä¸»é¢˜æº
        run: |
          cd "${{ env.SRC_DIR }}"
          # æ›´æ–°feeds
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          
          # æ·»åŠ ä¸»é¢˜æº
          if [ "${{ env.THEME }}" = "argon" ]; then
            echo 'src-git argon https://github.com/jerrykuku/luci-theme-argon.git' >> feeds.conf.default
          elif [ "${{ env.THEME }}" = "material" ]; then
            echo 'src-git material https://github.com/LuttyYang/luci-theme-material.git' >> feeds.conf.default
          fi
          
          # æ·»åŠ OpenClashæºï¼ˆéImmortalWrtåˆ†æ”¯ï¼‰
          if [[ "${{ env.PACKAGES }}" == *"luci-app-openclash"* && 
                ! "${{ github.event.inputs.source_branch }}" == *"immortalwrt"* ]]; then
            echo 'src-git openclash https://github.com/vernesong/OpenClash.git' >> feeds.conf.default
          fi
          
          # å†æ¬¡æ›´æ–°feedsç¡®ä¿ä¸»é¢˜å’Œæ’ä»¶å¯ç”¨
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: æ‰§è¡Œè‡ªå®šä¹‰åˆå§‹åŒ–è„šæœ¬ï¼ˆè‹¥å¯ç”¨ï¼‰
        if: ${{ github.event.inputs.run_custom_script == 'true' }}
        run: |
          cd "${{ env.SRC_DIR }}"
          if [ ! -f "../scripts/custom-init.sh" ]; then
            echo "âŒ é”™è¯¯ï¼šè‡ªå®šä¹‰è„šæœ¬ scripts/custom-init.sh ä¸å­˜åœ¨"
            exit 1
          fi
          chmod +x ../scripts/custom-init.sh
          echo "ğŸ”§ æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬..."
          # è®°å½•è„šæœ¬è¾“å‡ºæ—¥å¿—
          ../scripts/custom-init.sh > custom-init.log 2>&1
          if [ $? -ne 0 ]; then
            echo "âŒ è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œæ—¥å¿—ï¼š"
            cat custom-init.log
            exit 1
          fi
          echo "âœ… è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œå®Œæˆ"

      - name: è§£æè®¾å¤‡/èŠ¯ç‰‡é…ç½®ï¼ˆä»device-drivers.jsonï¼‰
        run: |
          if [ "${{ github.event.inputs.select_mode }}" = "device" ]; then
            # è®¾å¤‡æ¨¡å¼ï¼šç›´æ¥è¯»å–è®¾å¤‡é…ç½®
            info=$(jq --arg dev "${{ github.event.inputs.device }}" '.devices[] | select(.name == $dev)' device-drivers.json)
          else
            # èŠ¯ç‰‡æ¨¡å¼ï¼šè¯»å–èŠ¯ç‰‡å¯¹åº”çš„å¹³å°é…ç½®
            chip_info=$(jq --arg c "${{ github.event.inputs.chip }}" '.chips[] | select(.name == $c)' device-drivers.json)
            kernel_target=$(echo "$chip_info" | jq -r '.platform')
            # å–è¯¥å¹³å°ç¬¬ä¸€ä¸ªè®¾å¤‡çš„é…ç½®ä½œä¸ºå‚è€ƒ
            info=$(jq --arg p "$kernel_target" '.devices[] | select(.kernel_target == $p)' device-drivers.json | head -n1)
          fi
          
          # æå–å†…æ ¸ç›®æ ‡å’Œé©±åŠ¨
          kernel_target=$(echo "$info" | jq -r '.kernel_target')
          drivers=$(echo "$info" | jq -r '.drivers[]' | tr '\n' ' ')
          
          echo "KERNEL_TARGET=$kernel_target" >> $GITHUB_ENV
          echo "DRIVERS=$drivers" >> $GITHUB_ENV

      - name: ç”Ÿæˆç¼–è¯‘é…ç½®æ–‡ä»¶ï¼ˆ.configï¼‰
        run: |
          cd "${{ env.SRC_DIR }}"
          target=$(echo "${{ env.KERNEL_TARGET }}" | tr '/' '_')  # è½¬æ¢è·¯å¾„ä¸ºç›®æ ‡åç§°
          
          # åŸºç¡€é…ç½®
          echo "CONFIG_TARGET_$target=y" >> .config
          echo "CONFIG_TARGET_${target}_DEVICE_generic=y" >> .config
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=${{ github.event.inputs.rootfs_size }}" >> .config
          
          # æ·»åŠ è®¾å¤‡é©±åŠ¨
          for driver in ${{ env.DRIVERS }}; do
            echo "CONFIG_PACKAGE_$driver=y" >> .config
          done
          
          # æ·»åŠ ç”¨æˆ·é€‰æ‹©çš„è½¯ä»¶åŒ…
          for pkg in ${{ env.PACKAGES }}; do
            echo "CONFIG_PACKAGE_$pkg=y" >> .config
          done
          
          # æ ¸å¿ƒåŠŸèƒ½é…ç½®
          if [ "${{ env.ENABLE_IPV6 }}" = "true" ]; then
            echo "CONFIG_IPV6=y" >> .config
            echo "CONFIG_PACKAGE_ipv6helper=y" >> .config
          else
            echo "# CONFIG_IPV6 is not set" >> .config
          fi
          if [ "${{ env.ENABLE_ACCEL }}" = "true" ]; then
            echo "CONFIG_PACKAGE_kmod-nf-flow=y" >> .config
          fi
          
          # ç¼–è¯‘ä¼˜åŒ–é…ç½®
          echo "CONFIG_CFLAGS=${{ env.CFLAGS }}" >> .config
          echo "CONFIG_CXXFLAGS=${{ env.CFLAGS }}" >> .config
          
          # ä¸»é¢˜é…ç½®ï¼ˆå¯ç”¨é€‰æ‹©çš„ä¸»é¢˜ï¼Œç¦ç”¨å…¶ä»–ä¸»é¢˜ï¼‰
          echo "CONFIG_PACKAGE_luci-theme-${{ env.THEME }}=y" >> .config
          if [ "${{ env.THEME }}" != "bootstrap" ]; then
            echo "# CONFIG_PACKAGE_luci-theme-bootstrap is not set" >> .config
          fi
          if [ "${{ env.THEME }}" != "argon" ]; then
            echo "# CONFIG_PACKAGE_luci-theme-argon is not set" >> .config
          fi
          if [ "${{ env.THEME }}" != "material" ]; then
            echo "# CONFIG_PACKAGE_luci-theme-material is not set" >> .config
          fi
          
          # ç”Ÿæˆæœ€ç»ˆé…ç½®
          make defconfig

      - name: å¼€å§‹ç¼–è¯‘å›ºä»¶
        run: |
          cd "${{ env.SRC_DIR }}"
          echo "ğŸš€ å¼€å§‹ç¼–è¯‘ï¼ˆçº¿ç¨‹æ•°ï¼š${{ env.THREADS }}ï¼Œä¼˜åŒ–çº§åˆ«ï¼š${{ env.CFLAGS }}ï¼‰"
          # è®°å½•ç¼–è¯‘æ—¥å¿—
          make -j${{ env.THREADS }} V=s 2>&1 | tee compile.log

      - name: ç¼–è¯‘é”™è¯¯åˆ†æï¼ˆè‹¥å¤±è´¥ï¼‰
        if: failure()
        run: |
          cd "${{ env.SRC_DIR }}"
          echo "âŒ ç¼–è¯‘å¤±è´¥ï¼Œé”™è¯¯åˆ†æï¼š"
          
          if grep -q "Killed signal terminated program cc1" compile.log; then
            echo "â†’ åŸå› ï¼šå†…å­˜ä¸è¶³ï¼ˆå°è¯•å‡å°‘çº¿ç¨‹æ•°æˆ–é™ä½ä¼˜åŒ–çº§åˆ«ï¼‰"
          elif grep -q "Package kmod-.* is missing" compile.log; then
            missing_pkg=$(grep "Package kmod-.* is missing" compile.log | head -n1 | awk '{print $2}')
            echo "â†’ åŸå› ï¼šé©±åŠ¨åŒ… $missing_pkg ä¸å­˜åœ¨ï¼ˆå»ºè®®åˆ‡æ¢æºç åˆ†æ”¯ï¼‰"
          elif grep -q "configuration error: recursive dependency" compile.log; then
            echo "â†’ åŸå› ï¼šè½¯ä»¶åŒ…ä¾èµ–å†²çªï¼ˆå‡å°‘å‹¾é€‰çš„è½¯ä»¶åŒ…ï¼‰"
          else
            echo "â†’ æœªçŸ¥é”™è¯¯ï¼Œæœ€å50è¡Œæ—¥å¿—ï¼š"
            tail -n 50 compile.log
          fi
          exit 1

      - name: å›ºä»¶é‡å‘½åï¼ˆæ·»åŠ æ ‡è¯†ï¼‰
        run: |
          # ç”Ÿæˆå›ºä»¶åç§°ï¼ˆåŒ…å«è®¾å¤‡/èŠ¯ç‰‡ã€åˆ†æ”¯ã€ä¸»é¢˜ã€æ—¥æœŸï¼‰
          base_name="${{ github.event.inputs.device || github.event.inputs.chip }}-${{ github.event.inputs.source_branch }}-${{ env.THEME }}"
          firmware_suffix="${{ github.event.inputs.firmware_suffix }}-$(date +%Y%m%d)"
          
          # é‡å‘½åæ‰€æœ‰å›ºä»¶
          find "${{ env.SRC_DIR }}/bin/targets/" -name "*.bin" -exec sh -c '
            for file do
              # ä¿ç•™åŸæ–‡ä»¶åä¸­çš„sysupgrade/factoryæ ‡è¯†ï¼Œæ·»åŠ è‡ªå®šä¹‰åç¼€
              filename=$(basename "$file" .bin)
              new_filename="${filename}-${1}.bin"
              mv "$file" "$(dirname "$file")/$new_filename"
              echo "é‡å‘½åå›ºä»¶ï¼š$new_filename"
            done
          ' _ "$firmware_suffix" \;

      - name: ä¸Šä¼ ç¼–è¯‘æˆæœ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: "${{ github.event.inputs.device || github.event.inputs.chip }}-firmware-${{ github.run_id }}"
          path: |
            ${{ env.SRC_DIR }}/bin/targets/**/*.bin
            ${{ env.SRC_DIR }}/compile.log
            ${{ env.SRC_DIR }}/custom-init.log  # ä»…å½“æ‰§è¡Œäº†è‡ªå®šä¹‰è„šæœ¬æ—¶å­˜åœ¨
          retention-days: 30
          if-no-files-found: error

      - name: æ‹‰å–æºç ï¼ˆå¸¦é‡è¯•ï¼‰
        run: |
          # å®šä¹‰æ‹‰å–å‡½æ•°ï¼ˆæœ€å¤šé‡è¯•3æ¬¡ï¼‰
          fetch_source() {
            local repo=$1
            local branch=$2
            local retries=3
            local count=0
            while [ $count -lt $retries ]; do
              if git clone --depth 1 --branch "$branch" "$repo" openwrt-src; then
                return 0
              fi
              echo "âš ï¸ æ‹‰å–æºç å¤±è´¥ï¼Œé‡è¯•ç¬¬ $((count+1)) æ¬¡..."
              count=$((count+1))
              rm -rf openwrt-src  # æ¸…ç†å¤±è´¥çš„ç›®å½•
              sleep 5  # ç­‰å¾…5ç§’å†é‡è¯•
            done
            echo "âŒ æ‹‰å–æºç å¤±è´¥ï¼ˆå·²é‡è¯•3æ¬¡ï¼‰"
            exit 1
          }

          # é€‰æ‹©ä»“åº“å¹¶è°ƒç”¨æ‹‰å–å‡½æ•°
          case "${{ github.event.inputs.source_branch }}" in
            openwrt-23.05)
              fetch_source "https://git.openwrt.org/openwrt/openwrt.git" "openwrt-23.05"
              ;;
            openwrt-master)
              fetch_source "https://git.openwrt.org/openwrt/openwrt.git" "master"
              ;;
            immortalwrt-23.05)
              fetch_source "https://github.com/immortalwrt/immortalwrt.git" "openwrt-23.05"
              ;;
            immortalwrt-master)
              fetch_source "https://github.com/immortalwrt/immortalwrt.git" "master"
              ;;
          esac
          echo "SRC_DIR=$(pwd)/openwrt-src" >> $GITHUB_ENV
      
      - name: æ‰§è¡Œè‡ªå®šä¹‰åˆå§‹åŒ–è„šæœ¬
        if: ${{ github.event.inputs.run_custom_script == 'true' }}
        run: |
          cd "${{ env.SRC_DIR }}"
          if [ ! -f "../scripts/custom-init.sh" ]; then
            echo "âŒ é”™è¯¯ï¼šè‡ªå®šä¹‰è„šæœ¬ scripts/custom-init.sh ä¸å­˜åœ¨"
            exit 1
          fi
          if ! chmod +x ../scripts/custom-init.sh; then
            echo "âŒ é”™è¯¯ï¼šæ— æ³•ä¸ºè‡ªå®šä¹‰è„šæœ¬æ·»åŠ æ‰§è¡Œæƒé™"
            exit 1
          fi
          echo "ğŸ”§ å¼€å§‹æ‰§è¡Œè‡ªå®šä¹‰è„šæœ¬..."
          if ! ../scripts/custom-init.sh; then
            echo "âŒ é”™è¯¯ï¼šè‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼ˆè¯·æ£€æŸ¥è„šæœ¬è¯­æ³•ï¼‰"
            exit 1
          fi
          echo "âœ… è‡ªå®šä¹‰è„šæœ¬æ‰§è¡Œå®Œæˆ"
     
      - name: è¾“å‡ºå›ºä»¶ç±»å‹è¯´æ˜
        run: |
          echo "ğŸ“Œ å›ºä»¶ç±»å‹è¯´æ˜ï¼š"
          echo "  - å« 'sysupgrade' çš„æ–‡ä»¶ï¼šç”¨äºè®¾å¤‡å‡çº§ï¼ˆä¿ç•™é…ç½®ï¼‰"
          echo "  - å« 'factory' çš„æ–‡ä»¶ï¼šç”¨äºé¦–æ¬¡åˆ·å†™ï¼ˆæ¸…ç©ºé…ç½®ï¼‰"
          find "${{ env.SRC_DIR }}/bin/targets/" -name "*.bin" | grep -E "sysupgrade|factory" | while read -r file; do
            echo "  - $file"
          done
      
      - name: æ¸…ç†ç¼–è¯‘ç¼“å­˜ï¼ˆé¦–æ¬¡è¿è¡Œæˆ–ç‰ˆæœ¬åˆ‡æ¢æ—¶ï¼‰
        run: |
          if [ -d "openwrt-src" ]; then
            echo "ğŸ§¹ æ¸…ç†æ—§ç¼–è¯‘ç›®å½•..."
            rm -rf openwrt-src
          fi
        if: ${{ github.event.inputs.source_branch != github.event.repository.default_branch }}  # ç‰ˆæœ¬åˆ‡æ¢æ—¶è§¦å‘
      
      - name: å›ºä»¶ä¿¡æ¯æ‘˜è¦
        run: |
          firmware_path=$(find "${{ env.SRC_DIR }}/bin/targets/" -name "*.bin" | head -n1)
          if [ -n "$firmware_path" ]; then
            echo "ğŸ“Š å›ºä»¶ä¿¡æ¯ï¼š"
            echo "  - è·¯å¾„ï¼š$firmware_path"
            echo "  - å¤§å°ï¼š$(du -h "$firmware_path" | awk '{print $1}')"
            echo "  - é€‚ç”¨è®¾å¤‡ï¼š${{ github.event.inputs.device || github.event.inputs.chip }}"
            echo "  - æºç ç‰ˆæœ¬ï¼š${{ github.event.inputs.source_branch }}"
            echo "  - ä¸»é¢˜ï¼š${{ env.THEME }}"
          fi
          

