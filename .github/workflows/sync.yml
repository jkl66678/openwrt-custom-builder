name: è®¾å¤‡åˆ—è¡¨ä¸ç¼–è¯‘é€‰é¡¹åŒæ­¥ç³»ç»Ÿ

# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘ + æ¯å‘¨æ—¥è‡ªåŠ¨æ‰§è¡Œ
on:
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼ˆä¾¿äºç´§æ€¥æ›´æ–°ï¼‰
  schedule:
    - cron: "0 0 * * 0"  # æ¯å‘¨æ—¥0ç‚¹è‡ªåŠ¨æ‰§è¡Œï¼ˆUTCæ—¶é—´ï¼‰

jobs:
  sync-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸è¯»å†™ä»“åº“å†…å®¹ï¼ˆç”¨äºæäº¤æ›´æ–°ï¼‰
      actions: read    # å…è®¸è¯»å–å·¥ä½œæµä¿¡æ¯

    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç ï¼ˆç¦ç”¨é»˜è®¤å‡­æ®ç¼“å­˜ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          persist-credentials: false  # ç¦ç”¨é»˜è®¤å‡­æ®ï¼Œé¿å…æƒé™å†²çª

      - name: å®‰è£…ç³»ç»Ÿä¾èµ–å·¥å…·
        run: |
          sudo apt update -qq > /dev/null 2>&1
          sudo apt install -y -qq git jq dos2unix build-essential libncurses5-dev \
            zlib1g-dev gawk gettext libssl-dev xsltproc wget unzip python3 python3-pip \
            gcc yq  # æ–°å¢yqç”¨äºYAMLéªŒè¯
          
          # éªŒè¯å…³é”®å·¥å…·æ˜¯å¦å®‰è£…æˆåŠŸ
          for tool in git jq yq gcc python3; do
            if ! command -v "$tool" &> /dev/null; then
              echo "âŒ ç¼ºå¤±å¿…è¦å·¥å…·: $tool"
              exit 1
            fi
          done
          echo "âœ… ç³»ç»Ÿä¾èµ–å®‰è£…å®Œæˆ"

      - name: é…ç½®åŒæ­¥è„šæœ¬æƒé™
        run: |
          # æ£€æŸ¥åŒæ­¥è„šæœ¬æ˜¯å¦å­˜åœ¨
          if [ ! -f "scripts/sync-devices.sh" ]; then
            echo "âŒ åŒæ­¥è„šæœ¬ä¸å­˜åœ¨: scripts/sync-devices.sh"
            exit 1
          fi
          # ç¡®ä¿è„šæœ¬æ ¼å¼æ­£ç¡®ï¼ˆå¤„ç†Windowsæ¢è¡Œé—®é¢˜ï¼‰
          dos2unix scripts/sync-devices.sh
          chmod +x scripts/sync-devices.sh
          echo "âœ… åŒæ­¥è„šæœ¬æƒé™é…ç½®å®Œæˆ"

      - name: æ‰§è¡Œè®¾å¤‡ä¸é€‰é¡¹å…¨é‡åŒæ­¥
        run: |
          echo "ğŸ“ å¼€å§‹å…¨é‡åŒæ­¥ï¼ˆè®¾å¤‡/èŠ¯ç‰‡/é©±åŠ¨/åŠŸèƒ½/ä¸»é¢˜ï¼‰..."
          # æ‰§è¡ŒåŒæ­¥è„šæœ¬å¹¶æ•è·è¯¦ç»†æ—¥å¿—
          ./scripts/sync-devices.sh || {
            echo "âŒ åŒæ­¥è¿‡ç¨‹å¤±è´¥ï¼ŒæŸ¥çœ‹åŒæ­¥æ—¥å¿—è·å–è¯¦æƒ…"
            exit 1
          }
          # éªŒè¯æ ¸å¿ƒè¾“å‡ºæ–‡ä»¶æœ‰æ•ˆæ€§
          if [ ! -f "device-drivers.json" ] || [ $(jq '.devices | length' "device-drivers.json") -eq 0 ]; then
            echo "âŒ è®¾å¤‡åˆ—è¡¨ç”Ÿæˆå¤±è´¥æˆ–ä¸ºç©º"
            exit 1
          fi
          if [ ! -d "configs" ] || [ ! -f "configs/core-features.json" ] || [ ! -f "configs/theme-optimizations.json" ]; then
            echo "âŒ åŠŸèƒ½/ä¸»é¢˜é…ç½®æ–‡ä»¶ç”Ÿæˆå¤±è´¥"
            exit 1
          fi
          echo "âœ… å…¨é‡åŒæ­¥å®Œæˆ"
          echo "â†’ è®¾å¤‡æ€»æ•°: $(jq '.devices | length' "device-drivers.json")"
          echo "â†’ æ ¸å¿ƒåŠŸèƒ½æ•°: $(jq '.features | length' "configs/core-features.json")"
          echo "â†’ ä¸»é¢˜æ•°: $(jq '.themes | length' "configs/theme-optimizations.json")"

      - name: ç”Ÿæˆæœ€æ–°ç¼–è¯‘å·¥ä½œæµï¼ˆbuild.ymlï¼‰
        run: |
          # æ£€æŸ¥å·¥ä½œæµç”Ÿæˆè„šæœ¬
          if [ ! -f "scripts/generate-workflow.sh" ]; then
            echo "âŒ å·¥ä½œæµç”Ÿæˆè„šæœ¬ä¸å­˜åœ¨: scripts/generate-workflow.sh"
            exit 1
          fi
          dos2unix scripts/generate-workflow.sh
          chmod +x scripts/generate-workflow.sh
          
          # æ‰§è¡Œç”Ÿæˆè„šæœ¬
          echo "ğŸ“ å¼€å§‹ç”Ÿæˆæœ€æ–°ç¼–è¯‘å·¥ä½œæµ..."
          ./scripts/generate-workflow.sh || {
            echo "âŒ å·¥ä½œæµç”Ÿæˆå¤±è´¥"
            exit 1
          }
          # éªŒè¯ç”Ÿæˆç»“æœ
          if [ ! -f ".github/workflows/build.yml" ]; then
            echo "âŒ ç”Ÿæˆçš„build.ymlä¸å­˜åœ¨"
            exit 1
          fi
          echo "âœ… ç¼–è¯‘å·¥ä½œæµå·²æ›´æ–°"

      - name: æäº¤æ›´æ–°åˆ°ä»“åº“ï¼ˆå¸¦å†²çªå¤„ç†ï¼‰
        run: |
          # é…ç½®æäº¤èº«ä»½
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # æ¸…é™¤æ—§å‡­æ®ç¼“å­˜
          git credential-cache exit
          rm -f ~/.git-credentials
          
          # é‡æ–°é…ç½®è¿œç¨‹ä»“åº“ï¼ˆä½¿ç”¨ä»¤ç‰Œè®¤è¯ï¼‰
          git remote remove origin
          git remote add origin "https://github.com/jkl66678/openwrt-custom-builder.git"
          
          # é…ç½®Gitå‡­æ®
          git credential approve <<EOF
          protocol=https
          host=github.com
          username=github-actions[bot]
          password=${{ github.token }}
          EOF
          
          # æ·»åŠ æ‰€æœ‰å˜æ›´æ–‡ä»¶
          git add device-drivers.json \
                  sync-logs/ \
                  configs/ \
                  .github/workflows/build.yml \
                  scripts/  # ç¡®ä¿è„šæœ¬å˜æ›´ä¹Ÿè¢«æäº¤
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å®é™…å˜æ›´
          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ— å˜æ›´å†…å®¹ï¼Œæ— éœ€æäº¤"
            exit 0
          fi
          
          # æš‚å­˜æœ¬åœ°æ›´æ”¹ï¼Œé¿å…æ‹‰å–å†²çª
          git stash push -u -m "temp stash before pull" || echo "â„¹ï¸ æ— éœ€è¦æš‚å­˜çš„å†…å®¹"
          
          # æ‹‰å–è¿œç¨‹æœ€æ–°ä»£ç ï¼ˆä¼˜å…ˆrebaseï¼Œå¤±è´¥åˆ™æ™®é€šæ‹‰å–ï¼‰
          if ! git pull --rebase origin main; then
            echo "âš ï¸ rebaseå¤±è´¥ï¼Œå°è¯•æ™®é€šæ‹‰å–"
            git pull origin main || {
              echo "âŒ æ‹‰å–è¿œç¨‹ä»£ç å¤±è´¥ï¼Œå¯èƒ½å­˜åœ¨å†²çª"
              exit 1
            }
          fi
          
          # æ¢å¤æš‚å­˜çš„æ›´æ”¹
          if git stash list | grep -q "temp stash before pull"; then
            git stash pop || {
              echo "âš ï¸ æ¢å¤æš‚å­˜å†…å®¹æ—¶å‘ç”Ÿå†²çªï¼Œè¯·æ‰‹åŠ¨å¤„ç†"
              exit 1
            }
          fi
          
          # å†æ¬¡ç¡®è®¤å˜æ›´å¹¶æäº¤
          git add .
          commit_msg="è‡ªåŠ¨åŒæ­¥è®¾å¤‡ä¸é€‰é¡¹ï¼ˆ$(date +"%Y-%m-%d %H:%M")ï¼‰"
          git commit -m "$commit_msg" || {
            echo "â„¹ï¸ æ— æ–°å˜æ›´å¯æäº¤"
            exit 0
          }
          
          # æ¨é€æ›´æ–°ï¼ˆä½¿ç”¨ä»¤ç‰Œç¡®ä¿æƒé™ï¼‰
          echo "ğŸ“¤ æ¨é€æ›´æ–°åˆ°è¿œç¨‹ä»“åº“..."
          git push "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/jkl66678/openwrt-custom-builder.git" main || {
            echo "âŒ æ¨é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹å¯èƒ½åŸå› ï¼š"
            echo "1. ä»“åº“Workflowæƒé™æ˜¯å¦ä¸ºRead and writeï¼ˆSettings â†’ Actionsï¼‰"
            echo "2. åˆ†æ”¯ä¿æŠ¤è§„åˆ™æ˜¯å¦é™åˆ¶æ¨é€ï¼ˆSettings â†’ Branchesï¼‰"
            echo "3. ä»¤ç‰Œæƒé™æ˜¯å¦æ­£ç¡®ï¼ˆé»˜è®¤GITHUB_TOKENåº”æœ‰è¶³å¤Ÿæƒé™ï¼‰"
            exit 1
          }
          echo "âœ… æˆåŠŸæ¨é€æ›´æ–°"

      - name: ä¸Šä¼ åŒæ­¥æ—¥å¿—ï¼ˆè°ƒè¯•ç”¨ï¼‰
        if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¸Šä¼ æ—¥å¿—
        uses: actions/upload-artifact@v4
        with:
          name: sync-logs-${{ github.run_id }}
          path: |
            sync-logs/
            device-drivers.json
            configs/
            .github/workflows/build.yml
          retention-days: 14  # æ—¥å¿—ä¿ç•™14å¤©ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
