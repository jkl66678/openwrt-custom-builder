name: è®¾å¤‡åˆ—è¡¨è‡ªåŠ¨åŒæ­¥on:
workflow_dispatch:
schedule:cron: "0 0 * * 0"jobs:
sync-devices:
runs-on: ubuntu-latest
permissions:
contents: write
actions: writesteps:name: æ‹‰å–ä»“åº“ä»£ç 
uses: actions/checkout@v4name: å®‰è£…ä¾èµ–
run: |
sudo apt update && sudo apt install -y git jq dos2unix python3 python3-pip
pip3 install PyJWT cryptographyéªŒè¯å…³é”®å·¥å…·æ˜¯å¦å®‰è£…command -v jq >/dev/null || {echo "âŒ jq æœªå®‰è£…"; exit 1;}
command -v python3 >/dev/null || { echo "âŒ Python3 æœªå®‰è£…"; exit 1; }name: å‡†å¤‡è„šæœ¬æ–‡ä»¶
run: |éªŒè¯è„šæœ¬å­˜åœ¨æ€§for script in sync-devices.sh generate_jwt.py; do
[ -f "scripts/$script" ] || { echo "âŒ ç¼ºå°‘è„šæœ¬: $script"; exit 1; }
doneè½¬æ¢è„šæœ¬æ ¼å¼å¹¶æ·»åŠ æ‰§è¡Œæƒé™dos2unix scripts/.sh && chmod +x scripts/.sh
chmod +x scripts/generate_jwt.pyname: æ‰§è¡ŒåŒæ­¥è„šæœ¬
run: |
mkdir -p sync-logsæ‰§è¡Œè„šæœ¬å¹¶æ•è·å®Œæ•´è¾“å‡º./scripts/sync-devices.sh > sync-logs/sync-detail.log 2>&1 || {
echo "âŒ åŒæ­¥è„šæœ¬æ‰§è¡Œå¤±è´¥"
cat sync-logs/sync-detail.log
exit 1
}name: ç”Ÿæˆ GitHub App è®¿é—®ä»¤ç‰Œï¼ˆå¸¦å®Œæ•´è°ƒè¯•ï¼‰
run: |åˆå§‹åŒ–å˜é‡APP_ID=\({{ secrets.GH_APP_ID }}
  PRIVATE_KEY="\){{ secrets.GH_APP_PRIVATE_KEY }}"
TMP_KEY_FILE="/tmp/key.pem"å†™å…¥ç§é’¥åˆ°ä¸´æ—¶æ–‡ä»¶echo "\(PRIVATE_KEY" > "\)TMP_KEY_FILE"
chmod 600 "$TMP_KEY_FILE"
echo "âœ… ç§é’¥æ–‡ä»¶å·²å†™å…¥: $TMP_KEY_FILE"éªŒè¯ç§é’¥æ ¼å¼ï¼ˆå¢å¼ºç‰ˆï¼‰for marker in "-----BEGIN RSA PRIVATE KEY-----" "-----END RSA PRIVATE KEY-----"; do
if ! grep -q -- "\(marker" "\)TMP_KEY_FILE"; then
echo "âŒ ç§é’¥ç¼ºå°‘æ ‡è®°:Â \(marker"
  cat "\)TMP_KEY_FILE" # æ‰“å°ç§é’¥å†…å®¹ï¼ˆè„±æ•å¤„ç†ï¼‰
exit 1
fi
done
echo "âœ… ç§é’¥æ ¼å¼éªŒè¯é€šè¿‡"ç”Ÿæˆ JWT å¹¶éªŒè¯echo "ğŸ” ç”Ÿæˆ JWTï¼ŒAPP_ID:Â \(APP_ID"
  JWT_OUTPUT=\)(python3 scripts/generate_jwt.py "\(APP_ID" "\)TMP_KEY_FILE")
JWT=\((echo "\)JWT_OUTPUT" | grep "JWT=" | cut -d'=' -f2)
if [ -z "\(JWT" ]; then
echo "âŒ JWTç”Ÿæˆå¤±è´¥ï¼Œè„šæœ¬è¾“å‡º:"
echo "\)JWT_OUTPUT"
exit 1
fi
echo "âœ… JWT ç”ŸæˆæˆåŠŸï¼ˆå‰ 30 å­—ç¬¦ï¼‰: ${JWT:0:30}..."éªŒè¯ JWT æœ‰æ•ˆæ€§ï¼ˆé€šè¿‡è§£ç æ£€æŸ¥ï¼‰echo "ğŸ” éªŒè¯ JWT æœ‰æ•ˆæ€§"
JWT_PAYLOAD=\((echo "\)JWT" | cut -d'.' -f2 | base64 -d | jq '.' || true)
if echo "$JWT_PAYLOAD" | grep -q '"exp":'; then
echo "ğŸ“Œ JWTæœ‰æ•ˆæœŸ:Â \((date -d @\)(echo "$JWT_PAYLOAD"| jq -r '.exp') +% Y-% m-% dT% H:% M:% SZ)"
else
echo "âš ï¸ JWT ç¼ºå°‘ exp å­—æ®µï¼Œå¯èƒ½å­˜åœ¨å®‰å…¨é£é™©"
fiè·å–å®‰è£… IDï¼ˆå¸¦å®Œæ•´ API å“åº”è®°å½•ï¼‰echo "ğŸ” è·å–å®‰è£… ID"
INSTALLATION_RESPONSE=$(curl -s -H "Authorization: Bearer $JWT"
-H "Accept: application/vnd.github+json"
"https://api.github.com/app/installations")
echo "ğŸ“Œ å®‰è£…åˆ—è¡¨å“åº”ï¼ˆå‰ 500 å­—ç¬¦ï¼‰: ${INSTALLATION_RESPONSE:0:500}..."INSTALLATION_ID=\((echo "\)INSTALLATION_RESPONSE" | jq -r '.[] | select(.repositories[0].name == "openwrt-custom-builder") | .id')
if [ "\(INSTALLATION_ID" = "null" ] || [ -z "\)INSTALLATION_ID" ]; then
echo "âŒ æœªæ‰¾åˆ°ç›®æ ‡ä»“åº“å®‰è£…è®°å½•ï¼Œå®Œæ•´å“åº”:"
echo "$INSTALLATION_RESPONSE" | jq '.'
exit 1
fi
echo "âœ… å®‰è£…IDè·å–æˆåŠŸ: $INSTALLATION_ID"è·å–è®¿é—®ä»¤ç‰Œï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰echo "ğŸ” è·å–è®¿é—®ä»¤ç‰Œ"
ACCESS_TOKEN_RESPONSE=$(curl -s -X POST
-H "Authorization: BearerÂ \(JWT" \
-H "Accept: application/vnd.github+json" \
"[https://api.github.com/app/installations/](https://api.github.com/app/installations/ "autolink")\)INSTALLATION_ID/access_tokens")
echo "ğŸ“Œ ä»¤ç‰Œå“åº”ï¼ˆå‰500å­—ç¬¦ï¼‰: ${ACCESS_TOKEN_RESPONSE:0:500}..."ACCESS_TOKEN=\((echo "\)ACCESS_TOKEN_RESPONSE" | jq -r '.token')
if [ "\(ACCESS_TOKEN" = "null" ] || [ -z "\)ACCESS_TOKEN" ]; then
echo "âŒ ä»¤ç‰Œç”Ÿæˆå¤±è´¥ï¼Œå®Œæ•´å“åº”:"
echo "$ACCESS_TOKEN_RESPONSE" | jq '.'
exit 1
fi
echo "âœ… è®¿é—®ä»¤ç‰Œç”ŸæˆæˆåŠŸï¼ˆå‰30å­—ç¬¦ï¼‰: ${ACCESS_TOKEN:0:30}..."è¾“å‡ºä»¤ç‰Œåˆ°ç¯å¢ƒå˜é‡echo "ACCESS_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV
rm -f "$TMP_KEY_FILE"name: æäº¤æ›´æ–°
run: |
git config --global user.name "Sync Bot"
git config --global user.email "bot@example.com"
git remote set-url origin "https://x-access-token:${{env.ACCESS_TOKEN}}@github.com/jkl66678/openwrt-custom-builder.git"git add device-drivers.json .github/workflows/build.yml sync-logs/
if ! git diff --cached --quiet; then
git commit -m "è‡ªåŠ¨æ›´æ–°è®¾å¤‡åˆ—è¡¨ï¼ˆ$(date +% Y% m% d)ï¼‰" && git push origin main
else
echo "â„¹ï¸ æ— æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
finame: ä¸Šä¼ ç»“æœ
if: always ()
uses: actions/upload-artifact@v4
with:
name: sync-results-${{github.run_id}}
path: sync-logs/device-drivers.json
retention-days: 14
