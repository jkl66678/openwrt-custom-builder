name: 设备列表同步与编译选项自动更新

on:
  workflow_dispatch:  # 手动触发
  schedule:
    - cron: "0 0 * * 0"  # 每周日自动执行

jobs:
  sync-devices:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 仅需此权限即可修改仓库内容（包括工作流文件）

    steps:
      - name: 拉取仓库最新代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # 仅拉取最新版本

      - name: 安装依赖工具
        run: |
          sudo apt update -qq > /dev/null 2>&1
          sudo apt install -y -qq git jq dos2unix build-essential libncurses5-dev \
            zlib1g-dev gawk gettext libssl-dev xsltproc wget unzip python3 python3-pip
          
          # 验证关键工具
          for tool in git jq awk python3; do
            if ! command -v "$tool" &> /dev/null; then
              echo "❌ 缺失必要工具: $tool"
              exit 1
            fi
          done
          echo "✅ 依赖工具安装完成"

      - name: 配置同步脚本权限
        run: |
          if [ ! -f "scripts/sync-devices.sh" ]; then
            echo "❌ 同步脚本不存在: scripts/sync-devices.sh"
            exit 1
          fi
          chmod +x scripts/sync-devices.sh
          echo "✅ 同步脚本权限配置完成"

      - name: 执行设备列表同步（核心步骤）
        run: |
          echo "📝 开始从OpenWrt源码同步设备列表..."
          ./scripts/sync-devices.sh || {
            echo "❌ 同步脚本执行失败，查看sync-logs获取详情"
            exit 1
          }
          # 验证生成结果
          if [ ! -f "device-drivers.json" ] || [ $(jq '.devices | length' "device-drivers.json") -eq 0 ]; then
            echo "❌ 设备列表生成失败或为空"
            exit 1
          fi
          echo "✅ 设备列表同步完成，共发现 $(jq '.devices | length' "device-drivers.json") 个设备"

      - name: 生成更新build.yml
        run: |
          if [ ! -f "scripts/generate-workflow.sh" ]; then
            echo "❌ 生成脚本不存在: scripts/generate-workflow.sh"
            exit 1
          fi
          chmod +x scripts/generate-workflow.sh
          
          ./scripts/generate-workflow.sh || {
            echo "❌ 生成build.yml失败"
            exit 1
          }
          echo "✅ build.yml已更新为最新设备选项"

      - name: 提交更新到仓库（含冲突处理）
        run: |
          # 配置Git身份
          git config --global user.name "设备同步Bot"
          git config --global user.email "bot@example.com"
          
          # 强制使用GITHUB_TOKEN认证
          git remote set-url origin "https://x-access-token:${{ github.token }}@github.com/jkl66678/openwrt-custom-builder.git"
          
          # 添加所有变更文件
          git add device-drivers.json .github/workflows/build.yml sync-logs/
          
          # 检查是否有变更
          if git diff --cached --quiet; then
            echo "ℹ️ 无变更内容，无需提交"
            exit 0
          fi
          
          # 关键修复：暂存所有未提交的更改（包括未add的文件）
          git stash push -u -m "temp stash before pull" || echo "ℹ️ 没有需要暂存的内容"
          
          # 拉取远程最新代码（优先rebase，失败则普通拉取）
          if ! git pull --rebase origin main; then
            echo "⚠️ rebase失败，尝试普通拉取"
            git pull origin main || {
              echo "❌ 拉取远程代码失败，请检查网络或仓库权限"
              exit 1
            }
          fi
          
          # 恢复暂存的更改（如有）
          if git stash list | grep -q "temp stash before pull"; then
            git stash pop || {
              echo "⚠️ 恢复暂存内容时发生冲突，已保留冲突文件，手动解决后再推送"
              # 冲突时仍继续执行，让后续步骤尝试提交
            }
          fi
          
          # 再次暂存确保所有变更被包含
          git add device-drivers.json .github/workflows/build.yml sync-logs/
          
          # 提交并推送
          git commit -m "自动同步设备列表（$(date +%Y-%m-%d %H:%M)）" || {
            echo "ℹ️ 无新变更可提交（可能是拉取后内容一致）"
            exit 0
          }
          git push origin main || {
            echo "❌ 推送失败，可能需要手动解决冲突"
            exit 1
          }
          echo "✅ 成功推送更新到远程仓库"

      - name: 上传同步日志（调试用）
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-debug-logs-${{ github.run_id }}
          path: |
            sync-logs/
            device-drivers.json
            .github/workflows/build.yml
          retention-days: 14
