name: è®¾å¤‡åˆ—è¡¨åŒæ­¥ä¸ç¼–è¯‘é€‰é¡¹è‡ªåŠ¨æ›´æ–°

on:
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: "0 0 * * 0"  # æ¯å‘¨æ—¥å‡Œæ™¨è‡ªåŠ¨æ‰§è¡Œ

jobs:
  sync-devices-and-generate:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # å…è®¸æäº¤ä»£ç 
      actions: read    # è¯»å–å·¥ä½œæµçŠ¶æ€

    steps:
      - name: æ‹‰å–ä»“åº“æœ€æ–°ä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # åªæ‹‰å–æœ€æ–°ç‰ˆæœ¬ï¼ŒåŠ å¿«é€Ÿåº¦

      - name: å®‰è£…å¿…è¦å·¥å…·ï¼ˆjqã€dos2unixç­‰ï¼‰
        run: |
          sudo apt update -qq > /dev/null 2>&1  # é™é»˜æ›´æ–°ï¼Œå‡å°‘è¾“å‡º
          sudo apt install -y -qq jq dos2unix > /dev/null 2>&1
          
          # éªŒè¯å·¥å…·å®‰è£…æˆåŠŸ
          if ! command -v jq &> /dev/null; then
            echo "âŒ å…³é”®å·¥å…·jqå®‰è£…å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç¯å¢ƒ"
            exit 1
          fi
          echo "âœ… ä¾èµ–å·¥å…·å®‰è£…å®Œæˆ"

      - name: åŒæ­¥æœ€æ–°è®¾å¤‡åˆ—è¡¨ï¼ˆæ›¿æ¢ä¸ºä½ çš„æ•°æ®æºï¼‰
        run: |
          # ====================
          # æ›¿æ¢ä¸ºä½ çš„è®¾å¤‡åˆ—è¡¨åŒæ­¥é€»è¾‘
          # ç¤ºä¾‹ï¼šä»è¿œç¨‹APIæ‹‰å–/ä»å…¶ä»–ä»“åº“åŒæ­¥/æ•°æ®åº“å¯¼å‡ºç­‰
          # ====================
          echo "ğŸ” å¼€å§‹åŒæ­¥è®¾å¤‡åˆ—è¡¨..."
          
          # ç¤ºä¾‹ï¼šæ¨¡æ‹Ÿä»è¿œç¨‹è·å–è®¾å¤‡åˆ—è¡¨ï¼ˆå®é™…åœºæ™¯è¯·æ›¿æ¢ï¼‰
          mkdir -p tmp
          curl -s "https://raw.githubusercontent.com/ä½ çš„ç”¨æˆ·å/ä½ çš„ä»“åº“/main/device-drivers.json" \
               -o tmp/device-drivers.json || {
            echo "âŒ è¿œç¨‹è®¾å¤‡åˆ—è¡¨è·å–å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°å¤‡ä»½"
            cp device-drivers.json tmp/device-drivers.json  #  fallbackåˆ°æœ¬åœ°æ–‡ä»¶
          }
          
          # éªŒè¯è®¾å¤‡åˆ—è¡¨æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆå¿…é¡»æ˜¯æœ‰æ•ˆçš„JSONï¼‰
          if ! jq empty tmp/device-drivers.json > /dev/null 2>&1; then
            echo "âŒ è®¾å¤‡åˆ—è¡¨JSONæ ¼å¼é”™è¯¯ï¼ŒåŒæ­¥ç»ˆæ­¢"
            exit 1
          fi
          
          # æ›¿æ¢æœ¬åœ°è®¾å¤‡åˆ—è¡¨
          mv tmp/device-drivers.json device-drivers.json
          echo "âœ… è®¾å¤‡åˆ—è¡¨åŒæ­¥å®Œæˆï¼ˆæœ€æ–°ç‰ˆæœ¬ï¼‰"

      - name: å‡†å¤‡ç”Ÿæˆè„šæœ¬ï¼ˆè®¾ç½®æƒé™+éªŒè¯å­˜åœ¨æ€§ï¼‰
        run: |
          # æ£€æŸ¥è„šæœ¬æ˜¯å¦å­˜åœ¨
          if [ ! -f "scripts/generate-workflow.sh" ]; then
            echo "âŒ ç”Ÿæˆè„šæœ¬ä¸å­˜åœ¨ï¼šscripts/generate-workflow.sh"
            exit 1
          fi
          
          # æ·»åŠ æ‰§è¡Œæƒé™ï¼ˆå…³é”®æ­¥éª¤ï¼‰
          chmod +x scripts/generate-workflow.sh
          echo "âœ… ç”Ÿæˆè„šæœ¬æƒé™è®¾ç½®å®Œæˆ"

      - name: åŠ¨æ€ç”Ÿæˆbuild.ymlï¼ˆæ›´æ–°è®¾å¤‡/èŠ¯ç‰‡é€‰é¡¹ï¼‰
        run: |
          echo "ğŸ” å¼€å§‹ç”Ÿæˆç¼–è¯‘å·¥ä½œæµ..."
          ./scripts/generate-workflow.sh || {
            echo "âŒ ç”Ÿæˆå·¥ä½œæµå¤±è´¥ï¼Œè¯·æ£€æŸ¥è„šæœ¬é€»è¾‘"
            exit 1
          }
          echo "âœ… build.ymlç”Ÿæˆå®Œæˆï¼Œå·²æ›´æ–°è®¾å¤‡é€‰é¡¹"

      - name: æäº¤æ›´æ–°åˆ°ä»“åº“
        run: |
          # é…ç½®Gitæäº¤ä¿¡æ¯
          git config --global user.name "è®¾å¤‡åŒæ­¥Bot"
          git config --global user.email "bot@example.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´ï¼ˆè®¾å¤‡åˆ—è¡¨æˆ–å·¥ä½œæµæ–‡ä»¶ï¼‰
          git add device-drivers.json .github/workflows/build.yml
          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ— å˜æ›´å†…å®¹ï¼Œæ— éœ€æäº¤"
            exit 0
          fi
          
          # æäº¤å¹¶æ¨é€
          git commit -m "è‡ªåŠ¨æ›´æ–°è®¾å¤‡åˆ—è¡¨åŠç¼–è¯‘é€‰é¡¹ï¼ˆ$(date +%Y-%m-%d %H:%M)ï¼‰"
          git push origin main --force-with-lease  # å®‰å…¨æ¨é€ï¼Œé¿å…å†²çª
          echo "âœ… æ‰€æœ‰æ›´æ–°å·²æäº¤åˆ°ä»“åº“"

      - name: ä¸Šä¼ åŒæ­¥ç»“æœï¼ˆä¾¿äºè°ƒè¯•ï¼‰
        if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¸Šä¼ 
        uses: actions/upload-artifact@v4
        with:
          name: sync-results-${{ github.run_id }}
          path: |
            device-drivers.json
            .github/workflows/build.yml
            scripts/generate-workflow.sh
          retention-days: 10  # ä¿ç•™10å¤©ç”¨äºè°ƒè¯•
    
