name: è®¾å¤‡åˆ—è¡¨è‡ªåŠ¨åŒæ­¥

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 0"  # æ¯å‘¨æ—¥è‡ªåŠ¨åŒæ­¥

jobs:
  sync-devices:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…ä¾èµ–å·¥å…·
        run: |
          sudo apt update && sudo apt install -y git jq dos2unix
          # å®‰è£…PythonåŠä¾èµ–ï¼ˆç”¨äºç”ŸæˆJWTï¼‰
          sudo apt install -y python3 python3-pip
          pip3 install PyJWT cryptography  # ç”¨äºJWTç”Ÿæˆçš„Pythonåº“

      - name: å‡†å¤‡åŒæ­¥è„šæœ¬
        run: |
          if [ ! -f "scripts/sync-devices.sh" ]; then
            echo "âŒ æœªæ‰¾åˆ°åŒæ­¥è„šæœ¬ï¼šscripts/sync-devices.sh"
            exit 1
          fi
          dos2unix scripts/sync-devices.sh
          chmod +x scripts/sync-devices.sh

      - name: æ‰§è¡Œè®¾å¤‡åˆ—è¡¨åŒæ­¥è„šæœ¬
        run: |
          mkdir -p sync-logs
          ./scripts/sync-devices.sh > sync-logs/sync-detail.log 2>&1 || {
            echo "âŒ åŒæ­¥è„šæœ¬æ‰§è¡Œå¤±è´¥"
            cat sync-logs/sync-detail.log
            exit 1
          }

      - name: ç”Ÿæˆæ–°å·¥ä½œæµæ–‡ä»¶
        run: |
          if [ -f "scripts/generate-workflow.sh" ]; then
            chmod +x scripts/generate-workflow.sh
            ./scripts/generate-workflow.sh
          else
            echo "âš ï¸ è·³è¿‡ç”Ÿæˆå·¥ä½œæµæ­¥éª¤"
          fi

      - name: ç”ŸæˆGitHub Appè®¿é—®ä»¤ç‰Œï¼ˆPythonç‰ˆï¼Œä¿®å¤æ ¼å¼é—®é¢˜ï¼‰
        run: |
          # ä»Secretsè·å–å‚æ•°
          APP_ID=${{ secrets.GH_APP_ID }}
          PRIVATE_KEY="${{ secrets.GH_APP_PRIVATE_KEY }}"
          
          # å†™å…¥ç§é’¥åˆ°æ–‡ä»¶ï¼ˆä¿ç•™åŸå§‹æ ¼å¼ï¼‰
          echo "$PRIVATE_KEY" > /tmp/private-key.pem
          chmod 600 /tmp/private-key.pem
          
          # éªŒè¯ç§é’¥æ ¼å¼ï¼ˆå…³é”®æ£€æŸ¥ï¼‰
          echo "ğŸ” éªŒè¯ç§é’¥æ ¼å¼..."
          if ! grep -q "-----BEGIN RSA PRIVATE KEY-----" /tmp/private-key.pem; then
            echo "âŒ ç§é’¥ç¼ºå°‘å¼€å¤´æ ‡è®°ï¼š-----BEGIN RSA PRIVATE KEY-----"
            cat /tmp/private-key.pem
            exit 1
          fi
          if ! grep -q "-----END RSA PRIVATE KEY-----" /tmp/private-key.pem; then
            echo "âŒ ç§é’¥ç¼ºå°‘ç»“å°¾æ ‡è®°ï¼š-----END RSA PRIVATE KEY-----"
            cat /tmp/private-key.pem
            exit 1
          fi
          echo "âœ… ç§é’¥æ ¼å¼éªŒè¯é€šè¿‡"
          
          # ç”¨Pythonç”ŸæˆJWTï¼ˆæ¯”jwt-cliæ›´å¯é ï¼‰
          echo "ğŸ”‘ ç”ŸæˆJWTä»¤ç‰Œ..."
          python3 - <<END
import jwt
import time
from datetime import datetime, timedelta

# è¯»å–ç§é’¥
with open('/tmp/private-key.pem', 'r') as f:
    private_key = f.read()

# è®¾ç½®è¿‡æœŸæ—¶é—´ï¼ˆ10åˆ†é’Ÿï¼‰
iat = int(time.time())
exp = iat + 600

# ç”ŸæˆJWT
token = jwt.encode(
    {
        'iat': iat,
        'exp': exp,
        'iss': '$APP_ID'
    },
    private_key,
    algorithm='RS256'
)

print(f"JWT={token}")
END > jwt.txt
          JWT=$(grep "JWT=" jwt.txt | cut -d'=' -f2)
          echo "âœ… JWTç”ŸæˆæˆåŠŸï¼ˆå‰20å­—ç¬¦ï¼‰ï¼š${JWT:0:20}..."
          
          # è·å–å®‰è£…ID
          INSTALLATION_RESPONSE=$(curl -s -H "Authorization: Bearer $JWT" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/app/installations")
          INSTALLATION_ID=$(echo "$INSTALLATION_RESPONSE" | jq -r '.[] | select(.repository_selection == "selected" and .repositories[0].name == "openwrt-custom-builder") | .id')
          if [ "$INSTALLATION_ID" = "null" ] || [ -z "$INSTALLATION_ID" ]; then
            echo "âŒ æœªæ‰¾åˆ°ä»“åº“å®‰è£…è®°å½•ï¼Œå“åº”ï¼š$INSTALLATION_RESPONSE"
            exit 1
          fi
          echo "âœ… å®‰è£…IDï¼š$INSTALLATION_ID"
          
          # è·å–è®¿é—®ä»¤ç‰Œ
          ACCESS_TOKEN_RESPONSE=$(curl -s -X POST -H "Authorization: Bearer $JWT" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/app/installations/$INSTALLATION_ID/access_tokens")
          ACCESS_TOKEN=$(echo "$ACCESS_TOKEN_RESPONSE" | jq -r '.token')
          if [ "$ACCESS_TOKEN" = "null" ] || [ -z "$ACCESS_TOKEN" ]; then
            echo "âŒ ä»¤ç‰Œç”Ÿæˆå¤±è´¥ï¼Œå“åº”ï¼š$ACCESS_TOKEN_RESPONSE"
            exit 1
          fi
          echo "âœ… è®¿é—®ä»¤ç‰Œç”ŸæˆæˆåŠŸ"
          
          # ä¿å­˜ä»¤ç‰Œ
          echo "ACCESS_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV
          rm -f /tmp/private-key.pem jwt.txt

      - name: æäº¤æ›´æ–°
        run: |
          git config --global user.name "Sync Bot"
          git config --global user.email "bot@example.com"
          git remote set-url origin "https://x-access-token:${{ env.ACCESS_TOKEN }}@github.com/jkl66678/openwrt-custom-builder.git"
          
          git add device-drivers.json .github/workflows/build.yml sync-logs/
          if git diff --cached --quiet; then
            echo "âš ï¸ æ— æ›´æ–°å¯æäº¤"
          else
            git commit -m "è‡ªåŠ¨æ›´æ–°è®¾å¤‡åˆ—è¡¨ï¼ˆ$(date +%Y%m%d)ï¼‰"
            git push origin main
          fi

      - name: ä¸Šä¼ ç»“æœ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-results-${{ github.run_id }}
          path: |
            sync-logs/
            device-drivers.json
          retention-days: 14
