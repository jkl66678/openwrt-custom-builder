name: è®¾å¤‡åˆ—è¡¨è‡ªåŠ¨åŒæ­¥ï¼ˆä»…æ›´æ–°ï¼Œä¸ç¼–è¯‘ï¼‰

on:
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: "0 0 * * 0"  # æ¯å‘¨æ—¥è‡ªåŠ¨åŒæ­¥ï¼ˆUTCæ—¶é—´ï¼‰

jobs:
  sync-devices-and-update-options:
    name: åŒæ­¥è®¾å¤‡å¹¶æ›´æ–°é€‰é¡¹
    runs-on: ubuntu-latest
    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç ï¼ˆåŒ…å«æ‰€æœ‰åˆ†æ”¯å†å²ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # æ‹‰å–å®Œæ•´å†å²ï¼Œé¿å…æäº¤å¤±è´¥

      - name: å®‰è£…ä¾èµ–å·¥å…·
        run: |
          sudo apt update || echo "âš ï¸ aptæ›´æ–°å¤±è´¥ï¼Œå°è¯•ç›´æ¥å®‰è£…ä¾èµ–"
          sudo apt install -y git jq || {
            echo "âŒ ä¾èµ–å®‰è£…å¤±è´¥"
            exit 1
          }

      - name: æ£€æŸ¥åŒæ­¥è„šæœ¬æ˜¯å¦å­˜åœ¨
        run: |
          if [ ! -f "scripts/sync-devices.sh" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°åŒæ­¥è„šæœ¬ scripts/sync-devices.sh"
            exit 1
          fi
          # æ£€æŸ¥è„šæœ¬æ˜¯å¦å¯æ‰§è¡Œ
          if [ ! -x "scripts/sync-devices.sh" ]; then
            chmod +x scripts/sync-devices.sh
            echo "âš ï¸ å·²ä¸ºåŒæ­¥è„šæœ¬æ·»åŠ å¯æ‰§è¡Œæƒé™"
          fi

      - name: æ‰§è¡Œè®¾å¤‡åŒæ­¥ï¼ˆç”Ÿæˆdevice-drivers.jsonï¼‰
        run: |
          echo "ğŸ“¥ å¼€å§‹åŒæ­¥è®¾å¤‡ä¿¡æ¯..."
          # æ•è·åŒæ­¥è„šæœ¬çš„é”™è¯¯è¾“å‡º
          if ! ./scripts/sync-devices.sh > sync.log 2>&1; then
            echo "âŒ è®¾å¤‡åŒæ­¥å¤±è´¥ï¼Œæ—¥å¿—ï¼š"
            cat sync.log
            exit 1
          fi
          echo "âœ… è®¾å¤‡åŒæ­¥å®Œæˆ"

      - name: æå–è®¾å¤‡å’ŒèŠ¯ç‰‡åˆ—è¡¨ï¼ˆç”¨äºæ›´æ–°é€‰é¡¹ï¼‰
        run: |
          # æ£€æŸ¥JSONæ–‡ä»¶æ˜¯å¦æœ‰æ•ˆ
          if ! jq . device-drivers.json > /dev/null 2>&1; then
            echo "âŒ é”™è¯¯ï¼šdevice-drivers.json æ ¼å¼æ— æ•ˆ"
            exit 1
          fi

          # ä»JSONä¸­æå–è®¾å¤‡åç§°ï¼ˆå»é‡ã€æ’åºï¼Œå¤„ç†ç©ºå€¼ï¼‰
          DEVICES=$(jq -r '.devices[].name | select(. != null)' device-drivers.json | sort | uniq | tr '\n' ' ')
          # ä»JSONä¸­æå–èŠ¯ç‰‡åç§°ï¼ˆå»é‡ã€æ’åºï¼Œå¤„ç†ç©ºå€¼ï¼‰
          CHIPS=$(jq -r '.chips[].name | select(. != null)' device-drivers.json | sort | uniq | tr '\n' ' ')
          
          # å¤„ç†ç©ºåˆ—è¡¨ï¼ˆé¿å…æ›¿æ¢åé€‰é¡¹ä¸ºç©ºï¼‰
          if [ -z "$DEVICES" ]; then
            echo "âš ï¸ æœªæå–åˆ°ä»»ä½•è®¾å¤‡ï¼Œä½¿ç”¨é»˜è®¤åˆ—è¡¨"
            DEVICES="cudy-tr3000, redmi-ac2100"  # é»˜è®¤è®¾å¤‡
          fi
          if [ -z "$CHIPS" ]; then
            echo "âš ï¸ æœªæå–åˆ°ä»»ä½•èŠ¯ç‰‡ï¼Œä½¿ç”¨é»˜è®¤åˆ—è¡¨"
            CHIPS="mt7981, mt7621"  # é»˜è®¤èŠ¯ç‰‡
          fi
          
          echo "ğŸ“‹ åŒæ­¥åˆ°çš„è®¾å¤‡ï¼š$DEVICES"
          echo "ğŸ“‹ åŒæ­¥åˆ°çš„èŠ¯ç‰‡ï¼š$CHIPS"
          
          # ä¿å­˜åˆ°ç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "DEVICES=$DEVICES" >> $GITHUB_ENV
          echo "CHIPS=$CHIPS" >> $GITHUB_ENV

      - name: æ›´æ–°build.ymlä¸­çš„è®¾å¤‡å’ŒèŠ¯ç‰‡é€‰é¡¹
        run: |
          # æ›¿æ¢build.ymlä¸­è®¾å¤‡é€‰é¡¹çš„å†…å®¹
          if [ ! -f ".github/workflows/build.yml" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°ç¼–è¯‘å·¥ä½œæµ .github/workflows/build.yml"
            exit 1
          fi

          # ä½¿ç”¨sedæ›¿æ¢ï¼ˆæ”¯æŒåŒ…å«ç©ºæ ¼çš„è®¾å¤‡åç§°ï¼‰
          # å…ˆè½¬ä¹‰ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚/ï¼‰
          ESCAPED_DEVICES=$(echo "$DEVICES" | sed 's/\//\\\//g')
          ESCAPED_CHIPS=$(echo "$CHIPS" | sed 's/\//\\\//g')
          
          # æ›¿æ¢è®¾å¤‡é€‰é¡¹
          if ! sed -i "s/options: \[.*\]  # è‡ªåŠ¨æ›´æ–°æ ‡è®°/options: [$ESCAPED_DEVICES]  # è‡ªåŠ¨æ›´æ–°æ ‡è®°/" .github/workflows/build.yml; then
            echo "âŒ æ›¿æ¢è®¾å¤‡é€‰é¡¹å¤±è´¥ï¼Œæ£€æŸ¥build.ymlä¸­çš„æ³¨é‡Šæ ‡è®°æ˜¯å¦æ­£ç¡®"
            exit 1
          fi
          # æ›¿æ¢èŠ¯ç‰‡é€‰é¡¹
          if ! sed -i "s/options: \[.*\]  # è‡ªåŠ¨æ›´æ–°æ ‡è®°/options: [$ESCAPED_CHIPS]  # è‡ªåŠ¨æ›´æ–°æ ‡è®°/" .github/workflows/build.yml; then
            echo "âŒ æ›¿æ¢èŠ¯ç‰‡é€‰é¡¹å¤±è´¥ï¼Œæ£€æŸ¥build.ymlä¸­çš„æ³¨é‡Šæ ‡è®°æ˜¯å¦æ­£ç¡®"
            exit 1
          fi
          
          echo "âœ… å·²æ›´æ–°build.ymlä¸­çš„è®¾å¤‡å’ŒèŠ¯ç‰‡é€‰é¡¹"

      - name: æäº¤æ›´æ–°åˆ°ä»“åº“
        run: |
          # é…ç½®Gitèº«ä»½
          git config --global user.name "Device Sync Bot"
          git config --global user.email "bot@github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --quiet device-drivers.json .github/workflows/build.yml; then
            echo "âš ï¸ æ— æ–°è®¾å¤‡æˆ–èŠ¯ç‰‡éœ€è¦æ›´æ–°"
            exit 0
          fi
          
          # æäº¤æ›´æ–°ï¼ˆå¸¦é‡è¯•ï¼‰
          retries=3
          while [ $retries -gt 0 ]; do
            if git add device-drivers.json .github/workflows/build.yml && \
               git commit -m "è‡ªåŠ¨æ›´æ–°è®¾å¤‡å’ŒèŠ¯ç‰‡åˆ—è¡¨ï¼ˆ$(date +%Y%m%d)ï¼‰" && \
               git push; then
              echo "âœ… è®¾å¤‡å’ŒèŠ¯ç‰‡åˆ—è¡¨å·²æ›´æ–°å¹¶æäº¤"
              exit 0
            fi
            retries=$((retries - 1))
            echo "âš ï¸ æäº¤å¤±è´¥ï¼Œé‡è¯•ï¼ˆå‰©ä½™$retriesæ¬¡ï¼‰..."
            git pull --rebase  # æ‹‰å–è¿œç¨‹æ›´æ–°ï¼Œé¿å…å†²çª
            sleep 3
          done
          
          echo "âŒ æäº¤æ›´æ–°å¤±è´¥ï¼ˆå·²é‡è¯•3æ¬¡ï¼‰"
          exit 1
      
      - name: ä¸Šä¼ è¯¦ç»†æ—¥å¿—ï¼ˆå³ä½¿å¤±è´¥ä¹Ÿä¸Šä¼ ï¼‰
        if: always()  # æ— è®ºæˆåŠŸ/å¤±è´¥éƒ½æ‰§è¡Œ
        uses: actions/upload-artifact@v4
        with:
         name: sync-logs  # æ—¥å¿—åŒ…åç§°
         path: |
          sync-detail.log  # è¦ä¸Šä¼ çš„æ—¥å¿—æ–‡ä»¶
          sync.log  # å¦‚æœæœ‰å…¶ä»–æ—¥å¿—ä¹Ÿä¸€èµ·ä¸Šä¼ 
         retention-days: 7  # æ—¥å¿—ä¿ç•™7å¤©
