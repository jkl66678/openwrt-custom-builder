name: è®¾å¤‡åˆ—è¡¨åŒæ­¥ä¸ç¼–è¯‘é€‰é¡¹è‡ªåŠ¨æ›´æ–°

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: "0 0 * * 0"  # æ¯å‘¨æ—¥è‡ªåŠ¨æ‰§è¡Œ

jobs:
  sync-devices:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ä»…éœ€æ­¤æƒé™ï¼ŒGITHUB_TOKENé»˜è®¤åŒ…å«å·¥ä½œæµä¿®æ”¹æƒé™

    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç ï¼ˆç¦ç”¨é»˜è®¤å‡­æ®ç¼“å­˜ï¼‰
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          persist-credentials: false  # å…³é”®ï¼šç¦ç”¨é»˜è®¤å‡­æ®ç¼“å­˜ï¼Œé¿å…æ—§è®¤è¯ä¿¡æ¯å¹²æ‰°

      - name: å®‰è£…ä¾èµ–å·¥å…·
        run: |
          sudo apt update -qq > /dev/null 2>&1
          sudo apt install -y -qq git jq dos2unix build-essential libncurses5-dev \
            zlib1g-dev gawk gettext libssl-dev xsltproc wget unzip python3 python3-pip
          
          # éªŒè¯å…³é”®å·¥å…·
          for tool in git jq awk python3; do
            if ! command -v "$tool" &> /dev/null; then
              echo "âŒ ç¼ºå¤±å¿…è¦å·¥å…·: $tool"
              exit 1
            fi
          done
          echo "âœ… ä¾èµ–å·¥å…·å®‰è£…å®Œæˆ"

      - name: é…ç½®åŒæ­¥è„šæœ¬æƒé™
        run: |
          if [ ! -f "scripts/sync-devices.sh" ]; then
            echo "âŒ åŒæ­¥è„šæœ¬ä¸å­˜åœ¨: scripts/sync-devices.sh"
            exit 1
          fi
          chmod +x scripts/sync-devices.sh
          echo "âœ… åŒæ­¥è„šæœ¬æƒé™é…ç½®å®Œæˆ"

      - name: æ‰§è¡Œè®¾å¤‡åˆ—è¡¨åŒæ­¥ï¼ˆæ ¸å¿ƒæ­¥éª¤ï¼‰
        run: |
          echo "ğŸ“ å¼€å§‹ä»OpenWrtæºç åŒæ­¥è®¾å¤‡åˆ—è¡¨..."
          ./scripts/sync-devices.sh || {
            echo "âŒ åŒæ­¥è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼ŒæŸ¥çœ‹sync-logsè·å–è¯¦æƒ…"
            exit 1
          }
          # éªŒè¯ç”Ÿæˆç»“æœ
          if [ ! -f "device-drivers.json" ] || [ $(jq '.devices | length' "device-drivers.json") -eq 0 ]; then
            echo "âŒ è®¾å¤‡åˆ—è¡¨ç”Ÿæˆå¤±è´¥æˆ–ä¸ºç©º"
            exit 1
          fi
          echo "âœ… è®¾å¤‡åˆ—è¡¨åŒæ­¥å®Œæˆï¼Œå…±å‘ç° $(jq '.devices | length' "device-drivers.json") ä¸ªè®¾å¤‡"

      - name: ç”Ÿæˆæ›´æ–°build.yml
        run: |
          if [ ! -f "scripts/generate-workflow.sh" ]; then
            echo "âŒ ç”Ÿæˆè„šæœ¬ä¸å­˜åœ¨: scripts/generate-workflow.sh"
            exit 1
          fi
          chmod +x scripts/generate-workflow.sh
          
          ./scripts/generate-workflow.sh || {
            echo "âŒ ç”Ÿæˆbuild.ymlå¤±è´¥"
            exit 1
          }
          echo "âœ… build.ymlå·²æ›´æ–°ä¸ºæœ€æ–°è®¾å¤‡é€‰é¡¹"

      - name: æäº¤æ›´æ–°åˆ°ä»“åº“ï¼ˆç»ˆæè®¤è¯æ–¹æ¡ˆï¼‰
        run: |
          # é…ç½®å®˜æ–¹æœºå™¨äººèº«ä»½ï¼ˆä¸GitHub Appå½»åº•åŒºåˆ†ï¼‰
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # ã€å…³é”®1ã€‘å½»åº•æ¸…é™¤æ‰€æœ‰Gitå‡­æ®ç¼“å­˜
          git credential-cache exit
          rm -f ~/.git-credentials
          
          # ã€å…³é”®2ã€‘é‡æ–°é…ç½®è¿œç¨‹ä»“åº“ï¼Œå¼ºåˆ¶ä½¿ç”¨GITHUB_TOKEN
          git remote remove origin
          git remote add origin "https://github.com/jkl66678/openwrt-custom-builder.git"
          
          # ã€å…³é”®3ã€‘æ˜¾å¼è®¾ç½®Gitå‡­æ®ï¼Œç¡®ä¿ä½¿ç”¨GITHUB_TOKEN
          echo "https://github.com" | git credential approve <<EOF
          username=github-actions[bot]
          password=${{ github.token }}
          EOF
          
          # ã€è°ƒè¯•ã€‘ç¡®è®¤å‡­æ®é…ç½®
          echo "å½“å‰Gité…ç½®ç”¨æˆ·ï¼š"
          git config user.name
          git config user.email
          echo "å½“å‰è¿œç¨‹ä»“åº“ï¼š"
          git remote -v
          
          # æ·»åŠ æ‰€æœ‰å˜æ›´æ–‡ä»¶ï¼ˆè¦†ç›–æ‰€æœ‰å¯èƒ½ä¿®æ”¹çš„æ–‡ä»¶ï¼‰
          git add .github/workflows/build.yml device-drivers.json sync-logs/ scripts/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --cached --quiet; then
            echo "â„¹ï¸ æ— å˜æ›´å†…å®¹ï¼Œæ— éœ€æäº¤"
            exit 0
          fi
          
          # æš‚å­˜æœªæäº¤çš„æ›´æ”¹
          git stash push -u -m "temp stash before pull" || echo "â„¹ï¸ æ²¡æœ‰éœ€è¦æš‚å­˜çš„å†…å®¹"
          
          # æ‹‰å–è¿œç¨‹æœ€æ–°ä»£ç 
          if ! git pull --rebase origin main; then
            echo "âš ï¸ rebaseå¤±è´¥ï¼Œå°è¯•æ™®é€šæ‹‰å–"
            git pull origin main || {
              echo "âŒ æ‹‰å–è¿œç¨‹ä»£ç å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"
              exit 1
            }
          fi
          
          # æ¢å¤æš‚å­˜çš„æ›´æ”¹
          if git stash list | grep -q "temp stash before pull"; then
            git stash pop || {
              echo "âš ï¸ æ¢å¤æš‚å­˜å†…å®¹å†²çªï¼Œå·²ä¿ç•™æ–‡ä»¶"
            }
          fi
          
          # å†æ¬¡æš‚å­˜æ‰€æœ‰å˜æ›´
          git add .github/workflows/build.yml device-drivers.json sync-logs/ scripts/
          
          # æäº¤ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
          commit_msg="è‡ªåŠ¨åŒæ­¥è®¾å¤‡åˆ—è¡¨ï¼ˆ$(date +"%Y-%m-%d %H:%M")ï¼‰"
          git commit -m "$commit_msg" || {
            echo "â„¹ï¸ æ— æ–°å˜æ›´å¯æäº¤"
            exit 0
          }
          
          # ã€å…³é”®4ã€‘å¼ºåˆ¶ä½¿ç”¨ä»¤ç‰ŒURLæ¨é€ï¼Œç»•è¿‡æ‰€æœ‰æœ¬åœ°é…ç½®
          git push "https://x-access-token:${{ github.token }}@github.com/jkl66678/openwrt-custom-builder.git" main || {
            echo "âŒ æ¨é€å¤±è´¥ï¼Œæœ€åçš„å¯èƒ½åŸå› ï¼š"
            echo "1. ä»“åº“ä»æœ‰GitHub Appæ®‹ç•™ï¼ˆè¯·å†æ¬¡æ£€æŸ¥Settings â†’ Integrationsï¼‰"
            echo "2. ç»„ç»‡çº§åˆ«çš„å®‰å…¨ç­–ç•¥é™åˆ¶ï¼ˆè”ç³»ç»„ç»‡ç®¡ç†å‘˜ï¼‰"
            exit 1
          }
          echo "âœ… æˆåŠŸæ¨é€æ›´æ–°åˆ°è¿œç¨‹ä»“åº“"

      - name: ä¸Šä¼ åŒæ­¥æ—¥å¿—ï¼ˆè°ƒè¯•ç”¨ï¼‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-debug-logs-${{ github.run_id }}
          path: |
            sync-logs/
            device-drivers.json
            .github/workflows/build.yml
          retention-days: 14
