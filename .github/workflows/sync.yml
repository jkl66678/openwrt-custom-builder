name: 设备列表自动同步（仅更新，不编译）

on:
  workflow_dispatch:

jobs:
  sync-devices:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 显示工作目录（关键调试）
        run: |
          echo "当前工作目录：$(pwd)"
          echo "目录内容："
          ls -la

      - name: 安装依赖
        run: sudo apt install -y git jq dos2unix

      - name: 准备同步脚本
        run: |
          # 验证脚本存在
          if [ ! -f "scripts/sync-devices.sh" ]; then
            echo "❌ 未找到脚本：scripts/sync-devices.sh"
            exit 1
          fi
          # 修复格式和权限
          dos2unix scripts/sync-devices.sh
          chmod +x scripts/sync-devices.sh
          # 显示脚本前5行（验证路径）
          echo "脚本前5行："
          head -n 5 scripts/sync-devices.sh

      - name: 执行同步脚本（带错误输出）
        run: |
          echo "开始执行脚本..."
          ./scripts/sync-devices.sh || {
            echo "❌ 脚本执行失败，查看临时日志："
            cat sync-logs/sync-detail.log  # 即使失败也尝试输出日志
            exit 1
          }

      - name: 验证文件生成（核心调试步骤）
        if: always()
        run: |
          echo "=== 工作目录内容 ==="
          ls -la
          echo "=== 日志目录内容 ==="
          ls -la sync-logs/ || echo "sync-logs 目录不存在"
          echo "=== 配置文件内容 ==="
          cat device-drivers.json || echo "device-drivers.json 不存在"

      - name: 更新build.yml（简化版）
        run: |
          DEVICES=$(jq -r '.devices[].name' device-drivers.json | tr '\n' ' ')
          CHIPS=$(jq -r '.chips[].name' device-drivers.json | tr '\n' ' ')
          sed -i "s/options: \[.*\]  # 自动更新标记/options: [$DEVICES]  # 自动更新标记/" .github/workflows/build.yml
          sed -i "s/options: \[.*\]  # 自动更新标记/options: [$CHIPS]  # 自动更新标记/" .github/workflows/build.yml

      - name: 提交更新
        run: |
          git config --global user.name "Sync Bot"
          git config --global user.email "bot@example.com"
          git add device-drivers.json .github/workflows/build.yml
          git commit -m "自动更新设备列表" || echo "无更新可提交"
          git push || true

      - name: 上传日志和配置文件
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-results-${{ github.run_id }}
          path: |
            ${{ github.workspace }}/sync-logs/  # 绝对路径，确保准确
            ${{ github.workspace }}/device-drivers.json
          retention-days: 14
