name: 设备列表自动同步

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * 0"  # 每周日自动同步

jobs:
  sync-devices:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 允许推送更新
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 显示工作目录
        run: |
          echo "当前工作目录：$(pwd)"
          ls -la

      - name: 安装依赖
        run: sudo apt install -y git jq dos2unix

      - name: 准备同步脚本
        run: |
          if [ ! -f "scripts/sync-devices.sh" ]; then
            echo "❌ 未找到脚本：scripts/sync-devices.sh"
            exit 1
          fi
          dos2unix scripts/sync-devices.sh
          chmod +x scripts/sync-devices.sh
          head -n 5 scripts/sync-devices.sh

      - name: 执行同步脚本
        run: |
          ./scripts/sync-devices.sh || {
            echo "❌ 脚本执行失败，日志："
            cat sync-logs/sync-detail.log
            exit 1
          }

      - name: 验证文件生成
        if: always()
        run: |
          echo "工作目录内容："
          ls -la
          echo "日志目录内容："
          ls -la sync-logs/ || echo "sync-logs 不存在"
          echo "配置文件内容："
          cat device-drivers.json || echo "device-drivers.json 不存在"

      - name: 生成新工作流（含最新设备）
        run: |
          chmod +x scripts/generate-workflow.sh
          ./scripts/generate-workflow.sh

      - name: 提交更新
        run: |
          git config --global user.name "Sync Bot"
          git config --global user.email "bot@example.com"
          git add device-drivers.json .github/workflows/build.yml
          if git diff --cached --quiet; then
            echo "⚠️ 无更新可提交"
          else
            git commit -m "自动更新设备列表（$(date +%Y%m%d)）"
            git push
          fi

      - name: 上传日志和配置文件
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-results-${{ github.run_id }}
          path: |
            ${{ github.workspace }}/sync-logs/
            ${{ github.workspace }}/device-drivers.json
          retention-days: 14
