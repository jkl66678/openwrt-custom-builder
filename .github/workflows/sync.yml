name: è®¾å¤‡åˆ—è¡¨è‡ªåŠ¨åŒæ­¥

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: "0 0 * * 0"  # æ¯å‘¨æ—¥è‡ªåŠ¨æ‰§è¡Œ

jobs:
  sync-devices:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      actions: write

    steps:
      - name: æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£…ä¾èµ–å·¥å…·
        run: |
          sudo apt update -qq && sudo apt install -y -qq git jq dos2unix python3 python3-pip
          pip3 install -q PyJWT cryptography
          
          # éªŒè¯æ ¸å¿ƒå·¥å…·æ˜¯å¦å®‰è£…
          command -v jq >/dev/null || { echo "âŒ jqå®‰è£…å¤±è´¥"; exit 1; }
          command -v python3 >/dev/null || { echo "âŒ Python3å®‰è£…å¤±è´¥"; exit 1; }
          echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"

      - name: æ£€æŸ¥å¹¶å‡†å¤‡è„šæœ¬
        run: |
          # éªŒè¯å¿…è¦è„šæœ¬å­˜åœ¨æ€§
          required_scripts=("sync-devices.sh" "generate_jwt.py")
          for script in "${required_scripts[@]}"; do
            if [ ! -f "scripts/$script" ]; then
              echo "âŒ ç¼ºå°‘å¿…è¦è„šæœ¬ï¼šscripts/$script"
              exit 1
            fi
          done
          
          # è½¬æ¢æ ¼å¼å¹¶æ·»åŠ æ‰§è¡Œæƒé™
          dos2unix scripts/*.sh
          chmod +x scripts/*.sh scripts/generate_jwt.py
          echo "âœ… è„šæœ¬å‡†å¤‡å®Œæˆ"

      - name: æ‰§è¡Œè®¾å¤‡åŒæ­¥è„šæœ¬
        run: |
          mkdir -p sync-logs
          # æ‰§è¡ŒåŒæ­¥å¹¶æ•è·æ—¥å¿—
          ./scripts/sync-devices.sh > sync-logs/sync-output.log 2>&1 || {
            echo "âŒ åŒæ­¥è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œæ—¥å¿—å¦‚ä¸‹ï¼š"
            cat sync-logs/sync-output.log
            exit 1
          }
          echo "âœ… è®¾å¤‡åŒæ­¥å®Œæˆ"

      - name: ç”ŸæˆGitHub Appè®¿é—®ä»¤ç‰Œï¼ˆå®Œæ•´è®¤è¯æµç¨‹ï¼‰
        run: |
          # ä»secretsè·å–é…ç½®
          APP_ID="${{ secrets.GH_APP_ID }}"
          PRIVATE_KEY="${{ secrets.GH_APP_PRIVATE_KEY }}"
          TMP_KEY="/tmp/github-app-key.pem"
          TARGET_REPO="openwrt-custom-builder"  # ç›®æ ‡ä»“åº“åç§°
          
          # 1. å†™å…¥å¹¶éªŒè¯ç§é’¥
          echo "$PRIVATE_KEY" > "$TMP_KEY"
          chmod 600 "$TMP_KEY"
          
          if ! grep -q -- "-----BEGIN RSA PRIVATE KEY-----" "$TMP_KEY"; then
            echo "âŒ ç§é’¥ç¼ºå°‘å¼€å¤´æ ‡è®°"
            exit 1
          fi
          if ! grep -q -- "-----END RSA PRIVATE KEY-----" "$TMP_KEY"; then
            echo "âŒ ç§é’¥ç¼ºå°‘ç»“å°¾æ ‡è®°"
            exit 1
          fi
          echo "âœ… ç§é’¥æ ¼å¼éªŒè¯é€šè¿‡"

          # 2. ç”ŸæˆJWTå¹¶éªŒè¯æœ‰æ•ˆæ€§
          JWT_OUTPUT=$(python3 scripts/generate_jwt.py "$APP_ID" "$TMP_KEY")
          JWT=$(echo "$JWT_OUTPUT" | grep "JWT=" | cut -d'=' -f2)
          
          if [ -z "$JWT" ]; then
            echo "âŒ JWTç”Ÿæˆå¤±è´¥ï¼Œè„šæœ¬è¾“å‡ºï¼š$JWT_OUTPUT"
            exit 1
          fi
          
          # è§£ç JWTéªŒè¯payloadï¼ˆè°ƒè¯•å…³é”®ï¼‰
          echo "ğŸ” è§£æJWTå†…å®¹..."
          JWT_PAYLOAD=$(echo "$JWT" | cut -d'.' -f2 | base64 -d 2>/dev/null | jq .)
          if [ -z "$JWT_PAYLOAD" ]; then
            echo "âŒ JWTæ ¼å¼æ— æ•ˆï¼ˆæ— æ³•è§£ç ï¼‰"
            exit 1
          fi
          
          # éªŒè¯JWTå…³é”®å­—æ®µ
          if [ "$(echo "$JWT_PAYLOAD" | jq -r '.iss')" != "$APP_ID" ]; then
            echo "âŒ JWTç­¾å‘è€…(iss)ä¸APP_IDä¸åŒ¹é…"
            echo "å®é™…iss: $(echo "$JWT_PAYLOAD" | jq -r '.iss')ï¼Œé¢„æœŸ: $APP_ID"
            exit 1
          fi
          
          EXPIRY=$(echo "$JWT_PAYLOAD" | jq -r '.exp')
          CURRENT_TIME=$(date +%s)
          if [ $((EXPIRY - CURRENT_TIME)) -le 0 ]; then
            echo "âŒ JWTå·²è¿‡æœŸï¼ˆexp: $EXPIRYï¼Œå½“å‰æ—¶é—´: $CURRENT_TIMEï¼‰"
            exit 1
          fi
          echo "âœ… JWTéªŒè¯é€šè¿‡ï¼ˆæœ‰æ•ˆæœŸå‰©ä½™: $((EXPIRY - CURRENT_TIME))ç§’ï¼‰"

          # 3. è·å–å®‰è£…IDï¼ˆä½¿ç”¨JWTè®¤è¯ï¼‰
          echo "ğŸ” è·å–Appå®‰è£…åˆ—è¡¨..."
          INSTALLATION_RESPONSE=$(curl -s -w "%{http_code}" \
            -H "Authorization: Bearer $JWT" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/app/installations")
          
          HTTP_CODE=${INSTALLATION_RESPONSE: -3}
          INSTALLATION_BODY=${INSTALLATION_RESPONSE%???}
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "âŒ è·å–å®‰è£…åˆ—è¡¨å¤±è´¥ï¼ˆHTTP $HTTP_CODEï¼‰"
            echo "å“åº”å†…å®¹: $INSTALLATION_BODY"
            exit 1
          fi
          
          # ä»å®‰è£…åˆ—è¡¨ä¸­åŒ¹é…å½“å‰ç”¨æˆ·çš„å®‰è£…è®°å½•
          INSTALLATION_ID=$(echo "$INSTALLATION_BODY" | jq -r '.[] | select(.account.login == "jkl66678") | .id')
          if [ "$INSTALLATION_ID" = "null" ] || [ -z "$INSTALLATION_ID" ]; then
            echo "âŒ æœªæ‰¾åˆ°ç”¨æˆ·jkl66678çš„Appå®‰è£…è®°å½•"
            echo "æ‰€æœ‰å®‰è£…è®°å½•: $INSTALLATION_BODY"
            exit 1
          fi
          echo "âœ… è·å–å®‰è£…IDæˆåŠŸ: $INSTALLATION_ID"

          # 4. ç”Ÿæˆå®‰è£…è®¿é—®ä»¤ç‰Œï¼ˆä½¿ç”¨JWTï¼‰
          echo "ğŸ” ç”Ÿæˆè®¿é—®ä»¤ç‰Œ..."
          ACCESS_TOKEN_RESPONSE=$(curl -s -w "%{http_code}" -X POST \
            -H "Authorization: Bearer $JWT" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/app/installations/$INSTALLATION_ID/access_tokens")
          
          HTTP_CODE=${ACCESS_TOKEN_RESPONSE: -3}
          TOKEN_BODY=${ACCESS_TOKEN_RESPONSE%???}
          
          if [ "$HTTP_CODE" -ne 201 ]; then
            echo "âŒ ç”Ÿæˆè®¿é—®ä»¤ç‰Œå¤±è´¥ï¼ˆHTTP $HTTP_CODEï¼‰"
            echo "å“åº”å†…å®¹: $TOKEN_BODY"
            exit 1
          fi
          
          ACCESS_TOKEN=$(echo "$TOKEN_BODY" | jq -r '.token')
          if [ "$ACCESS_TOKEN" = "null" ] || [ -z "$ACCESS_TOKEN" ]; then
            echo "âŒ è®¿é—®ä»¤ç‰Œæå–å¤±è´¥"
            exit 1
          fi
          echo "âœ… è®¿é—®ä»¤ç‰Œç”ŸæˆæˆåŠŸï¼ˆå‰20å­—ç¬¦ï¼‰: ${ACCESS_TOKEN:0:20}..."

          # 5. éªŒè¯ç›®æ ‡ä»“åº“è®¿é—®æƒé™ï¼ˆå…³é”®æ­¥éª¤ï¼‰
          echo "ğŸ” éªŒè¯ä»“åº“è®¿é—®æƒé™..."
          REPO_RESPONSE=$(curl -s -w "%{http_code}" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/installation/repositories")
          
          HTTP_CODE=${REPO_RESPONSE: -3}
          REPO_BODY=${REPO_RESPONSE%???}
          
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "âŒ éªŒè¯ä»“åº“æƒé™å¤±è´¥ï¼ˆHTTP $HTTP_CODEï¼‰"
            echo "å“åº”å†…å®¹: $REPO_BODY"
            exit 1
          fi
          
          # æ£€æŸ¥ç›®æ ‡ä»“åº“æ˜¯å¦åœ¨æˆæƒåˆ—è¡¨ä¸­
          if ! echo "$REPO_BODY" | jq -r '.repositories[].name' | grep -q "$TARGET_REPO"; then
            echo "âŒ ç›®æ ‡ä»“åº“$TARGET_REPOæœªæ·»åŠ åˆ°Appæˆæƒåˆ—è¡¨"
            echo "è¯·åœ¨GitHubè®¾ç½®ä¸­æ·»åŠ ä»“åº“ï¼šhttps://github.com/settings/installations/$INSTALLATION_ID"
            exit 1
          fi
          echo "âœ… ç›®æ ‡ä»“åº“è®¿é—®æƒé™éªŒè¯é€šè¿‡"

          # è¾“å‡ºä»¤ç‰Œåˆ°ç¯å¢ƒå˜é‡
          echo "ACCESS_TOKEN=$ACCESS_TOKEN" >> "$GITHUB_ENV"
          rm -f "$TMP_KEY"

      - name: æäº¤åŒæ­¥ç»“æœ
        run: |
          git config --global user.name "Sync Bot"
          git config --global user.email "bot@example.com"
          git remote set-url origin "https://x-access-token:${{ env.ACCESS_TOKEN }}@github.com/jkl66678/openwrt-custom-builder.git"
          
          # ä»…åœ¨æœ‰å˜æ›´æ—¶æäº¤
          git add device-drivers.json .github/workflows/build.yml sync-logs/
          if ! git diff --cached --quiet; then
            git commit -m "è‡ªåŠ¨åŒæ­¥è®¾å¤‡åˆ—è¡¨ï¼ˆ$(date +%Y-%m-%d)ï¼‰"
            git push origin main --force-with-lease  # å®‰å…¨å¼ºåˆ¶æ¨é€ï¼ˆé¿å…è¦†ç›–ï¼‰
            echo "âœ… æäº¤æ›´æ–°æˆåŠŸ"
          else
            echo "â„¹ï¸ æ— å˜æ›´ï¼Œæ— éœ€æäº¤"
          fi

      - name: ä¸Šä¼ åŒæ­¥æ—¥å¿—
        if: always()  # æ— è®ºæˆåŠŸå¤±è´¥éƒ½ä¸Šä¼ æ—¥å¿—
        uses: actions/upload-artifact@v4
        with:
          name: sync-logs-${{ github.run_id }}
          path: sync-logs/
          retention-days: 14  # æ—¥å¿—ä¿ç•™14å¤©
