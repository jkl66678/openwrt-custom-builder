name: 设备数据与工作流同步

on:
  # 手动触发同步
  workflow_dispatch:
  # 定时自动同步（每天凌晨3点）
  schedule:
    - cron: '0 3 * * *'

# 全局环境变量（确保所有步骤使用UTF-8编码）
env:
  LC_ALL: en_US.UTF-8
  LANG: en_US.UTF-8
  LANGUAGE: en_US.UTF-8
  TZ: Asia/Shanghai  # 统一时区，避免日志时间混乱

jobs:
  sync-and-generate:
    name: 同步设备信息并生成工作流
    runs-on: ubuntu-22.04
    timeout-minutes: 240  # 充足的超时时间（适应大仓库克隆和驱动提取）

    steps:
      - name: 拉取代码仓库
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          lfs: true
          # 确保中文文件名正常处理
          path: ./openwrt-custom-builder

      - name: 进入工作目录
        run: |
          cd openwrt-custom-builder
          pwd  # 验证工作目录

      - name: 安装系统依赖（含中文支持）
        run: |
          cd openwrt-custom-builder
          # 更新包列表并安装基础工具
          sudo apt update -y
          sudo apt install -y \
            build-essential git jq grep sed awk file gcc g++ \
            iconv dos2unix curl wget zip unzip \
            golang snapd locales  # 新增本地化支持包

          # 配置UTF-8 locale（彻底解决中文编码问题）
          sudo locale-gen en_US.UTF-8
          sudo update-locale LC_ALL=en_US.UTF-8 LANG=en_US.UTF-8

          # 安装yamlfmt（YAML格式化工具）
          go install github.com/google/yamlfmt/cmd/yamlfmt@latest
          echo "$HOME/go/bin" >> $GITHUB_PATH

          # 安装yq（YAML处理工具）
          sudo snap install yq

          # 验证工具安装
          echo "验证关键工具版本："
          jq --version
          yq --version
          yamlfmt --version
          git --version

      - name: 准备脚本文件（处理编码和权限）
        run: |
          cd openwrt-custom-builder
          # 确保脚本目录存在
          mkdir -p scripts sync-logs configs

          # 赋予执行权限
          chmod +x scripts/*.sh

          # 强制转换为Unix换行符（避免Windows格式导致的脚本错误）
          dos2unix scripts/sync-devices.sh
          dos2unix scripts/generate-workflow.sh

          # 验证文件编码（确保为UTF-8）
          file -i scripts/sync-devices.sh
          file -i scripts/generate-workflow.sh

      - name: 执行设备数据同步（含驱动提取）
        run: |
          cd openwrt-custom-builder
          # 执行同步脚本，输出详细日志
          ./scripts/sync-devices.sh | tee sync-logs/sync-$(date +%Y%m%d).log
        # 传递环境变量确保中文正常
        env:
          LC_ALL: en_US.UTF-8
          LANG: en_US.UTF-8

      - name: 生成编译工作流文件
        run: |
          cd openwrt-custom-builder
          # 生成工作流，输出详细日志
          ./scripts/generate-workflow.sh | tee sync-logs/workflow-$(date +%Y%m%d).log

      - name: 验证同步结果（防乱码和完整性）
        run: |
          cd openwrt-custom-builder
          # 检查核心文件存在性
          if [ ! -f ".github/workflows/build.yml" ]; then
            echo "❌ 工作流文件未生成"
            exit 1
          fi
          if [ ! -s "device-drivers.json" ]; then
            echo "❌ 设备驱动JSON文件为空或不存在"
            exit 1
          fi
          if [ ! -s "sync-logs/source_branches.tmp" ]; then
            echo "❌ 源码分支文件为空或不存在"
            exit 1
          fi

          # 验证中文内容是否正常（通过grep检查设备名中的中文字符）
          if ! grep -qE '[一-龥]' "device-drivers.json"; then
            echo "⚠️ 设备JSON中未检测到中文字符，可能存在编码问题"
            # 此处不退出，仅警告（部分设备可能无中文名称）
          fi

          # 验证JSON和YAML格式合法性
          jq . "device-drivers.json" > /dev/null || {
            echo "❌ 设备JSON格式错误"
            exit 1
          }
          yq eval '.' ".github/workflows/build.yml" > /dev/null || {
            echo "❌ 工作流YAML格式错误"
            exit 1
          }

      - name: 提交同步结果
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          repository: ./openwrt-custom-builder  # 指定仓库路径
          commit_message: "自动同步设备数据与工作流（${{ github.sha }}）"
          file_pattern: |
            .github/workflows/build.yml
            device-drivers.json
            sync-logs/*.log
            sync-logs/source_branches.tmp
            configs/*.json
          commit_user_name: "同步机器人"
          commit_user_email: "sync-bot@example.com"
          # 确保中文文件名正确提交
          encoding: "utf-8"

      - name: 上传同步日志（便于调试）
        uses: actions/upload-artifact@v4
        with:
          name: sync-logs-${{ github.run_id }}
          path: openwrt-custom-builder/sync-logs/*.log
          retention-days: 7  # 日志保留7天
